{% extends "replays/profile_base.html" %}
{% load humanize %}
{% load static %}

{% block title %}Статистика - {{ user.username }}{% endblock %}

{% block tab_content %}
<div class="relative">
  <div class="space-y-6 {% if not can_use_stats %}pointer-events-none select-none blur-[2px] opacity-80{% endif %}">
    <section class="rounded-xl p-6 border border-gray-700 bg-gray-900/50">
      <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
        <i class="fas fa-upload text-gray-400"></i>
        Загрузка реплеев для статистики
      </h2>
      <p class="text-sm text-gray-400 mb-4">
        Файлы читаются только в памяти. В базу попадают только основные параметры боя, без сохранения файла и payload.
      </p>

      <form id="stats-upload-form" class="space-y-3" data-upload-url="{% url 'profile_stats_upload' %}">
        {% csrf_token %}
        <div id="stats-drop-zone"
             class="rounded-lg border-2 border-dashed border-gray-600 p-6 text-center cursor-pointer hover:border-red-500/70 transition-colors">
          <input id="stats-files-input" type="file" name="files" multiple accept=".mtreplay" class="hidden">
          <p class="text-gray-300">Перетащите `.mtreplay` сюда или нажмите для выбора</p>
          <p class="text-xs text-gray-500 mt-1">Технический лимит: до 20 файлов за запрос</p>
        </div>

        <div id="stats-selected-files" class="hidden rounded-lg border border-gray-700 bg-dark-800/60 p-3">
          <p class="text-sm text-gray-300 mb-2">Выбрано файлов: <span id="stats-files-count">0</span></p>
          <ul id="stats-files-list" class="max-h-36 overflow-auto space-y-1 text-xs text-gray-400"></ul>
        </div>

        <div class="flex items-center gap-3">
          <button id="stats-upload-btn"
                  type="submit"
                  class="px-5 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg font-medium transition-colors">
            Загрузить в статистику
          </button>
          <span id="stats-upload-status" class="text-sm text-gray-400"></span>
        </div>
      </form>

      <div id="stats-upload-summary" class="hidden mt-4 rounded-lg border border-gray-700 bg-dark-800/60 p-3">
        <p class="text-sm text-white mb-2">Результат загрузки</p>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-sm">
          <div class="rounded bg-dark-700 p-2 text-gray-300">Обработано: <span id="sum-processed" class="text-white">0</span></div>
          <div class="rounded bg-dark-700 p-2 text-green-300">Создано: <span id="sum-created" class="text-white">0</span></div>
          <div class="rounded bg-dark-700 p-2 text-amber-300">Дубликаты: <span id="sum-duplicates" class="text-white">0</span></div>
          <div class="rounded bg-dark-700 p-2 text-red-300">Ошибки: <span id="sum-errors" class="text-white">0</span></div>
        </div>
        <ul id="stats-upload-results" class="mt-3 max-h-44 overflow-auto space-y-1 text-xs text-gray-300"></ul>
      </div>
    </section>

    <section class="rounded-xl p-6 border border-gray-700 bg-gray-900/50">
      <form method="get" class="mb-4 flex flex-wrap items-end gap-3">
        <div>
          <label for="date-from" class="block text-xs text-gray-400 mb-1">Дата с</label>
          <input id="date-from" type="date" name="date_from" value="{{ date_from }}"
                 class="bg-dark-800 border border-gray-600 rounded px-2 py-1 text-white text-sm">
        </div>
        <div>
          <label for="date-to" class="block text-xs text-gray-400 mb-1">Дата по</label>
          <input id="date-to" type="date" name="date_to" value="{{ date_to }}"
                 class="bg-dark-800 border border-gray-600 rounded px-2 py-1 text-white text-sm">
        </div>
        <button type="submit"
                class="px-3 py-2 text-sm bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition-colors">
          Применить период
        </button>
        <a href="{% url 'profile_stats' %}"
           class="px-3 py-2 text-sm bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors">
          Сброс
        </a>
      </form>

      <div class="flex items-center justify-between mb-4 gap-3 flex-wrap" id="stats-export-actions" data-export-url="{{ export_url }}">
        <h2 class="text-lg font-semibold text-white flex items-center gap-2">
          <i class="fas fa-table text-gray-400"></i>
          Бои в статистике
          <span class="text-xs font-normal text-gray-500">({{ page_obj.paginator.count }})</span>
        </h2>
        <div class="flex items-center gap-2 flex-wrap">
          <span id="stats-selected-counter" class="text-xs text-gray-400 hidden">Выбрано: <span id="stats-selected-count">0</span></span>
          <button id="stats-export-selected-btn"
                  type="button"
                  disabled
                  class="px-3 py-2 text-sm bg-emerald-700/80 text-gray-300 rounded-lg cursor-not-allowed transition-colors disabled:opacity-60">
            <i class="fas fa-file-export mr-1"></i> Экспорт выбранных
          </button>
          <a href="{{ export_url }}"
             class="px-3 py-2 text-sm bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg transition-colors">
            <i class="fas fa-file-export mr-1"></i> Экспорт всех
          </a>
          <form method="get" class="flex items-center gap-2 text-sm">
            <input type="hidden" name="sort" value="{{ current_sort }}">
            <input type="hidden" name="dir" value="{{ current_dir }}">
            <label for="per-page" class="text-gray-400">На странице:</label>
            <select id="per-page" name="per_page" class="bg-dark-800 border border-gray-600 rounded px-2 py-1 text-white"
                    onchange="this.form.submit()">
              {% for size in allowed_page_sizes %}
                <option value="{{ size }}" {% if current_per_page == size %}selected{% endif %}>{{ size }}</option>
              {% endfor %}
            </select>
          </form>
        </div>
      </div>

      <div class="overflow-auto rounded-xl border border-gray-700/80 bg-gradient-to-b from-gray-900/70 to-gray-900/40">
        <table class="min-w-full text-sm">
          <thead class="text-gray-300 border-b border-gray-700 bg-gray-900/80">
          <tr>
            <th class="py-2 px-3 w-10">
              <input id="stats-select-all"
                     type="checkbox"
                     class="rounded border-gray-500 bg-dark-800 text-red-500 focus:ring-red-500/40">
            </th>
            <th class="text-left py-2 pr-4 min-w-[170px]">
              <a href="?{{ page_qs_prefix }}sort=battle_date&dir={{ next_dir.battle_date }}" class="hover:text-white">
                Дата {% if current_sort == 'battle_date' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
                </a>
              </th>
              <th class="text-left py-2 pr-4">
                <a href="?{{ page_qs_prefix }}sort=map_display_name&dir={{ next_dir.map_display_name }}" class="hover:text-white">
                  Карта {% if current_sort == 'map_display_name' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
                </a>
              </th>
              <th class="text-left py-2 pr-4">
                <a href="?{{ page_qs_prefix }}sort=outcome&dir={{ next_dir.outcome }}" class="hover:text-white">
                  Результат {% if current_sort == 'outcome' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
                </a>
              </th>
              <th class="text-right py-2 pr-4">
                <a href="?{{ page_qs_prefix }}sort=players_count&dir={{ next_dir.players_count }}" class="hover:text-white">
                  Союзники {% if current_sort == 'players_count' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
                </a>
              </th>
              <th class="text-right py-2 pr-4 min-w-[150px]">
                <a href="?{{ page_qs_prefix }}sort=total_damage&dir={{ next_dir.total_damage }}" class="hover:text-white">
                  Сумма урона {% if current_sort == 'total_damage' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
                </a>
              </th>
              <th class="text-right py-2 min-w-[130px]">
                <a href="?{{ page_qs_prefix }}sort=avg_damage&dir={{ next_dir.avg_damage }}" class="hover:text-white">
                  Ср. урон {% if current_sort == 'avg_damage' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
                </a>
              </th>
          </tr>
        </thead>
        <tbody>
          {% for row in items %}
            <tr class="border-b border-gray-800 text-gray-200 hover:bg-white/5 transition-colors">
              <td class="py-2 px-3 align-middle">
                <input type="checkbox"
                       class="stats-battle-checkbox rounded border-gray-500 bg-dark-800 text-red-500 focus:ring-red-500/40"
                       value="{{ row.battle_signature }}">
              </td>
              <td class="py-2 pr-4 whitespace-nowrap font-medium text-gray-100">{{ row.battle_date|date:"d.m.Y H:i" }}</td>
              <td class="py-2 pr-4">{{ row.map_display_name|default:row.map_name|default:"—" }}</td>
              <td class="py-2 pr-4">
                {% if row.outcome == 'win' %}
                  <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-semibold bg-green-500/15 text-green-300 border border-green-500/20">Победа</span>
                {% elif row.outcome == 'loss' %}
                  <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-semibold bg-red-500/15 text-red-300 border border-red-500/20">Поражение</span>
                {% else %}
                  <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-semibold bg-amber-500/15 text-amber-300 border border-amber-500/20">Ничья</span>
                {% endif %}
              </td>
              <td class="py-2 pr-4 text-right tabular-nums">{{ row.players_count }}</td>
              <td class="py-2 pr-4 text-right tabular-nums font-medium">{{ row.total_damage|intcomma }}</td>
              <td class="py-2 text-right tabular-nums">{{ row.avg_damage|intcomma }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="py-8 text-center text-gray-500">
                Пока нет статистических записей. Загрузите один или несколько `.mtreplay`.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if page_obj and page_obj.has_other_pages %}
        <nav class="mt-4 flex items-center gap-3 flex-wrap">
          {% if page_obj.has_previous %}
            <a class="page-btn" href="?{{ page_qs_prefix }}page={{ page_obj.previous_page_number }}">&laquo; Назад</a>
          {% endif %}
          <span class="page-state">Стр. {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}</span>
          {% if page_obj.has_next %}
            <a class="page-btn" href="?{{ page_qs_prefix }}page={{ page_obj.next_page_number }}">Вперёд &raquo;</a>
          {% endif %}
        </nav>
      {% endif %}
    </section>
  </div>

  {% if not can_use_stats %}
    <div class="absolute inset-0 z-10 flex items-center justify-center rounded-xl" style="background: rgba(15, 15, 20, 0.45); backdrop-filter: blur(1px);">
      <div class="text-center max-w-md px-4">
        <i class="fas fa-lock text-amber-400 text-3xl mb-3"></i>
        <p class="text-sm text-gray-300 mb-3">
          Раздел статистики доступен только для подписчиков <strong class="text-amber-400">ПРО</strong>.
        </p>
        <a href="{% url 'subscription_info' %}" class="inline-block px-4 py-2 rounded-lg text-sm font-semibold bg-gradient-to-r from-amber-500 to-amber-600 text-white hover:from-amber-400 hover:to-amber-500 transition-all">
          Оформить ПРО
        </a>
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  {% if can_use_stats %}
    <script src="{% static 'js/profile-stats-upload.js' %}?v=1"></script>
    <script>
      (function() {
        var selectAll = document.getElementById("stats-select-all");
        var rowCheckboxes = Array.from(document.querySelectorAll(".stats-battle-checkbox"));
        var selectedBtn = document.getElementById("stats-export-selected-btn");
        var selectedCounter = document.getElementById("stats-selected-counter");
        var selectedCount = document.getElementById("stats-selected-count");
        var exportActions = document.getElementById("stats-export-actions");
        if (!selectAll || !selectedBtn || !exportActions || rowCheckboxes.length === 0) {
          return;
        }

        var baseExportUrl = exportActions.getAttribute("data-export-url") || "";

        function getSelectedValues() {
          return rowCheckboxes.filter(function(cb) { return cb.checked; }).map(function(cb) { return cb.value; });
        }

        function syncSelectAllState() {
          var selected = getSelectedValues();
          var allChecked = selected.length > 0 && selected.length === rowCheckboxes.length;
          selectAll.checked = allChecked;
          selectAll.indeterminate = selected.length > 0 && selected.length < rowCheckboxes.length;
        }

        function updateSelectedState() {
          var selected = getSelectedValues();
          var enabled = selected.length > 0;
          selectedBtn.disabled = !enabled;
          selectedBtn.classList.toggle("cursor-not-allowed", !enabled);
          selectedBtn.classList.toggle("bg-emerald-700/80", !enabled);
          selectedBtn.classList.toggle("text-gray-300", !enabled);
          selectedBtn.classList.toggle("bg-emerald-600", enabled);
          selectedBtn.classList.toggle("hover:bg-emerald-500", enabled);
          selectedBtn.classList.toggle("text-white", enabled);
          selectedCounter.classList.toggle("hidden", !enabled);
          selectedCount.textContent = String(selected.length);
          syncSelectAllState();
        }

        selectAll.addEventListener("change", function() {
          rowCheckboxes.forEach(function(cb) { cb.checked = selectAll.checked; });
          updateSelectedState();
        });

        rowCheckboxes.forEach(function(cb) {
          cb.addEventListener("change", updateSelectedState);
        });

        selectedBtn.addEventListener("click", function() {
          var selected = getSelectedValues();
          if (!selected.length || !baseExportUrl) {
            return;
          }

          var exportUrl = new URL(baseExportUrl, window.location.origin);
          selected.forEach(function(signature) {
            exportUrl.searchParams.append("battle_signature", signature);
          });

          window.location.href = exportUrl.pathname + exportUrl.search;
        });

        updateSelectedState();
      })();
    </script>
  {% endif %}
{% endblock %}
