{# replays/templates/replays/my_replays.html #}
{% extends "base.html" %}
{% load tz %}
{% block body_class %}replays index{% endblock %}

{% block content %}
    {% load static humanize %}
    <link rel="stylesheet" href="{% static 'css/wot_record_skin.css' %}">

    <h1>{{ page_title }}</h1>

    <div class="filters-actions"
         style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px;">

      <!-- СОРТИРОВКИ (слева) -->
      <div class="sorters" style="display:flex; gap:8px; flex-wrap:wrap;">
        {# Урон #}
        <a class="btn btn--ghost {% if current_sort == 'damage' %}active{% endif %}"
           href="?{{ page_qs_prefix }}sort=damage&dir={{ next_dir.damage }}"
           title="Сортировать по урону">
          <img src="{% static 'style/images/wot/library/BattleResultIcon-1.png' %}" alt="Damage" style="height:16px;vertical-align:-3px;">
          Урон
          {% if current_sort == 'damage' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
        </a>

        {# Кредиты #}
        <a class="btn btn--ghost {% if current_sort == 'credits' %}active{% endif %}"
           href="?{{ page_qs_prefix }}sort=credits&dir={{ next_dir.credits }}"
           title="Сортировать по кредитам">
          <img src="{% static 'style/images/wot/library/CreditsIconBig.png' %}" alt="Credits" style="height:16px;vertical-align:-3px;">
          Кредиты
          {% if current_sort == 'credits' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
        </a>

        {# Опыт #}
        <a class="btn btn--ghost {% if current_sort == 'xp' %}active{% endif %}"
           href="?{{ page_qs_prefix }}sort=xp&dir={{ next_dir.xp }}"
           title="Сортировать по опыту">
          <img src="{% static 'style/images/wot/library/XpIconBig.png' %}" alt="XP" style="height:16px;vertical-align:-3px;">
          Опыт
          {% if current_sort == 'xp' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
        </a>

        {# Фраги #}
        <a class="btn btn--ghost {% if current_sort == 'kills' %}active{% endif %}"
           href="?{{ page_qs_prefix }}sort=kills&dir={{ next_dir.kills }}"
           title="Сортировать по фрагам">
          <img src="{% static 'style/images/wot/buttons/Tank-ico.png' %}" alt="Kills" style="height:16px;vertical-align:-3px;">
          Фраги
          {% if current_sort == 'kills' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
        </a>

        {# Ассист #}
        <a class="btn btn--ghost {% if current_sort == 'assist' %}active{% endif %}"
           href="?{{ page_qs_prefix }}sort=assist&dir={{ next_dir.assist }}"
           title="Сортировать по ассисту">
          <img src="{% static 'style/images/wot/buttons/assist.png' %}" alt="Assist" style="height:16px;vertical-align:-3px;">
          Ассист
          {% if current_sort == 'assist' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
        </a>

        {# Заблокировано бронёй #}
        <a class="btn btn--ghost {% if current_sort == 'block' %}active{% endif %}"
           href="?{{ page_qs_prefix }}sort=block&dir={{ next_dir.block }}"
           title="Сортировать по заблокированному урону">
          <img src="{% static 'style/images/wot/buttons/blocked.png' %}" alt="Blocked" style="height:16px;vertical-align:-3px;">
          Блок
          {% if current_sort == 'block' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
        </a>
      </div>

      <!-- КНОПКИ ФИЛЬТРОВ (справа) -->
      <div style="display:flex; gap:10px;">
        <a class="btn btn--accent" href="{{ filters_url }}">Фильтры</a>
        {% if has_filters_applied %}
          <a class="btn btn--ghost" href="{{ reset_url }}">Сбросить</a>
        {% endif %}
      </div>
    </div>

    <main class="replay-grid replay-grid--rows">
        {% if items %}
            {% for replay in items %}
            <div style="position: relative;">
                <a class="tovabb"
                    href="{% url 'replay_detail' replay.id %}?back={{ request.get_full_path|urlencode }}"
                    title="{{ replay.tank.name|default:'Неизвестный танк' }} - {{ replay.map.map_display_name|default:replay.map_name|default:'Неизвестная карта' }}">
                    <div class="wrapper">

                        <div class="img-container">
                            <!-- КАРТА -->
                            {% if replay.map %}
                                <img class="map"
                                     src="{% static 'style/images/wot/map/stats/' %}{{ replay.map.map_name }}.png"
                                     alt="{{ replay.map.map_display_name|default:replay.map.map_name }}"/>
                            {% else %}
                                <img class="map"
                                     src="{% static 'maps/map_placeholder.jpg' %}"
                                     alt="Неизвестная карта"/>
                            {% endif %}

                            <!-- ТАНК -->
                            {% if replay.tank %}
                                <img class="tank"
                                     src="{% static 'style/images/wot/shop/vehicles/180x135/' %}{{ replay.tank.vehicleId }}.png"
                                     alt="{{ replay.tank.name }}"/>
                            {% endif %}

                            <span class="map-name">{{ replay.map.map_display_name|default:replay.map_name|default:'Неизвестная карта' }}</span>
                            <span class="name">{{ replay.tank.name|default:'Неизвестный танк' }}</span>

                            <!-- Убираю battleType пока нет этого поля в модели -->
                        </div>

                        <div class="details">
                            <div class="title">{{ replay.tank.name|default:'Неизвестный танк' }}
                                - {{ replay.map.map_display_name|default:replay.map_name|default:'Неизвестная карта' }}
                            </div>

                            <div class="table">

                                <div class="upload-info">
                                    {{ replay.battle_date|default_if_none:replay.created_at|localtime|date:"d.m.Y H:i" }}
                                </div>

                                <div class="description">{{ replay.short_description }}</div>

                            </div>

                            <div class="table">
                                {% if replay.mastery %}
                                    <div class="cell">
                                        <img class="mastery"
                                             src="{% static 'style/images/wot/library/proficiency/class_icons_' %}{{ replay.mastery }}.png"
                                             alt="Mastery {{ replay.mastery }}"/>
                                    </div>
                                {% endif %}

                                {% if replay.tank.type %}
                                    <div class="cell">
                                        <img class="type"
                                             src="{% static 'style/images/wot/vehicleTypes/' %}{{ replay.tank.type }}.png"
                                             alt="Vehicle type"/>
                                    </div>
                                {% endif %}

                                {% if replay.tank.level %}
                                    <div class="cell">
                                        <img class="level"
                                             src="{% static 'style/images/wot/levels/tank_level_' %}{{ replay.tank.level }}.png"
                                             alt="Level {{ replay.tank.level }}"/>
                                    </div>
                                {% endif %}
                            </div>

                            <div class="table">
                                <!-- Статистика из модели -->
                                <div class="cell">
                                    <img src="{% static 'style/images/wot/library/CreditsIconBig.png' %}"
                                         alt="Credits"/>
                                    <span>{{ replay.credits|intcomma }}</span>
                                </div>
                                <div class="cell">
                                    <img src="{% static 'style/images/wot/library/XpIconBig.png' %}" alt="XP"/>
                                    <span>{{ replay.xp|intcomma }}</span>
                                </div>
                                <div class="cell">
                                    <img src="{% static 'style/images/wot/buttons/Tank-ico.png' %}" alt="Kills"/>
                                    <span>{{ replay.kills }}</span>
                                </div>
                                <div class="cell">
                                    <img src="{% static 'style/images/wot/library/BattleResultIcon-1.png' %}"
                                         alt="Damage"/>
                                    <span>{{ replay.damage|intcomma }}</span>
                                </div>
                                <div class="cell">
                                    <img src="{% static 'style/images/wot/buttons/assist.png' %}" alt="Assist"/>
                                    <span>{{ replay.assist|intcomma }}</span>
                                </div>
                                <div class="cell">
                                    <img src="{% static 'style/images/wot/buttons/blocked.png' %}" alt="Blocked"/>
                                    <span>{{ replay.block|intcomma }}</span>
                                </div>
                            </div>

                        </div>

                    </div>
                </a>
                <div style="position: absolute; top: 15px; right: 15px; z-index: 1;">
                    <form action="{% url 'replay_delete' replay.id %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Вы уверены, что хотите удалить этот реплей?');">
                            Удалить
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p class="empty">Вы еще не загрузили ни одного реплея.</p>
        {% endif %}
    </main>

    <!-- Пагинация -->
    {% if is_paginated %}
      <div class="pagination">
        <span class="pagination-links">
          {% if page_obj.has_previous %}
            <a class="pagination-link" href="?{{ page_qs_prefix }}page=1">&laquo;&laquo; Первая</a>
            <a class="pagination-link" href="?{{ page_qs_prefix }}page={{ page_obj.previous_page_number }}">&laquo; Назад</a>
          {% endif %}

          <span class="current-page">
            Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}
          </span>

          {% if page_obj.has_next %}
            <a class="pagination-link" href="?{{ page_qs_prefix }}page={{ page_obj.next_page_number }}">Вперед &raquo;</a>
            <a class="pagination-link" href="?{{ page_qs_prefix }}page={{ page_obj.paginator.num_pages }}">Последняя &raquo;&raquo;</a>
          {% endif %}
        </span>

        <span class="pagination-info">
          Показаны {{ page_obj.start_index }}–{{ page_obj.end_index }} из {{ page_obj.paginator.count }} реплеев
        </span>
      </div>
    {% endif %}


{% endblock %}