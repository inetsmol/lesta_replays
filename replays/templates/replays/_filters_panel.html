{# replays/templates/replays/includes/_filters_panel.html #}
{% load static %}

<div class="container mb-12" id="filters-container">

    {# Кнопка показа/скрытия фильтров #}
    <div class="filters-actions" style="justify-content:flex-end;">
        <input type="button"
               id="replay-filter-button"
               class="btn btn--accent replay-filter-button right"
               value="Фильтр"
               style="margin-left:15px;">
    </div>

    {# Панель фильтров (по умолчанию скрыта, если нет активных фильтров) #}
    {% with has_active=current_filters %}
        <section id="filters-panel"
                 class="card filters-card mt-12"
                 style="display:{% if has_active %}block{% else %}none{% endif %};">

            <form class="form" method="get" action="">

                {# Быстрые поля #}
                <div class="form-row grid-3">
                  <div class="field">
                    <label for="map_search">Карта</label>
                    <input type="search" id="map_search" name="map_search"
                           placeholder="Название карты"
                           value="{{ current_filters.map_search.0|default_if_none:'' }}">
                  </div>
                  <div class="field">
                    <label for="date_from">Дата боя — с</label>
                    <input type="date" id="date_from" name="date_from"
                           value="{{ current_filters.date_from.0|default_if_none:'' }}">
                  </div>
                  <div class="field">
                    <label for="date_to">Дата боя — по</label>
                    <input type="date" id="date_to" name="date_to"
                           value="{{ current_filters.date_to.0|default_if_none:'' }}">
                  </div>
                </div>

                {# Числовые диапазоны #}
                <div class="form-row grid-3">
                  <div class="field">
                    <label>Урон</label>
                    <div class="grid grid-2">
                      <input type="number" inputmode="numeric" name="damage_min" placeholder="от"
                             value="{{ current_filters.damage_min.0|default_if_none:'' }}">
                      <input type="number" inputmode="numeric" name="damage_max" placeholder="до"
                             value="{{ current_filters.damage_max.0|default_if_none:'' }}">
                    </div>
                  </div>
                  <div class="field">
                    <label>Фраги</label>
                    <div class="grid grid-2">
                      <input type="number" inputmode="numeric" name="kills_min" placeholder="от"
                             value="{{ current_filters.kills_min.0|default_if_none:'' }}">
                      <input type="number" inputmode="numeric" name="kills_max" placeholder="до"
                             value="{{ current_filters.kills_max.0|default_if_none:'' }}">
                    </div>
                  </div>
                    {% with vic=current_filters.victory.0 %}
                        <div class="field">
                            <label>Результат боя</label>
                            <div class="chips">
                                <label class="chip">
                                    <input type="radio" name="victory" value=""
                                           {% if not vic %}checked{% endif %}>
                                    Любой
                                </label>
                                <label class="chip">
                                    <input type="radio" name="victory" value="win"
                                           {% if vic == 'win' %}checked{% endif %}>
                                    Победа
                                </label>
                                <label class="chip">
                                    <input type="radio" name="victory" value="loss"
                                           {% if vic == 'loss' %}checked{% endif %}>
                                    Поражение
                                </label>
                            </div>
                        </div>
                    {% endwith %}
                </div>

                {# Победа/поражение #}
                <div class="form-row grid-3">
                    {# Версии игры #}
                    <div class="field">
                        <label>Версия игры</label>
                        {% with selected=selected.game_version|default:"" %}
                            <div class="chips">
                                {% for version in filter_data.game_versions %}
                                    <label class="chip">
                                        <input type="checkbox" name="game_version" value="{{ version }}"
                                               {% if version in selected %}checked{% endif %}>
                                        {{ version }}
                                    </label>
                                {% endfor %}
                            </div>
                        {% endwith %}
                    </div>

                    {# Режимы боя #}
                    <div class="field">
                        <label>Режим боя</label>
                        {% with selected=selected.battle_type|default:"" %}
                            <div class="chips">
                                {% for battle_type in filter_data.battle_types %}
                                    <label class="chip">
                                        <input type="checkbox" name="battle_type" value="{{ battle_type }}"
                                               {% if battle_type in selected %}checked{% endif %}>
                                        {{ battle_type }}
                                    </label>
                                {% endfor %}
                            </div>
                        {% endwith %}
                    </div>


                </div>

                <hr class="mt-8 mb-8" style="border:none;border-top:1px solid var(--border);"/>

                {# Чипы: Нации, Уровни, Типы, Мастерство #}
                <div class="form-row grid-3">
                    {# Нации #}
                    <div class="field">
                        <label>Нации</label>
                        {% with selected=current_filters.nation|default:"" %}
                            <div class="chips">
                                {% for val,label in filter_data.nations %}
                                    {% with sval=val|stringformat:"s" %}
                                        <label class="chip">
                                            <input type="checkbox" name="nation" value="{{ sval }}"
                                                   {% if sval in selected %}checked{% endif %}>
                                            {{ label }}
                                        </label>
                                    {% endwith %}
                                {% endfor %}
                            </div>
                        {% endwith %}
                    </div>

                    {# Уровни #}
                    <div class="field">
                        <label>Уровни</label>
{#                        {% with selected=current_filters.level|default:current_filters.tier|default:"" %}#}
                            <div class="chips">
                                {% for lvl in filter_data.levels %}
                                    {% with slvl=lvl|stringformat:"s" %}
                                        <label class="chip">
                                            <input type="checkbox" name="level" value="{{ slvl }}"
                                                   {% if slvl in selected %}checked{% endif %}>
                                            {{ lvl }}
                                        </label>
                                    {% endwith %}
                                {% endfor %}
                            </div>
                    </div>

                    {# Типы техники #}
                    <div class="field">
                        <label>Типы</label>
                        {% with selected=current_filters.type|default:"" %}
                            <div class="chips">
                                {% for t in filter_data.tank_types %}
                                    {% with st=t|stringformat:"s" %}
                                        <label class="chip">
                                            <input type="checkbox" name="type" value="{{ st }}"
                                                   {% if st in selected %}checked{% endif %}>
                                            {# Человекочитаемое имя типа #}
                                            {% if t == 'lightTank' %}Лёгкий танк
                                            {% elif t == 'mediumTank' %}Средний танк
                                            {% elif t == 'heavyTank' %}Тяжёлый танк
                                            {% elif t == 'AT-SPG' %}ПТ-САУ
                                            {% elif t == 'SPG' %}САУ
                                            {% else %}{{ t }}{% endif %}
                                        </label>
                                    {% endwith %}
                                {% endfor %}
                            </div>
                        {% endwith %}
                    </div>
                </div>

                {# Мастерство #}
                <div class="form-row">
                    <div class="field">
                        <label>Степени мастерства</label>
                        {% with selected=current_filters.mastery|default:"" %}
                            <div class="chips">
                                {% for val,label in filter_data.mastery_choices %}
                                    {% with sval=val|stringformat:"s" %}
                                        <label class="chip">
                                            <input type="checkbox" name="mastery" value="{{ sval }}"
                                                   {% if sval in selected %}checked{% endif %}>
                                            {% if val == 4 %}Мастер
                                            {% elif val == 3 %}1 степень
                                            {% elif val == 2 %}2 степень
                                            {% elif val == 1 %}3 степень
                                            {% else %}Без знака{% endif %}
                                        </label>
                                    {% endwith %}
                                {% endfor %}
                            </div>
                        {% endwith %}
                    </div>
                </div>

                <hr class="mt-8 mb-8" style="border:none;border-top:1px solid var(--border);"/>

                {# Список танков с поиском #}
                <div class="form-row">
                    <div class="field">
                        <label for="tank-search">Техника</label>
                        <input type="search" id="tank-search" placeholder="Поиск по названию…">
                        <div class="text-muted-sm mt-8">Количество машин: <span
                                class="tank-count">{{ filter_data.tanks|length }}</span></div>

                        {% with selected=current_filters.tank|default:"" %}
                            <div id="tank-list" class="mt-8"
                                 style="max-height:320px; overflow:auto; border:1px solid var(--border); border-radius: var(--radius-sm); padding:8px; background:var(--panel-2);">
                                {% for t in filter_data.tanks %}
                                    {% with tid=t.id|stringformat:"s" %}
                                        <label class="tank-item"
                                               data-name="{{ t.name|lower }}"
                                               data-nation="{{ t.nation }}"
                                               data-level="{{ t.level }}"
                                               data-type="{{ t.type }}"
                                               style="display:block; padding:4px 2px;">
                                            <input type="checkbox" name="tank" value="{{ tid }}"
                                                   {% if tid in selected %}checked{% endif %}>
                                            <span class="checkbox"></span> {{ t.name }}
                                        </label>
                                    {% endwith %}
                                {% endfor %}
                            </div>
                        {% endwith %}
                    </div>
                </div>

              {# Кнопки управления формой #}

                <div class="actions">
                        <input type="button"
                             class="btn btn--ghost"
                             value="Сбросить"
                             id="reset-filters-btn">
                      <input type="button"
                             class="btn btn--ghost"
                             value="Свернуть"
                             id="collapse-filters-btn">
                        <input type="submit"
                             class="btn btn--accent"
                             value="Применить">
                </div>


            </form>
        </section>
    {% endwith %}
</div>

<script>
(function () {
    // === УПРАВЛЕНИЕ ПАНЕЛЬЮ ФИЛЬТРОВ ===
    const btn = document.getElementById('replay-filter-button');
    const panel = document.getElementById('filters-panel');
    const form = panel ? panel.querySelector('form') : null;

    if (btn && panel) {
        // Переключение видимости панели
        btn.addEventListener('click', () => {
            const isHidden = getComputedStyle(panel).display === 'none';
            panel.style.display = isHidden ? 'block' : 'none';
            btn.value = isHidden ? 'Скрыть фильтр' : 'Фильтр';
        });

        // Автоматическое сворачивание при отправке формы
        if (form) {
            form.addEventListener('submit', () => {
                // Даём форме отправиться, затем сворачиваем
                setTimeout(() => {
                    panel.style.display = 'none';
                    btn.value = 'Фильтр';
                }, 100);
            });
        }
    }

    // Кнопка "Свернуть" (если есть)
    const collapseBtn = document.getElementById('collapse-filters-btn');
    if (collapseBtn && panel && btn) {
        collapseBtn.addEventListener('click', () => {
            panel.style.display = 'none';
            btn.value = 'Фильтр';
        });
    }

    // === ПОИСК ПО СПИСКУ ТАНКОВ ===
    const search = document.getElementById('tank-search');
    const list = document.getElementById('tank-list');
    const count = document.querySelector('.tank-count');

    if (search && list) {
        const items = Array.from(list.querySelectorAll('.tank-item'));

        const updateTankList = () => {
            const q = search.value.trim().toLowerCase();
            let visible = 0;

            items.forEach(item => {
                const name = item.dataset.name || '';
                const isVisible = !q || name.toLowerCase().includes(q);
                item.style.display = isVisible ? 'block' : 'none';
                if (isVisible) visible++;
            });

            if (count) {
                count.textContent = visible.toString();
            }
        };

        search.addEventListener('input', updateTankList);

        // Инициализация при загрузке страницы
        updateTankList();
    }

    // === ДОПОЛНИТЕЛЬНЫЕ КНОПКИ УПРАВЛЕНИЯ (если есть) ===

    // Кнопка "Сбросить все фильтры"
    const resetBtn = document.getElementById('reset-filters-btn');
    if (resetBtn) {
        resetBtn.addEventListener('click', () => {
            // Переходим на чистую страницу без параметров
            window.location.href = window.location.pathname;
        });
    }

    // Кнопка "Выбрать все" для чекбоксов (универсальная)
    document.addEventListener('click', (e) => {
        if (e.target.matches('.select-all-btn')) {
            const fieldset = e.target.closest('.field');
            if (fieldset) {
                const checkboxes = fieldset.querySelectorAll('input[type="checkbox"]');
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                checkboxes.forEach(cb => cb.checked = !allChecked);
            }
        }
    });

})();
</script>