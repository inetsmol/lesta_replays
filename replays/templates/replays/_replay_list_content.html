{% load static humanize custom_comments_tags tz comments webp_tags %}

    <div class="filters-actions mb-3" x-data="{ expanded: false }">
      <div class="flex items-start justify-between gap-2 mb-2 w-full">
        <!-- СОРТИРОВКИ ПЕРВЫЙ РЯД (слева) -->
        <div class="flex items-start gap-2">
          <div class="sorters grid grid-cols-5 gap-2">
            {# Урон #}
            <a class="btn btn--ghost {% if current_sort == 'damage' %}active{% endif %}"
               href="?{{ page_qs_prefix }}sort=damage&dir={{ next_dir.damage }}"
               title="Сортировать по урону">
              {% webp_image 'style/images/wot/library/BattleResultIcon-1.png' 'Damage' class='inline-block h-4 -translate-y-[3px]' %}
              Урон
              {% if current_sort == 'damage' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
            </a>

            {# Кредиты #}
            <a class="btn btn--ghost {% if current_sort == 'credits' %}active{% endif %}"
               href="?{{ page_qs_prefix }}sort=credits&dir={{ next_dir.credits }}"
               title="Сортировать по кредитам">
              {% webp_image 'style/images/wot/library/CreditsIconBig.png' 'Credits' class='inline-block h-4 -translate-y-[3px]' %}
              Кредиты
              {% if current_sort == 'credits' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
            </a>

            {# Опыт #}
            <a class="btn btn--ghost {% if current_sort == 'xp' %}active{% endif %}"
               href="?{{ page_qs_prefix }}sort=xp&dir={{ next_dir.xp }}"
               title="Сортировать по опыту">
              {% webp_image 'style/images/wot/library/XpIconBig.png' 'XP' class='inline-block h-4 -translate-y-[3px]' %}
              Опыт
              {% if current_sort == 'xp' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
            </a>

            {# Фраги #}
            <a class="btn btn--ghost {% if current_sort == 'kills' %}active{% endif %}"
               href="?{{ page_qs_prefix }}sort=kills&dir={{ next_dir.kills }}"
               title="Сортировать по фрагам">
              {% webp_image 'style/images/wot/buttons/Tank-ico.png' 'Kills' class='inline-block h-4 -translate-y-[3px]' %}
              Фраги
              {% if current_sort == 'kills' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
            </a>

            {# Ассист #}
            <a class="btn btn--ghost {% if current_sort == 'assist' %}active{% endif %}"
               href="?{{ page_qs_prefix }}sort=assist&dir={{ next_dir.assist }}"
               title="Сортировать по ассисту">
              {% webp_image 'style/images/wot/buttons/assist.png' 'Assist' class='inline-block h-4 -translate-y-[3px]' %}
              Ассист
              {% if current_sort == 'assist' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
            </a>
          </div>

          <!-- КНОПКА ЕЩЁ (слева вместе с сортировками) -->
          <button @click="expanded = !expanded" class="btn btn--ghost" type="button">
            <span x-text="expanded ? 'Скрыть' : 'Ещё'"></span>
            <i class="fas fa-chevron-down text-xs transition-transform duration-200" :class="expanded && 'rotate-180'"></i>
          </button>
        </div>

        <!-- КНОПКИ ФИЛЬТРОВ (справа) -->
        <div class="flex gap-2.5 flex-shrink-0">
          <a class="btn btn--ghost" href="{{ filters_url }}">
            <i class="fas fa-filter text-red-600"></i>
            Фильтры
          </a>
          {% if has_filters_applied %}
            <a class="btn btn--ghost" href="{{ reset_url }}">Сбросить</a>
          {% endif %}
        </div>
      </div>

      {% if default_gameplay_applied %}
      <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-blue-500/10 border border-blue-500/20 text-sm text-blue-300">
        <i class="fas fa-info-circle"></i>
        <span>Показан только <strong>Стандартный бой</strong></span>
        <a href="?{{ page_qs_prefix }}gameplay=all" class="ml-1 text-blue-400 hover:text-blue-300 underline">Показать все режимы</a>
      </div>
      {% endif %}

      <!-- СОРТИРОВКИ ВТОРОЙ РЯД (раскрывающийся) -->
      <div x-show="expanded"
           x-collapse
           class="sorters grid grid-cols-5 gap-2">
        {# Заблокировано бронёй #}
        <a class="btn btn--ghost {% if current_sort == 'block' %}active{% endif %}"
           href="?{{ page_qs_prefix }}sort=block&dir={{ next_dir.block }}"
           title="Сортировать по заблокированному урону">
          {% webp_image 'style/images/wot/buttons/blocked.png' 'Blocked' class='inline-block h-4 -translate-y-[3px]' %}
          Блок
          {% if current_sort == 'block' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
        </a>

        {# Дата загрузки #}
        <a class="btn btn--ghost {% if current_sort == 'created_at' %}active{% endif %}"
           href="?{{ page_qs_prefix }}sort=created_at&dir={{ next_dir.created_at }}"
           title="Сортировать по дате загрузки">
          <i class="far fa-clock inline-block text-base align-middle -translate-y-[2px]"></i>
          Дата загрузки
          {% if current_sort == 'created_at' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
        </a>

        {# Комментарии #}
        <a class="btn btn--ghost {% if current_sort == 'comment_count' %}active{% endif %}"
           href="?{{ page_qs_prefix }}sort=comment_count&dir={{ next_dir.comment_count }}"
           title="Сортировать по количеству комментариев">
          <i class="far fa-comments inline-block text-base align-middle -translate-y-[2px]"></i>
          Комментарии
          {% if current_sort == 'comment_count' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
        </a>

        {# Просмотры #}
        <a class="btn btn--ghost {% if current_sort == 'view_count' %}active{% endif %}"
           href="?{{ page_qs_prefix }}sort=view_count&dir={{ next_dir.view_count }}"
           title="Сортировать по просмотрам">
          <i class="far fa-eye inline-block text-base align-middle -translate-y-[2px]"></i>
          Просмотры
          {% if current_sort == 'view_count' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
        </a>

        {# Скачивания #}
        <a class="btn btn--ghost {% if current_sort == 'download_count' %}active{% endif %}"
           href="?{{ page_qs_prefix }}sort=download_count&dir={{ next_dir.download_count }}"
           title="Сортировать по скачиваниям">
          <i class="fas fa-download inline-block text-base align-middle -translate-y-[2px]"></i>
          Скачивания
          {% if current_sort == 'download_count' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
        </a>
      </div>
    </div>

    <main class="replay-grid replay-grid--rows">
        {% if items %}
            {% for replay in items %}
                {% if show_delete_button %}
                <div class="relative">
                {% endif %}
                    <a class="tovabb replay-card group"
                        href="{% url 'replay_detail' replay.id %}?back={{ request.get_full_path|urlencode }}"
                        title="{{ replay.tank.name|default:'Неизвестный танк' }} - {{ replay.map.map_display_name|default:replay.map_name|default:'Неизвестная карта' }}">
                        <div class="wrapper transform transition duration-200 ease-out group-hover:-translate-y-1 group-hover:scale-[1.02] group-hover:shadow-[0_18px_30px_-18px_rgba(0,0,0,0.75)] relative">

                            <!-- КНОПКА УДАЛЕНИЯ -->
                            {% if show_delete_button %}
                                <form action="{% url 'replay_delete' replay.id %}" method="post"
                                      onsubmit="return confirm('Вы уверены, что хотите удалить этот реплей?');"
                                      class="absolute top-2 right-2 z-[20]"
                                      onclick="event.stopPropagation();">
                                    {% csrf_token %}
                                    <button type="submit"
                                            class="flex items-center justify-center w-8 h-8 bg-red-600/90 hover:bg-red-700 text-white rounded-md transition-all duration-200 hover:scale-110 shadow-lg backdrop-blur-sm">
                                        <i class="fas fa-trash-alt text-sm"></i>
                                    </button>
                                </form>
                            {% endif %}

                        <div class="img-container">
                            <!-- КАРТА с WebP оптимизацией -->
                            {% if replay.map %}
                                {% webp_image 'style/images/wot/map/stats/'|add:replay.map.map_name|add:'.png' replay.map.map_display_name|default:replay.map.map_name class='map' loading='lazy' %}
                            {% else %}
                                {% webp_image 'maps/map_placeholder.jpg' 'Неизвестная карта' class='map' loading='lazy' %}
                            {% endif %}

                            <!-- ТАНК с WebP оптимизацией -->
                            {% if replay.tank %}
                                {% webp_image 'style/images/wot/shop/vehicles/180x135/'|add:replay.tank.vehicleId|add:'.png' replay.tank.name class='tank' loading='lazy' %}
                            {% endif %}

                            <span class="map-name">{{ replay.map.map_display_name|default:replay.map_name|default:'Неизвестная карта' }}</span>
                            <span class="name absolute !right-[4px] !bottom-[4px] inline-flex max-w-[160px] items-center justify-end rounded bg-black/40 px-2 py-1 text-sm font-medium text-white text-right backdrop-blur-sm shadow-[0_0_8px_rgba(0,0,0,0.8)] !left-auto !top-auto !z-[5] whitespace-nowrap">
                                {{ replay.tank.name|default:'Неизвестный танк' }}
                            </span>

                            {% if replay.tank.type or replay.tank.level %}
                                <div class="absolute right-2 top-2 flex items-center justify-end gap-1.5 z-[6]">
                                    {% if replay.tank.type %}
                                        {% webp_image 'style/images/wot/vehicleTypes/'|add:replay.tank.type|add:'.png' 'Vehicle type' class='h-[30px] w-[30px] brightness-125 contrast-125' style='filter: brightness(1.25) contrast(1.25) drop-shadow(0 0 45px rgba(0,0,0,1)) drop-shadow(0 0 28px rgba(0,0,0,0.98)) drop-shadow(0 6px 22px rgba(0,0,0,0.95));' loading='lazy' %}
                                    {% endif %}
                                    <picture>
                                        <source srcset="{% static 'style/images/wot/levels/tank_level_' %}{{ replay.tank.level }}.webp" type="image/webp">
                                        <img src="{% static 'style/images/wot/levels/tank_level_' %}{{ replay.tank.level }}.png" alt="Level {{ replay.tank.level }}" class="h-[30px] w-[30px] brightness-125 contrast-125" style="filter: brightness(1.25) contrast(1.25) drop-shadow(0 0 45px rgba(0,0,0,1)) drop-shadow(0 0 28px rgba(0,0,0,0.98)) drop-shadow(0 6px 22px rgba(0,0,0,0.95));" loading="lazy">
                                    </picture>
                                </div>
                            {% endif %}

                            {% if replay.mastery and replay.mastery != '0' and replay.mastery != 0 %}
                                <picture>
                                    <source srcset="{% static 'style/images/wot/library/proficiency/class_icons_' %}{{ replay.mastery }}.webp" type="image/webp">
                                    <img src="{% static 'style/images/wot/library/proficiency/class_icons_' %}{{ replay.mastery }}.png" alt="Mastery {{ replay.mastery }}" class="absolute left-1.5 bottom-1.5 h-12 w-12 md:h-14 md:w-14 drop-shadow-[0_4px_10px_rgba(0,0,0,0.85)] z-[6]" loading="lazy">
                                </picture>
                            {% endif %}

                            {% if show_achievements_on_cards and replay.battle_achievements %}
                                <div class="absolute flex items-center gap-0.5 z-[6]" style="bottom: 16px; {% if replay.mastery and replay.mastery != '0' and replay.mastery != 0 %}left: 58px{% else %}left: 6px{% endif %}">
                                    {% for ach in replay.battle_achievements %}
                                        <img src="{% static ach.resolved_image %}"
                                             alt="{{ ach.name }}"
                                             class="h-7 w-7 md:h-8 md:w-8 drop-shadow-[0_2px_6px_rgba(0,0,0,0.9)]"
                                             loading="lazy">
                                    {% endfor %}
                                </div>
                            {% endif %}

                            <!-- Убираю battleType пока нет этого поля в модели -->
                        </div>

                        <div class="details">
                            <div class="flex flex-col gap-1 leading-snug">
                                {% if replay.short_description %}
                                    <div class="title text-lg font-semibold text-white">{{ replay.short_description }}</div>
                                {% else %}
                                    <div class="title text-lg font-semibold text-white">
                                        {{ replay.tank.name|default:'Неизвестный танк' }} • {{ replay.map.map_display_name|default:replay.map_name|default:'Неизвестная карта' }}
                                    </div>
                                {% endif %}
                                {% get_comment_count for replay as comment_count %}
                                <div class="flex flex-wrap items-baseline justify-between gap-2">
                                    <div class="upload-info text-sm leading-5 font-semibold text-[#ddd]">
                                        <span>{{ replay.battle_date|default_if_none:replay.created_at|localtime|date:"d.m.Y H:i" }}</span>
                                        {% if replay.get_combined_battle_display %}
                                            <span class="text-[#999] font-normal">
                                                • {{ replay.get_combined_battle_display }}
                                            </span>
                                        {% endif %}
                                        {% if replay.user %}
                                            <span class="text-[#999] font-normal">•</span>
                                            {% with sub=replay.user.subscription %}
                                                {% if sub.plan.name == 'pro' %}
                                                    <span class="text-amber-400 font-normal">{{ replay.user.username }}</span>
                                                    <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold leading-none bg-gradient-to-r from-amber-500 to-orange-500 text-white shadow-sm align-middle">PRO</span>
                                                {% elif sub.plan.name == 'premium' %}
                                                    <span class="text-blue-400 font-normal">{{ replay.user.username }}</span>
                                                    <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold leading-none bg-gradient-to-r from-blue-500 to-blue-600 text-white shadow-sm align-middle">PREMIUM</span>
                                                {% else %}
                                                    <span class="text-[#bbb] font-normal">{{ replay.user.username }}</span>
                                                {% endif %}
                                            {% endwith %}
                                        {% endif %}
                                    </div>
                                    <div class="text-sm leading-5 text-[#ddd] space-x-3">
                                        <span class="like-toggle cursor-pointer select-none hover:opacity-80 transition-opacity"
                                              data-replay-id="{{ replay.id }}"
                                              data-liked="{% if replay.user_liked %}true{% else %}false{% endif %}"
                                              onclick="event.preventDefault();event.stopPropagation();toggleLike(this);">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="{% if replay.user_liked %}#ff4458{% else %}none{% endif %}" stroke="{% if replay.user_liked %}#ff4458{% else %}#8c8c8c{% endif %}" stroke-width="2" class="inline align-[-2px]">
                                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                                            </svg>
                                            <span class="like-count">{{ replay.num_vote_up|default:"0" }}</span>
                                        </span>
                                        <span>
                                            <i class="far fa-comments text-[#8c8c8c] align-[-2px]"></i>
                                            {{ comment_count|default:"0" }}
                                        </span>
                                        <span>
                                            <i class="far fa-eye text-[#8c8c8c] align-[-2px]"></i>
                                            {{ replay.view_count|intcomma }}
                                        </span>
                                        <span>
                                            <i class="fas fa-download text-[#8c8c8c] align-[-2px]"></i>
                                            {{ replay.download_count|intcomma }}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div class="flex items-center gap-2">
                                <div class="table flex-1 min-w-0">
                                    <!-- Статистика из модели -->
                                    <div class="cell flex items-center gap-1">
                                        {% webp_image 'style/images/wot/library/XpIconBig.png' 'XP' %}
                                        <span class="ml-0.5 inline-block w-14 text-left tabular-nums text-sm">{{ replay.xp|intcomma }}</span>
                                    </div>
                                    <div class="cell flex items-center gap-1">
                                        {% webp_image 'style/images/wot/buttons/Tank-ico.png' 'Kills' %}
                                        <span class="ml-0.5 inline-block w-6 text-left tabular-nums text-sm">{{ replay.kills }}</span>
                                    </div>
                                    <div class="cell flex items-center gap-1">
                                        {% webp_image 'style/images/wot/library/BattleResultIcon-1.png' 'Damage' %}
                                        <span class="ml-0.5 inline-block w-14 text-left tabular-nums text-sm">{{ replay.damage|intcomma }}</span>
                                    </div>
                                    <div class="cell flex items-center gap-1">
                                        {% webp_image 'style/images/wot/buttons/assist.png' 'Assist' %}
                                        <span class="ml-0.5 inline-block w-14 text-left tabular-nums text-sm">{{ replay.assist|intcomma }}</span>
                                    </div>
                                    <div class="cell flex items-center gap-1">
                                        {% webp_image 'style/images/wot/buttons/blocked.png' 'Blocked' %}
                                        <span class="ml-0.5 inline-block w-14 text-left tabular-nums text-sm">{{ replay.block|intcomma }}</span>
                                    </div>
                                    <div class="cell flex items-center gap-1">
                                        {% webp_image 'style/images/wot/library/CreditsIconBig.png' 'Credits' %}
                                        <span class="ml-0.5 inline-block w-16 text-left tabular-nums text-sm">{{ replay.credits|intcomma }}</span>
                                    </div>
                                </div>
                                {% if replay.video_links.all %}
                                    <div class="flex items-center gap-1.5 flex-shrink-0">
                                        {% for vlink in replay.video_links.all %}
                                            <span class="cursor-pointer"
                                                  title="{{ vlink.get_platform_display }}"
                                                  data-href="{{ vlink.url }}"
                                                  onclick="event.preventDefault();event.stopPropagation();window.open(this.dataset.href,'_blank','noopener');">
                                                <i class="{{ vlink.icon_class }} text-base {% if vlink.platform == 'youtube' %}text-red-500 hover:text-red-400{% elif vlink.platform == 'vk' %}text-blue-400 hover:text-blue-300{% elif vlink.platform == 'rutube' %}text-teal-400 hover:text-teal-300{% endif %} transition-colors"></i>
                                            </span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                        </div>

                    </div>
                </a>
                {% if show_delete_button %}
                </div>
                {% endif %}
            {% endfor %}
        {% else %}
            <p class="empty">Пока нет загруженных реплеев.</p>
        {% endif %}
    </main>

    <!-- Пагинация -->
    {% if is_paginated %}
      <div class="pagination" x-data="{ showDropdown: false }">
        <!-- Выбор количества элементов на странице -->
        <div class="pagination-controls mb-3">
          <div class="flex items-center justify-between gap-4 flex-wrap">
            <span class="pagination-info text-sm text-gray-400">
              Показаны {{ page_obj.start_index }}–{{ page_obj.end_index }} из {{ page_obj.paginator.count }} реплеев
            </span>

            <div class="relative">
              <button
                @click="showDropdown = !showDropdown"
                @click.outside="showDropdown = false"
                class="btn btn--ghost flex items-center gap-2"
                type="button">
                <span>На странице: {{ current_per_page }}</span>
                <i class="fas fa-chevron-down text-xs transition-transform duration-200" :class="showDropdown && 'rotate-180'"></i>
              </button>

              <div
                x-show="showDropdown"
                x-transition:enter="transition ease-out duration-100"
                x-transition:enter-start="transform opacity-0 scale-95"
                x-transition:enter-end="transform opacity-100 scale-100"
                x-transition:leave="transition ease-in duration-75"
                x-transition:leave-start="transform opacity-100 scale-100"
                x-transition:leave-end="transform opacity-0 scale-95"
                class="absolute right-0 mt-2 w-20 rounded-lg bg-dark-800 border border-dark-600 shadow-xl z-10"
                style="display: none;">
                <div class="py-1">
                  {% for size in allowed_page_sizes %}
                    <a href="?{% if base_qs_without_per_page %}{{ base_qs_without_per_page }}&{% endif %}per_page={{ size }}"
                       class="block px-3 py-2 text-sm text-center transition-colors duration-150 {% if size == current_per_page %}bg-gradient-to-br from-accent-500 to-accent-600 text-white font-semibold{% else %}text-text hover:bg-dark-700{% endif %}">
                      {{ size }}
                    </a>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Кнопки навигации по страницам -->
        <div class="pagination-links flex items-center justify-center gap-1 flex-wrap">
          {% if page_obj.has_previous %}
            <a class="pagination-link" href="?{{ page_qs_prefix }}page={{ page_obj.previous_page_number }}" title="Предыдущая страница">
              <i class="fas fa-chevron-left"></i>
            </a>
          {% else %}
            <span class="pagination-link pagination-link--disabled">
              <i class="fas fa-chevron-left"></i>
            </span>
          {% endif %}

          {% get_page_range page_obj as page_range %}
          {% for page_num in page_range %}
            {% if page_num is None %}
              <span class="pagination-link pagination-link--ellipsis">...</span>
            {% elif page_num == page_obj.number %}
              <span class="pagination-link pagination-link--active">{{ page_num }}</span>
            {% else %}
              <a class="pagination-link" href="?{{ page_qs_prefix }}page={{ page_num }}">{{ page_num }}</a>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <a class="pagination-link" href="?{{ page_qs_prefix }}page={{ page_obj.next_page_number }}" title="Следующая страница">
              <i class="fas fa-chevron-right"></i>
            </a>
          {% else %}
            <span class="pagination-link pagination-link--disabled">
              <i class="fas fa-chevron-right"></i>
            </span>
          {% endif %}
        </div>
      </div>
    {% endif %}

    <script>
    function getCookieValue(name) {
      const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
      return match ? match[2] : null;
    }

    function toggleLike(el) {
      {% if not user.is_authenticated %}
        window.location.href = '{% url "account_login" %}';
        return;
      {% endif %}

      const replayId = el.dataset.replayId;
      const token = getCookieValue('csrftoken');

      fetch(`/replays/${replayId}/vote/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': token
        }
      })
      .then(r => r.json())
      .then(data => {
        const svg = el.querySelector('svg');
        const count = el.querySelector('.like-count');
        count.textContent = data.likes_count;
        el.dataset.liked = data.liked ? 'true' : 'false';
        svg.setAttribute('fill', data.liked ? '#ff4458' : 'none');
        svg.setAttribute('stroke', data.liked ? '#ff4458' : '#8c8c8c');
      })
      .catch(() => {});
    }
    </script>
