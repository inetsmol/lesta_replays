{# replays/templates/replays/list.html #}
{% extends "base.html" %}
{% load static %}
{% load custom_comments_tags %}
{% load tz %}
{% load comments %}
{% block body_class %}replays index{% endblock %}
{#{% block content_mod %}content--solo{% endblock %}#}
{% block content %}
    {% load static humanize %}
    {# Подключение wot_record_skin.css удалено - мигрировано на Tailwind #}
    {#    <div id="content" class="content content--solo">#}

    {% if page_title %}
    <h1 class="text-3xl font-bold mb-4">{{ page_title }}</h1>
    {% endif %}

    {% if news_list %}
    <!-- Bento Grid News Section -->
    <div class="news-bento-grid mb-8 max-w-5xl">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-2xl font-bold text-white">Последние новости</h2>
            <a href="{% url 'news_list' %}" class="btn btn--ghost">
                <span>Все новости</span>
                <i class="fas fa-arrow-right text-xs"></i>
            </a>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 auto-rows-[160px]">
            {% for news in news_list|slice:":3" %}
                {% if forloop.first %}
                    <!-- Первая новость - занимает 2/3 ширины и 2 ряда -->
                    <a href="{% url 'news_detail' news.id %}" class="md:col-span-2 md:row-span-2 group relative overflow-hidden rounded-2xl shadow-xl transition-all duration-300 hover:shadow-2xl hover:scale-[1.02]">
                        {% if news.image %}
                            <img src="{{ news.image.url }}" alt="{{ news.title }}" class="absolute inset-0 w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
                        {% else %}
                            <div class="absolute inset-0 bg-gradient-to-br from-gray-800 to-gray-900 flex items-center justify-center">
                                <i class="fas fa-newspaper text-gray-700 text-6xl"></i>
                            </div>
                        {% endif %}
                        <div class="absolute inset-0 bg-gradient-to-t from-black/95 via-black/50 to-transparent opacity-90 group-hover:opacity-95 transition-opacity duration-300"></div>
                        <div class="absolute inset-0 p-6 md:p-8 flex flex-col justify-end">
                            <div class="mb-3">
                                <span class="inline-block px-3 py-1 bg-red-600/90 backdrop-blur-sm rounded-full text-xs font-bold text-white uppercase tracking-wide">
                                    Главное
                                </span>
                            </div>
                            <h3 class="text-2xl md:text-3xl font-bold text-white mb-3 leading-tight drop-shadow-2xl group-hover:text-yellow-400 transition-colors duration-300">
                                {{ news.title }}
                            </h3>
                            <p class="text-gray-200 text-sm md:text-base leading-relaxed line-clamp-3 drop-shadow-lg">
                                {{ news.text }}
                            </p>
                        </div>
                        <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                            <div class="w-10 h-10 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center">
                                <i class="fas fa-arrow-right text-white text-lg"></i>
                            </div>
                        </div>
                    </a>
                {% else %}
                    <!-- Вторая и третья новости - занимают 1/3 ширины -->
                    <a href="{% url 'news_detail' news.id %}" class="group relative overflow-hidden rounded-2xl shadow-xl transition-all duration-300 hover:shadow-2xl hover:scale-[1.02]">
                        {% if news.image %}
                            <img src="{{ news.image.url }}" alt="{{ news.title }}" class="absolute inset-0 w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
                        {% else %}
                            <div class="absolute inset-0 bg-gradient-to-br from-blue-900 to-blue-800 flex items-center justify-center">
                                <i class="fas fa-newspaper text-blue-700 text-5xl"></i>
                            </div>
                        {% endif %}
                        <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent opacity-90 group-hover:opacity-95 transition-opacity duration-300"></div>
                        <div class="absolute inset-0 p-5 flex flex-col justify-end">
                            <h3 class="text-xl font-bold text-white mb-2 leading-tight drop-shadow-xl group-hover:text-yellow-400 transition-colors duration-300 line-clamp-2">
                                {{ news.title }}
                            </h3>
                            <p class="text-gray-300 text-sm line-clamp-2 drop-shadow-lg">
                                {{ news.text }}
                            </p>
                        </div>
                        <div class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                            <div class="w-8 h-8 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center">
                                <i class="fas fa-arrow-right text-white text-sm"></i>
                            </div>
                        </div>
                    </a>
                {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="filters-actions mb-3" x-data="{ expanded: false }">
      <div class="flex items-start justify-between gap-2 mb-2 w-full">
        <!-- СОРТИРОВКИ ПЕРВЫЙ РЯД (слева) -->
        <div class="flex items-start gap-2">
          <div class="sorters grid grid-cols-5 gap-2">
            {# Урон #}
            <a class="btn btn--ghost {% if current_sort == 'damage' %}active{% endif %}"
               href="?{{ page_qs_prefix }}sort=damage&dir={{ next_dir.damage }}"
               title="Сортировать по урону">
              <img src="{% static 'style/images/wot/library/BattleResultIcon-1.png' %}" alt="Damage" class="inline-block h-4 -translate-y-[3px]">
              Урон
              {% if current_sort == 'damage' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
            </a>

            {# Кредиты #}
            <a class="btn btn--ghost {% if current_sort == 'credits' %}active{% endif %}"
               href="?{{ page_qs_prefix }}sort=credits&dir={{ next_dir.credits }}"
               title="Сортировать по кредитам">
              <img src="{% static 'style/images/wot/library/CreditsIconBig.png' %}" alt="Credits" class="inline-block h-4 -translate-y-[3px]">
              Кредиты
              {% if current_sort == 'credits' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
            </a>

            {# Опыт #}
            <a class="btn btn--ghost {% if current_sort == 'xp' %}active{% endif %}"
               href="?{{ page_qs_prefix }}sort=xp&dir={{ next_dir.xp }}"
               title="Сортировать по опыту">
              <img src="{% static 'style/images/wot/library/XpIconBig.png' %}" alt="XP" class="inline-block h-4 -translate-y-[3px]">
              Опыт
              {% if current_sort == 'xp' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
            </a>

            {# Фраги #}
            <a class="btn btn--ghost {% if current_sort == 'kills' %}active{% endif %}"
               href="?{{ page_qs_prefix }}sort=kills&dir={{ next_dir.kills }}"
               title="Сортировать по фрагам">
              <img src="{% static 'style/images/wot/buttons/Tank-ico.png' %}" alt="Kills" class="inline-block h-4 -translate-y-[3px]">
              Фраги
              {% if current_sort == 'kills' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
            </a>

            {# Ассист #}
            <a class="btn btn--ghost {% if current_sort == 'assist' %}active{% endif %}"
               href="?{{ page_qs_prefix }}sort=assist&dir={{ next_dir.assist }}"
               title="Сортировать по ассисту">
              <img src="{% static 'style/images/wot/buttons/assist.png' %}" alt="Assist" class="inline-block h-4 -translate-y-[3px]">
              Ассист
              {% if current_sort == 'assist' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
            </a>
          </div>

          <!-- КНОПКА ЕЩЁ (слева вместе с сортировками) -->
          <button @click="expanded = !expanded" class="btn btn--ghost" type="button">
            <span x-text="expanded ? 'Скрыть' : 'Ещё'"></span>
            <i class="fas fa-chevron-down text-xs transition-transform duration-200" :class="expanded && 'rotate-180'"></i>
          </button>
        </div>

        <!-- КНОПКИ ФИЛЬТРОВ (справа) -->
        <div class="flex gap-2.5 flex-shrink-0">
          <a class="btn btn--ghost" href="{{ filters_url }}">
            <i class="fas fa-filter text-red-600"></i>
            Фильтры
          </a>
          {% if has_filters_applied %}
            <a class="btn btn--ghost" href="{{ reset_url }}">Сбросить</a>
          {% endif %}
        </div>
      </div>

      <!-- СОРТИРОВКИ ВТОРОЙ РЯД (раскрывающийся) -->
      <div x-show="expanded"
           x-collapse
           class="sorters grid grid-cols-5 gap-2">
        {# Заблокировано бронёй #}
        <a class="btn btn--ghost {% if current_sort == 'block' %}active{% endif %}"
           href="?{{ page_qs_prefix }}sort=block&dir={{ next_dir.block }}"
           title="Сортировать по заблокированному урону">
          <img src="{% static 'style/images/wot/buttons/blocked.png' %}" alt="Blocked" class="inline-block h-4 -translate-y-[3px]">
          Блок
          {% if current_sort == 'block' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
        </a>

        {# Дата загрузки #}
        <a class="btn btn--ghost {% if current_sort == 'created_at' %}active{% endif %}"
           href="?{{ page_qs_prefix }}sort=created_at&dir={{ next_dir.created_at }}"
           title="Сортировать по дате загрузки">
          <i class="far fa-clock inline-block text-base align-middle -translate-y-[2px]"></i>
          Дата загрузки
          {% if current_sort == 'created_at' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
        </a>

        {# Комментарии #}
        <a class="btn btn--ghost {% if current_sort == 'comment_count' %}active{% endif %}"
           href="?{{ page_qs_prefix }}sort=comment_count&dir={{ next_dir.comment_count }}"
           title="Сортировать по количеству комментариев">
          <i class="far fa-comments inline-block text-base align-middle -translate-y-[2px]"></i>
          Комментарии
          {% if current_sort == 'comment_count' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
        </a>

        {# Просмотры #}
        <a class="btn btn--ghost {% if current_sort == 'view_count' %}active{% endif %}"
           href="?{{ page_qs_prefix }}sort=view_count&dir={{ next_dir.view_count }}"
           title="Сортировать по просмотрам">
          <i class="far fa-eye inline-block text-base align-middle -translate-y-[2px]"></i>
          Просмотры
          {% if current_sort == 'view_count' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
        </a>

        {# Скачивания #}
        <a class="btn btn--ghost {% if current_sort == 'download_count' %}active{% endif %}"
           href="?{{ page_qs_prefix }}sort=download_count&dir={{ next_dir.download_count }}"
           title="Сортировать по скачиваниям">
          <i class="fas fa-download inline-block text-base align-middle -translate-y-[2px]"></i>
          Скачивания
          {% if current_sort == 'download_count' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
        </a>
      </div>
    </div>

    <main class="replay-grid replay-grid--rows">
        {% if items %}
            {% for replay in items %}
                {% if show_delete_button %}
                <div class="relative">
                {% endif %}
                    <a class="tovabb replay-card group"
                        href="{% url 'replay_detail' replay.id %}?back={{ request.get_full_path|urlencode }}"
                        title="{{ replay.tank.name|default:'Неизвестный танк' }} - {{ replay.map.map_display_name|default:replay.map_name|default:'Неизвестная карта' }}">
                        <div class="wrapper transform transition duration-200 ease-out group-hover:-translate-y-1 group-hover:scale-[1.02] group-hover:shadow-[0_18px_30px_-18px_rgba(0,0,0,0.75)] relative">

                            <!-- КНОПКА УДАЛЕНИЯ -->
                            {% if show_delete_button %}
                                <form action="{% url 'replay_delete' replay.id %}" method="post"
                                      onsubmit="return confirm('Вы уверены, что хотите удалить этот реплей?');"
                                      class="absolute top-2 right-2 z-[20]"
                                      onclick="event.stopPropagation();">
                                    {% csrf_token %}
                                    <button type="submit"
                                            class="flex items-center justify-center w-8 h-8 bg-red-600/90 hover:bg-red-700 text-white rounded-md transition-all duration-200 hover:scale-110 shadow-lg backdrop-blur-sm">
                                        <i class="fas fa-trash-alt text-sm"></i>
                                    </button>
                                </form>
                            {% endif %}

                        <div class="img-container">
                            <!-- КАРТА -->
                            {% if replay.map %}
                                <img class="map"
                                     src="{% static 'style/images/wot/map/stats/' %}{{ replay.map.map_name }}.png"
                                     alt="{{ replay.map.map_display_name|default:replay.map.map_name }}"/>
                            {% else %}
                                <img class="map"
                                     src="{% static 'maps/map_placeholder.jpg' %}"
                                     alt="Неизвестная карта"/>
                            {% endif %}

                            <!-- ТАНК -->
                            {% if replay.tank %}
                                <img class="tank"
                                     src="{% static 'style/images/wot/shop/vehicles/180x135/' %}{{ replay.tank.vehicleId }}.png"
                                     alt="{{ replay.tank.name }}"/>
                            {% endif %}

                            <span class="map-name">{{ replay.map.map_display_name|default:replay.map_name|default:'Неизвестная карта' }}</span>
                            <span class="name absolute !right-[4px] !bottom-[4px] inline-flex max-w-[160px] items-center justify-end rounded bg-black/40 px-2 py-1 text-sm font-medium text-white text-right backdrop-blur-sm shadow-[0_0_8px_rgba(0,0,0,0.8)] !left-auto !top-auto !z-[5] whitespace-nowrap">
                                {{ replay.tank.name|default:'Неизвестный танк' }}
                            </span>

                            {% if replay.tank.type or replay.tank.level %}
                                <div class="absolute right-2 top-2 flex items-center justify-end gap-1.5 z-[6]">
                                    {% if replay.tank.type %}
                                        <span class="relative inline-flex h-[30px] w-[30px]">
                                            <img
                                                class="pointer-events-none absolute inset-0 h-full w-full select-none brightness-125 contrast-125 drop-shadow-[0_0_45px_rgba(0,0,0,1),0_0_28px_rgba(0,0,0,0.98),0_6px_22px_rgba(0,0,0,0.95)]"
                                                src="{% static 'style/images/wot/vehicleTypes/' %}{{ replay.tank.type }}.png"
                                                alt=""
                                                aria-hidden="true"
                                            />
                                            <img
                                                class="pointer-events-none absolute inset-0 h-full w-full select-none brightness-[150%] contrast-[145%] drop-shadow-[0_0_45px_rgba(0,0,0,1),0_0_28px_rgba(0,0,0,0.98),0_6px_22px_rgba(0,0,0,0.95)]"
                                                src="{% static 'style/images/wot/vehicleTypes/' %}{{ replay.tank.type }}.png"
                                                alt=""
                                                aria-hidden="true"
                                            />
                                            <img
                                                class="pointer-events-none absolute inset-0 h-full w-full select-none brightness-[135%] contrast-[140%] drop-shadow-[0_0_45px_rgba(0,0,0,1),0_0_28px_rgba(0,0,0,0.98),0_6px_22px_rgba(0,0,0,0.95)]"
                                                src="{% static 'style/images/wot/vehicleTypes/' %}{{ replay.tank.type }}.png"
                                                alt=""
                                                aria-hidden="true"
                                            />
                                            <img
                                                class="relative h-full w-full brightness-125 contrast-125 drop-shadow-[0_0_45px_rgba(0,0,0,1),0_0_28px_rgba(0,0,0,0.98),0_6px_22px_rgba(0,0,0,0.95)]"
                                                src="{% static 'style/images/wot/vehicleTypes/' %}{{ replay.tank.type }}.png"
                                                alt="Vehicle type"
                                            />
                                        </span>
                                    {% endif %}
                                    {% if replay.tank.level %}
                                        <span class="relative inline-flex h-[30px] w-[30px]">
                                            <img
                                                class="pointer-events-none absolute inset-0 h-full w-full select-none brightness-125 contrast-125 drop-shadow-[0_0_45px_rgba(0,0,0,1),0_0_28px_rgba(0,0,0,0.98),0_6px_22px_rgba(0,0,0,0.95)]"
                                                src="{% static 'style/images/wot/levels/tank_level_' %}{{ replay.tank.level }}.png"
                                                alt=""
                                                aria-hidden="true"
                                            />
                                            <img
                                                class="pointer-events-none absolute inset-0 h-full w-full select-none brightness-[150%] contrast-[145%] drop-shadow-[0_0_45px_rgba(0,0,0,1),0_0_28px_rgba(0,0,0,0.98),0_6px_22px_rgba(0,0,0,0.95)]"
                                                src="{% static 'style/images/wot/levels/tank_level_' %}{{ replay.tank.level }}.png"
                                                alt=""
                                                aria-hidden="true"
                                            />
                                            <img
                                                class="pointer-events-none absolute inset-0 h-full w-full select-none brightness-[135%] contrast-[140%] drop-shadow-[0_0_45px_rgba(0,0,0,1),0_0_28px_rgba(0,0,0,0.98),0_6px_22px_rgba(0,0,0,0.95)]"
                                                src="{% static 'style/images/wot/levels/tank_level_' %}{{ replay.tank.level }}.png"
                                                alt=""
                                                aria-hidden="true"
                                            />
                                            <img
                                                class="relative h-full w-full brightness-125 contrast-125 drop-shadow-[0_0_45px_rgba(0,0,0,1),0_0_28px_rgba(0,0,0,0.98),0_6px_22px_rgba(0,0,0,0.95)]"
                                                src="{% static 'style/images/wot/levels/tank_level_' %}{{ replay.tank.level }}.png"
                                                alt="Level {{ replay.tank.level }}"
                                            />
                                        </span>
                                    {% endif %}
                                </div>
                            {% endif %}

                            {% if replay.mastery %}
                                <img
                                    class="absolute left-1.5 bottom-1.5 h-12 w-12 md:h-14 md:w-14 drop-shadow-[0_4px_10px_rgba(0,0,0,0.85)] z-[6]"
                                    src="{% static 'style/images/wot/library/proficiency/class_icons_' %}{{ replay.mastery }}.png"
                                    alt="Mastery {{ replay.mastery }}"
                                />
                            {% endif %}

                            <!-- Убираю battleType пока нет этого поля в модели -->
                        </div>

                        <div class="details">
                            <div class="flex flex-col gap-1 leading-snug">
                                {% if replay.short_description %}
                                    <div class="title text-lg font-semibold text-white">{{ replay.short_description }}</div>
                                {% else %}
                                    <div class="title text-lg font-semibold text-white">
                                        {{ replay.tank.name|default:'Неизвестный танк' }} • {{ replay.map.map_display_name|default:replay.map_name|default:'Неизвестная карта' }}
                                    </div>
                                {% endif %}
                                {% get_comment_count for replay as comment_count %}
                                <div class="flex flex-wrap items-center justify-between gap-2">
                                    <div class="upload-info text-sm font-semibold text-[#ddd]">
                                        {{ replay.battle_date|default_if_none:replay.created_at|localtime|date:"d.m.Y H:i" }}
                                    </div>
                                    <div class="flex flex-wrap items-center gap-3 text-sm text-[#ddd]">
                                        <span class="inline-flex items-center gap-1">
                                            <i class="far fa-comments inline-block text-base text-[#8c8c8c]"></i>
                                            <span class="align-middle text-sm text-[#ddd]">{{ comment_count|default:"0" }}</span>
                                        </span>
                                        <span class="inline-flex items-center gap-1">
                                            <i class="far fa-eye inline-block text-base text-[#8c8c8c]"></i>
                                            <span class="align-middle text-sm text-[#ddd]">{{ replay.view_count|intcomma }}</span>
                                        </span>
                                        <span class="inline-flex items-center gap-1">
                                            <i class="fas fa-download inline-block text-base text-[#8c8c8c]"></i>
                                            <span class="align-middle text-sm text-[#ddd]">{{ replay.download_count|intcomma }}</span>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div class="table">
                                <!-- Статистика из модели -->
                                <div class="cell flex items-center gap-1">
                                    <img src="{% static 'style/images/wot/library/CreditsIconBig.png' %}"
                                         alt="Credits"/>
                                    <span class="ml-0.5 inline-block w-16 text-left tabular-nums text-sm">{{ replay.credits|intcomma }}</span>
                                </div>
                                <div class="cell flex items-center gap-1">
                                    <img src="{% static 'style/images/wot/library/XpIconBig.png' %}" alt="XP"/>
                                    <span class="ml-0.5 inline-block w-14 text-left tabular-nums text-sm">{{ replay.xp|intcomma }}</span>
                                </div>
                                <div class="cell flex items-center gap-1">
                                    <img src="{% static 'style/images/wot/buttons/Tank-ico.png' %}" alt="Kills"/>
                                    <span class="ml-0.5 inline-block w-6 text-left tabular-nums text-sm">{{ replay.kills }}</span>
                                </div>
                                <div class="cell flex items-center gap-1">
                                    <img src="{% static 'style/images/wot/library/BattleResultIcon-1.png' %}"
                                         alt="Damage"/>
                                    <span class="ml-0.5 inline-block w-14 text-left tabular-nums text-sm">{{ replay.damage|intcomma }}</span>
                                </div>
                                <div class="cell flex items-center gap-1">
                                    <img src="{% static 'style/images/wot/buttons/assist.png' %}" alt="Assist"/>
                                    <span class="ml-0.5 inline-block w-14 text-left tabular-nums text-sm">{{ replay.assist|intcomma }}</span>
                                </div>
                                <div class="cell flex items-center gap-1">
                                    <img src="{% static 'style/images/wot/buttons/blocked.png' %}" alt="Blocked"/>
                                    <span class="ml-0.5 inline-block w-14 text-left tabular-nums text-sm">{{ replay.block|intcomma }}</span>
                                </div>
                            </div>

                        </div>

                    </div>
                </a>
                {% if show_delete_button %}
                </div>
                {% endif %}
            {% endfor %}
        {% else %}
            <p class="empty">Пока нет загруженных реплеев.</p>
        {% endif %}
    </main>

    <!-- Пагинация -->
    {% if is_paginated %}
      <div class="pagination">
        <span class="pagination-links">
          {% if page_obj.has_previous %}
            <a class="pagination-link" href="?{{ page_qs_prefix }}page=1">&laquo;&laquo; Первая</a>
            <a class="pagination-link" href="?{{ page_qs_prefix }}page={{ page_obj.previous_page_number }}">&laquo; Назад</a>
          {% endif %}

          <span class="current-page">
            Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}
          </span>

          {% if page_obj.has_next %}
            <a class="pagination-link" href="?{{ page_qs_prefix }}page={{ page_obj.next_page_number }}">Вперед &raquo;</a>
            <a class="pagination-link" href="?{{ page_qs_prefix }}page={{ page_obj.paginator.num_pages }}">Последняя &raquo;&raquo;</a>
          {% endif %}
        </span>

        <span class="pagination-info">
          Показаны {{ page_obj.start_index }}–{{ page_obj.end_index }} из {{ page_obj.paginator.count }} реплеев
        </span>
      </div>
    {% endif %}


{% endblock %}
