{# replays/templates/replays/filters.html #}
{% extends "base.html" %}
{% load static humanize %}

{% block title %}Фильтры реплеев — Lesta Replays{% endblock %}
{% block body_class %}replays filters{% endblock %}

{% block content %}
    <link rel="stylesheet" href="{% static 'css/replays_filters.css' %}">
    <section class="card" style="padding:20px;">

        <div class="filter-container">
            <div>
                <h1 style="margin-bottom:16px;">Фильтры</h1>
            </div>
            <div style=" display: flex; gap:10px; margin-bottom:16px;">
                <a class="btn btn--ghost" href="{{ list_url }}">К списку</a>
                <a class="btn btn--ghost" href="{{ list_url }}">Сбросить</a>
                <button type="submit" class="btn btn--accent">Применить</button>
            </div>
        </div>


        <form class="form" method="get" action="{{ list_url }}">
            <div class="form-row grid-3">
                <div class="field">
                    <label for="map_search">Карта</label>
                    <input type="search" id="map_search" name="map_search"
                           value="{{ current_filters.map_search.0|default_if_none:'' }}"
                           placeholder="Название карты">
                </div>
                <div class="field">
                    <label for="date_from">Дата боя — с</label>
                    <input type="date" id="date_from" name="date_from"
                           value="{{ current_filters.date_from.0|default_if_none:'' }}">
                </div>
                <div class="field">
                    <label for="date_to">Дата боя — по</label>
                    <input type="date" id="date_to" name="date_to"
                           value="{{ current_filters.date_to.0|default_if_none:'' }}">
                </div>
            </div>

            <div class="form-row grid-3">
                <div class="field">
                    <label>Урон</label>
                    <div class="grid grid-2">
                        <input type="number" name="damage_min" placeholder="от"
                               value="{{ current_filters.damage_min.0|default_if_none:'' }}">
                        <input type="number" name="damage_max" placeholder="до"
                               value="{{ current_filters.damage_max.0|default_if_none:'' }}">
                    </div>
                </div>
                <div class="field">
                    <label>Фраги</label>
                    <div class="grid grid-2">
                        <input type="number" name="kills_min" placeholder="от"
                               value="{{ current_filters.kills_min.0|default_if_none:'' }}">
                        <input type="number" name="kills_max" placeholder="до"
                               value="{{ current_filters.kills_max.0|default_if_none:'' }}">
                    </div>
                </div>
                {% with vic=current_filters.victory.0 %}
                    <div class="field">
                        <label>Результат боя</label>
                        <div class="chips">
                            <label class="chip"><input type="radio" name="victory" value=""
                                                       {% if not vic %}checked{% endif %}>Любой</label>
                            <label class="chip"><input type="radio" name="victory" value="win"
                                                       {% if vic == 'win' %}checked{% endif %}>Победа</label>
                            <label class="chip"><input type="radio" name="victory" value="loss"
                                                       {% if vic == 'loss' %}checked{% endif %}>Поражение</label>
                        </div>
                    </div>
                {% endwith %}
            </div>

            <hr class="mt-8 mb-8" style="border:none;border-top:1px solid var(--border);"/>

            <div class="form-row grid-3">
                <div class="field">
                    <label>Нации</label>
                    {% with selected=current_filters.nation|default:"" %}
                        <div class="chips">
                            {% for val,label in filter_data.nations %}
                                {% with sval=val|stringformat:"s" %}
                                    <label class="chip">
                                        <input type="checkbox" name="nation" value="{{ sval }}"
                                               {% if sval in selected %}checked{% endif %}>
                                        {{ label }}
                                    </label>
                                {% endwith %}
                            {% endfor %}
                        </div>
                    {% endwith %}
                </div>

                <div class="field">
                    <label>Уровни</label>
                    {% with selected=current_filters.level|default:"" %}
                        <div class="chips">
                            {% for lvl in filter_data.levels %}
                                {% with slvl=lvl|stringformat:"s" %}
                                    <label class="chip">
                                        <input type="checkbox" name="level" value="{{ slvl }}"
                                               {% if slvl in selected %}checked{% endif %}>
                                        {{ lvl }}
                                    </label>
                                {% endwith %}
                            {% endfor %}
                        </div>
                    {% endwith %}
                </div>

                <div class="field">
                    <label>Типы</label>
                    {% with selected=current_filters.type|default:"" %}
                        <div class="chips">
                            {% for t in filter_data.tank_types %}
                                {% with st=t|stringformat:"s" %}
                                    <label class="chip">
                                        <input type="checkbox" name="type" value="{{ st }}"
                                               {% if st in selected %}checked{% endif %}>
                                        {% if t == 'lighttank' %}Лёгкий танк
                                        {% elif t == 'mediumtank' %}Средний танк
                                        {% elif t == 'heavytank' %}Тяжёлый танк
                                        {% elif t == 'at-spg' %}ПТ-САУ
                                        {% elif t == 'spg' %}САУ
                                        {% elif t == 'unknown' %}Неизвестный танк
                                        {% else %}{{ t }}{% endif %}
                                    </label>
                                {% endwith %}
                            {% endfor %}
                        </div>
                    {% endwith %}
                </div>
            </div>

            <div class="form-row">
                <div class="field">
                    <label>Степени мастерства</label>
                    {% with selected=current_filters.mastery|default:"" %}
                        <div class="chips">
                            {% for val,label in filter_data.mastery_choices %}
                                {% with sval=val|stringformat:"s" %}
                                    <label class="chip">
                                        <input type="checkbox" name="mastery" value="{{ sval }}"
                                               {% if sval in selected %}checked{% endif %}>
                                        {% if val == 4 %}Мастер{% elif val == 3 %}1 степень{% elif val == 2 %}2
                                            степень{% elif val == 1 %}3 степень{% else %}Без знака{% endif %}
                                    </label>
                                {% endwith %}
                            {% endfor %}
                        </div>
                    {% endwith %}
                </div>
            </div>

            <hr class="mt-8 mb-8" style="border:none;border-top:1px solid var(--border);"/>

            <div class="form-row">
                <div class="field">
                    <label for="tank-search">Техника</label>
                    <input type="search" id="tank-search" placeholder="Поиск по названию…">
                    <div class="text-muted-sm mt-8">Всего: <span
                            class="tank-count">{{ filter_data.tanks|length }}</span></div>

                    {% with selected=current_filters.tank|default:"" %}
                        <div id="tank-list" class="mt-8"
                             style="max-height:320px; overflow:auto; border:1px solid var(--border); border-radius: var(--radius-sm); padding:8px; background:var(--panel-2);">
                            {% for t in filter_data.tanks %}
                                {% with tid=t.id|stringformat:"s" %}
                                    <label class="tank-item" data-name="{{ t.name|lower }}" data-nation="{{ t.nation }}"
                                           data-level="{{ t.level }}" data-type="{{ t.type }}"
                                           style="display:block; padding:4px 2px;">
                                        <input type="checkbox" name="tank" value="{{ tid }}"
                                               {% if tid in selected %}checked{% endif %}>
                                        <span class="checkbox"></span> {{ t.name }}
                                    </label>
                                {% endwith %}
                            {% endfor %}
                        </div>
                    {% endwith %}
                </div>
            </div>

            <div class="actions" style="display:flex; gap:10px; margin-top:16px;">
                <a class="btn btn--ghost" href="{{ list_url }}">К списку</a>
                <a class="btn btn--ghost" href="{{ list_url }}">Сбросить</a>
                <button type="submit" class="btn btn--accent">Применить</button>
            </div>
        </form>
    </section>

    <script>
        // Простой поиск по списку техники
        (function () {
            const search = document.getElementById('tank-search');
            const list = document.getElementById('tank-list');
            const count = document.querySelector('.tank-count');
            if (!search || !list) return;
            const items = Array.from(list.querySelectorAll('.tank-item'));
            const update = () => {
                const q = search.value.trim().toLowerCase();
                let visible = 0;
                items.forEach(it => {
                    const ok = !q || (it.dataset.name || '').includes(q);
                    it.style.display = ok ? 'block' : 'none';
                    if (ok) visible++;
                });
                if (count) count.textContent = String(visible);
            };
            search.addEventListener('input', update);
            update();
        })();
    </script>
{% endblock %}
