{# replays/templates/replays/filters.html #}
{% extends "base.html" %}
{% load static humanize %}

{% block title %}Фильтры реплеев — Lesta Replays{% endblock %}
{% block body_class %}replays filters-page{% endblock %}

{% block content %}
    <section class="card filters-card">

        <div class="filters-header">
            <div class="filters-title">
                <h1>Фильтры поиска</h1>
            </div>
            <div class="filters-actions-top">
                <a class="btn btn--ghost" href="{{ list_url }}">Сбросить</a>
                <button type="submit" class="btn btn--accent" form="filters-form">Применить</button>
            </div>
        </div>

        <form id="filters-form" class="filters-form" method="get" action="{{ list_url }}">
            
            <!-- Основная информация -->
            <div class="filter-section">
                <h3 class="filter-section-title"><i class="fas fa-info-circle"></i> Основное</h3>
                <div class="filter-grid grid-3">
                    <div class="field-group">
                        <label for="map_search">Карта</label>
                        <div class="input-wrapper">
                            <i class="fas fa-map"></i>
                            <input type="search" id="map_search" name="map_search"
                                   value="{{ current_filters.map_search.0|default_if_none:'' }}"
                                   placeholder="Название карты...">
                        </div>
                    </div>
                    <div class="field-group">
                        <label for="date_from">Дата боя (с)</label>
                        <div class="input-wrapper">
                            <input type="date" id="date_from" name="date_from"
                                   value="{{ current_filters.date_from.0|default_if_none:'' }}">
                        </div>
                    </div>
                    <div class="field-group">
                        <label for="date_to">Дата боя (по)</label>
                        <div class="input-wrapper">
                            <input type="date" id="date_to" name="date_to"
                                   value="{{ current_filters.date_to.0|default_if_none:'' }}">
                        </div>
                    </div>
                </div>
            </div>

            <hr class="filter-divider">

            <!-- Игроки и Описание -->
            <div class="filter-section">
                <h3 class="filter-section-title"><i class="fas fa-users"></i> Участники и Описание</h3>
                <div class="filter-grid grid-3">
                    <div class="field-group">
                        <label for="owner_nick">Ник владельца</label>
                        <div class="input-wrapper">
                            <i class="fas fa-user"></i>
                            <input type="search" id="owner_nick" name="owner_nick"
                                   value="{{ current_filters.owner_nick.0|default_if_none:'' }}"
                                   placeholder="Напр.: unknowns2002">
                        </div>
                    </div>
                    <div class="field-group">
                        <label for="participant_nick">Ник участника</label>
                        <div class="input-wrapper">
                            <i class="fas fa-user-friends"></i>
                            <input type="search" id="participant_nick" name="participant_nick"
                                   value="{{ current_filters.participant_nick.0|default_if_none:'' }}"
                                   placeholder="Любой игрок...">
                        </div>
                        <div class="help-text">Поиск по всем участникам боя</div>
                    </div>
                    <div class="field-group">
                        <label for="owner_clan">Клан игрока</label>
                        <div class="input-wrapper">
                            <i class="fas fa-shield-alt"></i>
                            <input type="search" id="owner_clan" name="owner_clan"
                                   value="{{ current_filters.owner_clan.0|default_if_none:'' }}"
                                   placeholder="Напр.: RED">
                        </div>
                    </div>
                    <div class="field-group span-3">
                        <label for="short_description">Описание</label>
                        <div class="input-wrapper">
                            <i class="fas fa-align-left"></i>
                            <input type="search" id="short_description" name="short_description"
                                   value="{{ current_filters.short_description.0|default_if_none:'' }}"
                                   placeholder="Текст из описания реплея...">
                        </div>
                    </div>
                </div>
            </div>

            <hr class="filter-divider">

            <!-- Результаты боя -->
            <div class="filter-section">
                <h3 class="filter-section-title"><i class="fas fa-trophy"></i> Результаты</h3>
                <div class="filter-grid grid-3">
                    <div class="field-group">
                        <label>Урон</label>
                        <div class="range-inputs">
                            <input type="number" name="damage_min" placeholder="От"
                                   value="{{ current_filters.damage_min.0|default_if_none:'' }}">
                            <span class="separator">—</span>
                            <input type="number" name="damage_max" placeholder="До"
                                   value="{{ current_filters.damage_max.0|default_if_none:'' }}">
                        </div>
                    </div>
                    <div class="field-group">
                        <label>Фраги</label>
                        <div class="range-inputs">
                            <input type="number" name="kills_min" placeholder="От"
                                   value="{{ current_filters.kills_min.0|default_if_none:'' }}">
                            <span class="separator">—</span>
                            <input type="number" name="kills_max" placeholder="До"
                                   value="{{ current_filters.kills_max.0|default_if_none:'' }}">
                        </div>
                    </div>
                    
                    {% with vic=current_filters.victory.0 %}
                    <div class="field-group">
                        <label>Исход боя</label>
                        <div class="chip-group">
                            <label class="chip-radio">
                                <input type="radio" name="victory" value="" {% if not vic %}checked{% endif %}>
                                <span>Любой</span>
                            </label>
                            <label class="chip-radio win">
                                <input type="radio" name="victory" value="win" {% if vic == 'win' %}checked{% endif %}>
                                <span>Победа</span>
                            </label>
                            <label class="chip-radio loss">
                                <input type="radio" name="victory" value="loss" {% if vic == 'loss' %}checked{% endif %}>
                                <span>Поражение</span>
                            </label>
                        </div>
                    </div>
                    {% endwith %}

                    <div class="field-group span-3">
                        <label>Знак классности</label>
                        {% with selected=current_filters.mastery|default:"" %}
                        <div class="chip-group">
                            {% for val,label in filter_data.mastery_choices %}
                                {% with sval=val|stringformat:"s" %}
                                    <label class="chip-check mastery-{{ val }}">
                                        <input type="checkbox" name="mastery" value="{{ sval }}"
                                               {% if sval in selected %}checked{% endif %}>
                                        <span>
                                            {% if val == 4 %}Мастер{% elif val == 3 %}1 степень{% elif val == 2 %}2 степень{% elif val == 1 %}3 степень{% else %}Без знака{% endif %}
                                        </span>
                                    </label>
                                {% endwith %}
                            {% endfor %}
                        </div>
                        {% endwith %}
                    </div>
                </div>
            </div>

            <hr class="filter-divider">

            <!-- Техника -->
            <div class="filter-section">
                <h3 class="filter-section-title"><i class="fas fa-layer-group"></i> Техника</h3>
                
                <div class="filter-grid grid-3 mb-4">
                    <div class="field-group">
                        <label>Нация</label>
                        {% with selected=current_filters.nation|default:"" %}
                        <div class="chip-group wrap">
                            {% for val,label in filter_data.nations %}
                                {% with sval=val|stringformat:"s" %}
                                    <label class="chip-check nation" title="{{ label }}">
                                        <input type="checkbox" name="nation" value="{{ sval }}"
                                               {% if sval in selected %}checked{% endif %}>
                                        <span>{{ label }}</span>
                                    </label>
                                {% endwith %}
                            {% endfor %}
                        </div>
                        {% endwith %}
                    </div>

                    <div class="field-group">
                        <label>Уровень</label>
                        {% with selected=current_filters.level|default:"" %}
                        <div class="chip-group wrap">
                            {% for lvl in filter_data.levels %}
                                {% with slvl=lvl|stringformat:"s" %}
                                    <label class="chip-check level">
                                        <input type="checkbox" name="level" value="{{ slvl }}"
                                               {% if slvl in selected %}checked{% endif %}>
                                        <span>{{ lvl }}</span>
                                    </label>
                                {% endwith %}
                            {% endfor %}
                        </div>
                        {% endwith %}
                    </div>

                    <div class="field-group">
                        <label>Тип техники</label>
                        {% with selected=current_filters.type|default:"" %}
                        <div class="chip-group wrap">
                            {% for t in filter_data.tank_types %}
                                {% with st=t|stringformat:"s" %}
                                    <label class="chip-check type">
                                        <input type="checkbox" name="type" value="{{ st }}"
                                               {% if st in selected %}checked{% endif %}>
                                        <span>
                                        {% if t == 'lightTank' %}ЛТ
                                        {% elif t == 'mediumTank' %}СТ
                                        {% elif t == 'heavyTank' %}ТТ
                                        {% elif t == 'AT-SPG' %}ПТ
                                        {% elif t == 'SPG' %}САУ
                                        {% else %}{{ t }}{% endif %}
                                        </span>
                                    </label>
                                {% endwith %}
                            {% endfor %}
                        </div>
                        {% endwith %}
                    </div>
                </div>

                <div class="filter-grid grid-2">
                    <!-- Поиск техники -->
                    <div class="field-group search-widget">
                        <label for="tank-search">Конкретный танк</label>
                        <div class="input-wrapper">
                            <i class="fas fa-search"></i>
                            <input type="search" id="tank-search" placeholder="Поиск по названию...">
                        </div>
                        <div class="search-list-container">
                            <div class="list-header">
                                <span class="text-muted-sm">Всего: <span class="tank-count">{{ filter_data.tanks|length }}</span></span>
                            </div>
                            {% with selected=current_filters.tank|default:"" %}
                            <div id="tank-list" class="search-list">
                                {% for t in filter_data.tanks %}
                                    {% with tid=t.id|stringformat:"s" %}
                                        <label class="search-item tank-item" data-name="{{ t.name|lower }}" data-nation="{{ t.nation }}"
                                               data-level="{{ t.level }}" data-type="{{ t.type }}">
                                            <input type="checkbox" name="tank" value="{{ tid }}"
                                                   {% if tid in selected %}checked{% endif %}>
                                            <span class="item-name">{{ t.name }}</span>
                                            <span class="item-meta">{{ t.level }} ур.</span>
                                        </label>
                                    {% endwith %}
                                {% endfor %}
                            </div>
                            {% endwith %}
                        </div>
                    </div>

                    <!-- Версия игры -->
                    <div class="field-group search-widget">
                        <label for="gv-search">Версия клиента</label>
                        <div class="input-wrapper">
                            <i class="fas fa-code-branch"></i>
                            <input type="search" id="gv-search" placeholder="Поиск версии..."
                                   value="{{ current_filters.game_version_search.0|default_if_none:'' }}"
                                   name="game_version_search">
                        </div>
                        <div class="search-list-container">
                            <div class="list-header">
                                <span class="text-muted-sm">Всего: <span class="gv-count">{{ filter_data.game_versions|length }}</span></span>
                            </div>
                            {% with selected=current_filters.game_version|default:"" %}
                            <div id="gv-list" class="search-list">
                                {% for v in filter_data.game_versions %}
                                    {% with sv=v|stringformat:"s" %}
                                        <label class="search-item gv-item" data-name="{{ v|lower }}">
                                            <input type="checkbox" name="game_version" value="{{ sv }}"
                                                   {% if sv in selected %}checked{% endif %}>
                                            <span class="item-name">{{ v }}</span>
                                        </label>
                                    {% endwith %}
                                {% endfor %}
                            </div>
                            {% endwith %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="filters-footer">
                <a class="btn btn--ghost" href="{{ list_url }}">Сбросить фильтры</a>
                <button type="submit" class="btn btn--accent btn--lg">Найти реплеи</button>
            </div>

        </form>
    </section>

<script>
    // Простой поиск по списку техники
    (function () {
        const search = document.getElementById('tank-search');
        const list = document.getElementById('tank-list');
        const count = document.querySelector('.tank-count');
        if (!search || !list) return;
        const items = Array.from(list.querySelectorAll('.tank-item'));
        const update = () => {
            const q = search.value.trim().toLowerCase();
            let visible = 0;
            items.forEach(it => {
                const ok = !q || (it.dataset.name || '').includes(q);
                it.style.display = ok ? 'flex' : 'none';
                if (ok) visible++;
            });
            if (count) count.textContent = String(visible);
        };
        search.addEventListener('input', update);
        update();
    })();

    // Фильтр по списку версий клиента
    (function () {
        const search = document.getElementById('gv-search');
        const list = document.getElementById('gv-list');
        const count = document.querySelector('.gv-count');
        if (!search || !list) return;
        const items = Array.from(list.querySelectorAll('.gv-item'));
        const update = () => {
            const q = (search.value || '').trim().toLowerCase();
            let visible = 0;
            items.forEach(it => {
                const ok = !q || (it.dataset.name || '').includes(q);
                it.style.display = ok ? 'flex' : 'none';
                if (ok) visible++;
            });
            if (count) count.textContent = String(visible);
        };
        search.addEventListener('input', update);
        update();
    })();
</script>
{% endblock %}
