{# replays/templates/replays/filters.html #}
{% extends "base.html" %}
{% load static humanize %}

{% block title %}Фильтры реплеев — Lesta Replays{% endblock %}
{% block body_class %}replays filters-page{% endblock %}

{% block content %}
    <section class="card filters-card">

        <div class="filters-header">
            <div class="filters-title">
                <h1>Фильтры поиска</h1>
            </div>
            <div class="filters-actions-top">
                <a class="btn btn--ghost" href="{{ list_url }}">Сбросить</a>
                <button type="submit" class="btn btn--accent" form="filters-form">Применить</button>
            </div>
        </div>

        <form id="filters-form" class="filters-form" method="get" action="{{ list_url }}">
            
            <!-- Основная информация -->
            <div class="filter-section">
                <h3 class="filter-section-title"><i class="fas fa-info-circle"></i> Основное</h3>
                <div class="filter-grid grid-4">

<style>
    /* Grid 4 columns */
    .filter-grid.grid-4 {
        grid-template-columns: repeat(4, 1fr);
    }
    @media (max-width: 1200px) {
        .filter-grid.grid-4 {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    @media (max-width: 640px) {
        .filter-grid.grid-4 {
            grid-template-columns: 1fr;
        }
    }

    /* Стили для выпадающего списка (Dropdown) */
    .search-dropdown-wrapper {
        position: relative;
    }
    .search-dropdown-container {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: var(--surface-2, #2a2a32); /* Адаптация под темную тему */
        border: 1px solid var(--border-color, #3f3f46);
        border-radius: 0 0 8px 8px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        z-index: 1000;
        display: none;
        flex-direction: column;
        max-height: 400px;
        margin-top: 4px;
    }
    .search-dropdown-container.active {
        display: flex;
    }
    .search-dropdown-container .list-header {
        padding: 8px 12px;
        border-bottom: 1px solid var(--border-color, #3f3f46);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: var(--surface-3, #32323a);
    }
    .search-dropdown-container .search-list {
        overflow-y: auto;
        padding: 4px 0;
        max-height: 300px;
    }
    .search-dropdown-container .search-item {
        padding: 6px 12px;
        display: flex;
        align-items: center;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .search-dropdown-container .search-item:hover {
        background-color: rgba(255,255,255,0.05);
    }
    .btn-reset-sm {
        background: none;
        border: none;
        color: var(--text-muted, #9ca3af);
        cursor: pointer;
        font-size: 0.85rem;
        padding: 2px 6px;
    }
    .btn-reset-sm:hover {
        color: var(--color-accent, #eab308);
    }
</style>

                    <div class="field-group search-dropdown-wrapper">
                        <label for="map_search_input">Карта</label>
                        <div class="input-wrapper">
                            <i class="fas fa-map"></i>
                            <input type="search" id="map_search_input" placeholder="Выберите карты..." autocomplete="off">
                            <i class="fas fa-chevron-down" style="position: absolute; right: 12px; pointer-events: none; opacity: 0.5;"></i>
                        </div>
                        
                        <!-- Dropdown Container -->
                        <div id="map-dropdown" class="search-dropdown-container">
                            <div class="list-header">
                                <span class="text-muted-sm">Всего: <span id="map-count" class="item-count">{{ filter_data.maps|length }}</span></span>
                                <button type="button" class="btn-reset-sm" id="map-reset-btn">Сбросить</button>
                            </div>
                            {% with selected=current_filters.map|default:"" %}
                            <div id="map-list" class="search-list scroller">
                                {% for map_name in filter_data.maps %}
                                    <label class="search-item map-item" data-name="{{ map_name|lower }}">
                                        <input type="checkbox" name="map" value="{{ map_name }}"
                                               {% if map_name in selected %}checked{% endif %}>
                                        <span class="item-name">{{ map_name }}</span>
                                    </label>
                                {% endfor %}
                            </div>
                            {% endwith %}
                        </div>
                    </div>

                    <!-- Версия игры (Dropdown) -->
                    <div class="field-group search-dropdown-wrapper">
                        <label for="gv_search_input">Версия клиента</label>
                        <div class="input-wrapper">
                            <i class="fas fa-code-branch"></i>
                            <input type="search" id="gv_search_input" placeholder="Выберите версии..." autocomplete="off"
                                   {% if current_filters.game_version|length == 1 %}value="{{ current_filters.game_version.0 }}"{% endif %}>
                            <i class="fas fa-chevron-down" style="position: absolute; right: 12px; pointer-events: none; opacity: 0.5;"></i>
                        </div>
                        
                        <!-- Dropdown Container -->
                        <div id="gv-dropdown" class="search-dropdown-container">
                            <div class="list-header">
                                <span class="text-muted-sm">Всего: <span id="gv-count" class="item-count">{{ filter_data.game_versions|length }}</span></span>
                                <button type="button" class="btn-reset-sm" id="gv-reset-btn">Сбросить</button>
                            </div>
                            {% with selected=current_filters.game_version|default:"" %}
                            <div id="gv-list" class="search-list scroller">
                                {% for v in filter_data.game_versions %}
                                    {% with sv=v|stringformat:"s" %}
                                        <label class="search-item gv-item" data-name="{{ v|lower }}">
                                            <input type="checkbox" name="game_version" value="{{ sv }}"
                                                   {% if sv in selected %}checked{% endif %}>
                                            <span class="item-name">{{ v }}</span>
                                        </label>
                                    {% endwith %}
                                {% endfor %}
                            </div>
                            {% endwith %}
                        </div>
                    </div>

                    <div class="field-group">
                        <label for="date_from">Дата боя (с)</label>
                        <div class="input-wrapper">
                            <input type="date" id="date_from" name="date_from"
                                   value="{{ current_filters.date_from.0|default_if_none:'' }}">
                        </div>
                    </div>
                    <div class="field-group">
                        <label for="date_to">Дата боя (по)</label>
                        <div class="input-wrapper">
                            <input type="date" id="date_to" name="date_to"
                                   value="{{ current_filters.date_to.0|default_if_none:'' }}">
                        </div>
                    </div>
                </div>
            </div>

            <hr class="filter-divider">

            <!-- Премиум-фильтры -->
            <div class="filter-section">
                <h3 class="filter-section-title">
                    <i class="fas fa-crown"></i> Премиум-фильтры
                    <span class="ml-2 text-xs font-semibold px-2 py-0.5 rounded-full bg-blue-500/20 text-blue-400 border border-blue-500/30">Премиум</span>
                </h3>

                    <div class="relative">
                    {% if not can_use_advanced_filters %}
                    <!-- Оверлей для бесплатных пользователей -->
                    <div class="premium-overlay absolute inset-0 z-10 flex items-center justify-center rounded-lg" style="background: rgba(15, 15, 20, 0.45); backdrop-filter: blur(1px);">
                        <div class="text-center">
                            <i class="fas fa-lock text-blue-400 text-2xl mb-2"></i>
                            <p class="text-sm text-gray-300 mb-2">
                                Доступно для подписчиков <strong class="text-blue-400">Премиум</strong> и <strong class="text-amber-400">Про</strong>
                            </p>
                            <a href="{% url 'subscription_info' %}" class="inline-block px-4 py-1.5 rounded-lg text-sm font-semibold bg-gradient-to-r from-blue-500 to-blue-600 text-white hover:from-blue-400 hover:to-blue-500 transition-all">
                                Узнать больше
                            </a>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Режим игры -->
                    <div class="filter-grid mb-4">
                        <div class="field-group">
                            <label>Режим игры</label>
                            {% with selected=current_filters.gameplay|default:"" %}
                            <div class="chip-group wrap">
                                {% for code, label in filter_data.gameplay_modes %}
                                    <label class="chip-check">
                                        <input type="checkbox" name="gameplay" value="{{ code }}"
                                               {% if not can_use_advanced_filters %}disabled{% endif %}
                                               {% if code in selected %}checked{% endif %}>
                                        <span>{{ label }}</span>
                                    </label>
                                {% endfor %}
                            </div>
                            {% endwith %}
                            <div class="help-text">По умолчанию для подписчиков показывается только «Стандартный бой»</div>
                        </div>

                    </div>

                    <div class="filter-grid grid-2">
                        <!-- Выжил / Уничтожен -->
                        {% with sv=current_filters.survived.0 %}
                        <div class="field-group">
                            <label>Статус выживания</label>
                            <div class="chip-group">
                                <label class="chip-radio">
                                    <input type="radio" name="survived" value=""
                                           {% if not can_use_advanced_filters %}disabled{% endif %}
                                           {% if not sv %}checked{% endif %}>
                                    <span>Любой</span>
                                </label>
                                <label class="chip-radio win">
                                    <input type="radio" name="survived" value="alive"
                                           {% if not can_use_advanced_filters %}disabled{% endif %}
                                           {% if sv == 'alive' %}checked{% endif %}>
                                    <span><i class="fas fa-heart"></i>&nbsp;Выжил</span>
                                </label>
                                <label class="chip-radio loss">
                                    <input type="radio" name="survived" value="dead"
                                           {% if not can_use_advanced_filters %}disabled{% endif %}
                                           {% if sv == 'dead' %}checked{% endif %}>
                                    <span><i class="fas fa-skull-crossbones"></i>&nbsp;Уничтожен</span>
                                </label>
                            </div>
                        </div>
                        {% endwith %}

                        <!-- Продолжительность боя -->
                        <div class="field-group">
                            <label>Продолжительность боя (мин.)</label>
                            <div class="range-inputs">
                                <input type="number" name="duration_min" placeholder="От"
                                       min="0" max="15" step="1"
                                       {% if not can_use_advanced_filters %}disabled{% endif %}
                                       value="{{ current_filters.duration_min.0|default_if_none:'' }}">
                                <span class="separator">—</span>
                                <input type="number" name="duration_max" placeholder="До"
                                       min="0" max="15" step="1"
                                       {% if not can_use_advanced_filters %}disabled{% endif %}
                                       value="{{ current_filters.duration_max.0|default_if_none:'' }}">
                            </div>
                            <div class="help-text">Обычный бой длится до 15 минут</div>
                        </div>

                        <!-- Соло / Взвод -->
                        {% with pt=current_filters.platoon.0 %}
                        <div class="field-group">
                            <label>Тип боя</label>
                            <div class="chip-group">
                                <label class="chip-radio">
                                    <input type="radio" name="platoon" value=""
                                           {% if not can_use_advanced_filters %}disabled{% endif %}
                                           {% if not pt %}checked{% endif %}>
                                    <span>Любой</span>
                                </label>
                                <label class="chip-radio">
                                    <input type="radio" name="platoon" value="solo"
                                           {% if not can_use_advanced_filters %}disabled{% endif %}
                                           {% if pt == 'solo' %}checked{% endif %}>
                                    <span><i class="fas fa-user"></i>&nbsp;Соло</span>
                                </label>
                                <label class="chip-radio">
                                    <input type="radio" name="platoon" value="platoon"
                                           {% if not can_use_advanced_filters %}disabled{% endif %}
                                           {% if pt == 'platoon' %}checked{% endif %}>
                                    <span><i class="fas fa-users"></i>&nbsp;Взвод</span>
                                </label>
                            </div>
                        </div>
                        {% endwith %}
                    </div>
                    </div>
            </div>

            <hr class="filter-divider">

            <!-- Про-фильтры: Достижения -->
            <div class="filter-section">
                <h3 class="filter-section-title">
                    <i class="fas fa-medal"></i> Достижения и медали
                    <span class="ml-2 text-xs font-semibold px-2 py-0.5 rounded-full bg-amber-500/20 text-amber-400 border border-amber-500/30">Про</span>
                </h3>

                    <div class="relative">
                    {% if not can_use_pro_filters %}
                    <!-- Оверлей для пользователей без Про-подписки -->
                    <div class="premium-overlay absolute inset-0 z-10 flex items-center justify-center rounded-lg" style="background: rgba(15, 15, 20, 0.45); backdrop-filter: blur(1px);">
                        <div class="text-center">
                            <i class="fas fa-lock text-amber-400 text-2xl mb-2"></i>
                            <p class="text-sm text-gray-300 mb-2">
                                Доступно только для подписчиков <strong class="text-amber-400">Про</strong>
                            </p>
                            <a href="{% url 'subscription_info' %}" class="inline-block px-4 py-1.5 rounded-lg text-sm font-semibold bg-gradient-to-r from-amber-500 to-amber-600 text-white hover:from-amber-400 hover:to-amber-500 transition-all">
                                Узнать больше
                            </a>
                        </div>
                    </div>
                    {% endif %}

                    <div class="filter-grid grid-2">
                        <!-- Фильтр по конкретному достижению -->
                        <div class="field-group search-dropdown-wrapper">
                            <label for="ach_search_input">Конкретное достижение</label>
                            <div class="input-wrapper">
                                <i class="fas fa-award"></i>
                                <input type="search" id="ach_search_input" placeholder="Поиск достижения..." autocomplete="off"
                                       {% if not can_use_pro_filters %}disabled{% endif %}>
                                <i class="fas fa-chevron-down" style="position: absolute; right: 12px; pointer-events: none; opacity: 0.5;"></i>
                            </div>

                            <div id="ach-dropdown" class="search-dropdown-container">
                                <div class="list-header">
                                    <span class="text-muted-sm">Всего: <span id="ach-count" class="item-count">{{ filter_data.achievements|length }}</span></span>
                                    {% if can_use_pro_filters %}
                                    <button type="button" class="btn-reset-sm" id="ach-top5-btn" title="Выбрать 5 самых редких достижений">
                                        <i class="fas fa-gem"></i> Топ-5 редких
                                    </button>
                                    {% endif %}
                                    <button type="button" class="btn-reset-sm" id="ach-reset-btn">Сбросить</button>
                                </div>
                                {% with selected=current_filters.achievement|default:"" %}
                                <div id="ach-list" class="search-list scroller">
                                    {% for ach in filter_data.achievements %}
                                        {% with said=ach.achievement_id|stringformat:"s" %}
                                            <label class="search-item ach-item" data-name="{{ ach.name|lower }}">
                                                <input type="checkbox" name="achievement" value="{{ said }}"
                                                       {% if not can_use_pro_filters %}disabled{% endif %}
                                                       {% if said in selected %}checked{% endif %}>
                                                <span class="item-name">{{ ach.name }}</span>
                                                <span class="item-meta text-gray-500 text-xs">{{ ach.replay_count }} реп.</span>
                                            </label>
                                        {% endwith %}
                                    {% endfor %}
                                </div>
                                {% endwith %}
                            </div>
                        </div>

                        <!-- Фильтр по минимальному кол-ву достижений -->
                        <div class="field-group">
                            <label for="achievement_count_min">Мин. кол-во достижений</label>
                            <div class="input-wrapper">
                                <i class="fas fa-sort-numeric-up"></i>
                                <input type="number" id="achievement_count_min" name="achievement_count_min"
                                       min="0" max="50" placeholder="Например: 3"
                                       {% if not can_use_pro_filters %}disabled{% endif %}
                                       value="{{ current_filters.achievement_count_min.0|default_if_none:'' }}">
                            </div>
                            <div class="help-text">Реплеи с N и более достижениями</div>
                        </div>
                    </div>
                    </div>
            </div>

            <hr class="filter-divider">

            <!-- Техника -->
            <div class="filter-section">
                <h3 class="filter-section-title"><i class="fas fa-layer-group"></i> Техника</h3>
                
                <div class="filter-grid grid-3 mb-4">
                    <div class="field-group">
                        <label>Нация</label>
                        {% with selected=current_filters.nation|default:"" %}
                        <div class="chip-group wrap">
                            {% for val,label in filter_data.nations %}
                                {% with sval=val|stringformat:"s" %}
                                    <label class="chip-check nation" title="{{ label }}">
                                        <input type="checkbox" name="nation" value="{{ sval }}"
                                               {% if sval in selected %}checked{% endif %}>
                                        <span>{{ label }}</span>
                                    </label>
                                {% endwith %}
                            {% endfor %}
                        </div>
                        {% endwith %}
                    </div>

                    <div class="field-group">
                        <label>Уровень</label>
                        {% with selected=current_filters.level|default:"" %}
                        <div class="chip-group wrap">
                            {% for lvl in filter_data.levels %}
                                {% with slvl=lvl|stringformat:"s" %}
                                    <label class="chip-check level">
                                        <input type="checkbox" name="level" value="{{ slvl }}"
                                               {% if slvl in selected %}checked{% endif %}>
                                        <span>{{ lvl }}</span>
                                    </label>
                                {% endwith %}
                            {% endfor %}
                        </div>
                        {% endwith %}
                    </div>

                    <div class="field-group">
                        <label>Тип техники</label>
                        {% with selected=current_filters.type|default:"" %}
                        <div class="chip-group wrap">
                            {% for t in filter_data.tank_types %}
                                {% with st=t|stringformat:"s" %}
                                    <label class="chip-check type">
                                        <input type="checkbox" name="type" value="{{ st }}"
                                               {% if st in selected %}checked{% endif %}>
                                        <span>
                                        {% if t == 'lightTank' %}ЛТ
                                        {% elif t == 'mediumTank' %}СТ
                                        {% elif t == 'heavyTank' %}ТТ
                                        {% elif t == 'AT-SPG' %}ПТ
                                        {% elif t == 'SPG' %}САУ
                                        {% else %}{{ t }}{% endif %}
                                        </span>
                                    </label>
                                {% endwith %}
                            {% endfor %}
                        </div>
                        {% endwith %}
                    </div>
                </div>

                <div class="filter-grid grid-2">
                    <!-- Поиск техники -->
                    <div class="field-group search-widget">
                        <label for="tank-search">Конкретный танк</label>
                        <div class="input-wrapper">
                            <i class="fas fa-search"></i>
                            <input type="search" id="tank-search" placeholder="Поиск по названию...">
                        </div>
                        <div class="search-list-container">
                            <div class="list-header">
                                <span class="text-muted-sm">Всего: <span class="tank-count">{{ filter_data.tanks|length }}</span></span>
                            </div>
                            {% with selected=current_filters.tank|default:"" %}
                            <div id="tank-list" class="search-list">
                                {% for t in filter_data.tanks %}
                                    {% with tid=t.id|stringformat:"s" %}
                                        <label class="search-item tank-item" data-name="{{ t.name|lower }}" data-nation="{{ t.nation }}"
                                               data-level="{{ t.level }}" data-type="{{ t.type }}">
                                            <input type="checkbox" name="tank" value="{{ tid }}"
                                                   {% if tid in selected %}checked{% endif %}>
                                            <span class="item-name">{{ t.name }}</span>
                                            <span class="item-meta">{{ t.level }} ур.</span>
                                        </label>
                                    {% endwith %}
                                {% endfor %}
                            </div>
                            {% endwith %}
                        </div>
                    </div>
                </div>
            </div>

            <hr class="filter-divider">

            <!-- Результаты боя -->
            <div class="filter-section">
                <h3 class="filter-section-title"><i class="fas fa-trophy"></i> Результаты</h3>
                <div class="filter-grid grid-3">
                    <div class="field-group">
                        <label>Урон</label>
                        <div class="range-inputs">
                            <input type="number" name="damage_min" placeholder="От"
                                   value="{{ current_filters.damage_min.0|default_if_none:'' }}">
                            <span class="separator">—</span>
                            <input type="number" name="damage_max" placeholder="До"
                                   value="{{ current_filters.damage_max.0|default_if_none:'' }}">
                        </div>
                    </div>
                    <div class="field-group">
                        <label>Фраги</label>
                        <div class="range-inputs">
                            <input type="number" name="kills_min" placeholder="От"
                                   value="{{ current_filters.kills_min.0|default_if_none:'' }}">
                            <span class="separator">—</span>
                            <input type="number" name="kills_max" placeholder="До"
                                   value="{{ current_filters.kills_max.0|default_if_none:'' }}">
                        </div>
                    </div>
                    
                    {% with vic=current_filters.victory.0 %}
                    <div class="field-group">
                        <label>Исход боя</label>
                        <div class="chip-group">
                            <label class="chip-radio">
                                <input type="radio" name="victory" value="" {% if not vic %}checked{% endif %}>
                                <span>Любой</span>
                            </label>
                            <label class="chip-radio win">
                                <input type="radio" name="victory" value="win" {% if vic == 'win' %}checked{% endif %}>
                                <span>Победа</span>
                            </label>
                            <label class="chip-radio loss">
                                <input type="radio" name="victory" value="loss" {% if vic == 'loss' %}checked{% endif %}>
                                <span>Поражение</span>
                            </label>
                        </div>
                    </div>
                    {% endwith %}

                    <div class="field-group span-3">
                        <label>Знак классности</label>
                        {% with selected=current_filters.mastery|default:"" %}
                        <div class="chip-group">
                            {% for val,label in filter_data.mastery_choices %}
                                {% with sval=val|stringformat:"s" %}
                                    <label class="chip-check mastery-{{ val }}">
                                        <input type="checkbox" name="mastery" value="{{ sval }}"
                                               {% if sval in selected %}checked{% endif %}>
                                        <span>
                                            {% if val == 4 %}Мастер{% elif val == 3 %}1 степень{% elif val == 2 %}2 степень{% elif val == 1 %}3 степень{% else %}Без знака{% endif %}
                                        </span>
                                    </label>
                                {% endwith %}
                            {% endfor %}
                        </div>
                        {% endwith %}
                    </div>
                </div>
            </div>

            <hr class="filter-divider">

            <!-- Игроки и Описание -->
            <div class="filter-section">
                <h3 class="filter-section-title"><i class="fas fa-users"></i> Участники и Описание</h3>
                <div class="filter-grid grid-3">
                    <div class="field-group">
                        <label for="owner_nick">Ник владельца</label>
                        <div class="input-wrapper">
                            <i class="fas fa-user"></i>
                            <input type="search" id="owner_nick" name="owner_nick"
                                   value="{{ current_filters.owner_nick.0|default_if_none:'' }}"
                                   placeholder="Напр.: unknowns2002">
                        </div>
                    </div>
                    <div class="field-group">
                        <label for="participant_nick">Ник участника</label>
                        <div class="input-wrapper">
                            <i class="fas fa-user-friends"></i>
                            <input type="search" id="participant_nick" name="participant_nick"
                                   value="{{ current_filters.participant_nick.0|default_if_none:'' }}"
                                   placeholder="Любой игрок...">
                        </div>
                        <div class="help-text">Поиск по всем участникам боя</div>
                    </div>
                    <div class="field-group">
                        <label for="owner_clan">Клан игрока</label>
                        <div class="input-wrapper">
                            <i class="fas fa-shield-alt"></i>
                            <input type="search" id="owner_clan" name="owner_clan"
                                   value="{{ current_filters.owner_clan.0|default_if_none:'' }}"
                                   placeholder="Напр.: RED">
                        </div>
                    </div>
                    <div class="field-group span-3">
                        <label for="short_description">Описание</label>
                        <div class="input-wrapper">
                            <i class="fas fa-align-left"></i>
                            <input type="search" id="short_description" name="short_description"
                                   value="{{ current_filters.short_description.0|default_if_none:'' }}"
                                   placeholder="Текст из описания реплея...">
                        </div>
                    </div>
                </div>
            </div>

            <div class="filters-footer">
                <a class="btn btn--ghost" href="{{ list_url }}">Сбросить фильтры</a>
                <button type="submit" class="btn btn--accent btn--lg">Найти реплеи</button>
            </div>

        </form>
    </section>

<script>
    // Универсальная логика для выпадающих списков (Dropdowns)
    function initDropdown(opts) {
        const {
            inputId,
            dropdownId,
            listId,
            countId,
            resetBtnId,
            itemSelector
        } = opts;

        const input = document.getElementById(inputId);
        const dropdown = document.getElementById(dropdownId);
        const list = document.getElementById(listId);
        const count = document.getElementById(countId);
        const resetBtn = document.getElementById(resetBtnId);

        if (!input || !dropdown || !list) return;

        const items = Array.from(list.querySelectorAll(itemSelector));

        // Функция обновления видимости элементов
        const updateList = () => {
            const q = input.value.trim().toLowerCase();
            let visible = 0;
            items.forEach(it => {
                const name = it.dataset.name || '';
                const ok = !q || name.includes(q);
                it.style.display = ok ? 'flex' : 'none';
                if (ok) visible++;
            });
            if (count) count.textContent = String(visible);
        };

        // Открытие дропдауна
        const openDropdown = () => {
            dropdown.classList.add('active');
        };

        // Закрытие дропдауна
        const closeDropdown = () => {
            dropdown.classList.remove('active');
        };

        // Тоггл по клику на инпут
        input.addEventListener('focus', openDropdown);
        input.addEventListener('click', (e) => {
            e.stopPropagation();
            openDropdown();
        });

        // Фильтрация при вводе
        input.addEventListener('input', () => {
            updateList();
            openDropdown();
        });

        // Закрытие при клике вне
        document.addEventListener('click', (e) => {
            if (!dropdown.contains(e.target) && e.target !== input) {
                closeDropdown();
            }
        });

        // Сброс выбора
        if (resetBtn) {
            resetBtn.addEventListener('click', () => {
                items.forEach(it => {
                    const cb = it.querySelector('input[type="checkbox"]');
                    if (cb) cb.checked = false;
                });
                input.value = '';
                updateList();
            });
        }
        
        // Предотвращение сабмита формы при Enter в инпуте
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                closeDropdown();
            }
        });

        // Инициализация
        updateList();
    }

    // Инициализация карты
    initDropdown({
        inputId: 'map_search_input',
        dropdownId: 'map-dropdown',
        listId: 'map-list',
        countId: 'map-count',
        resetBtnId: 'map-reset-btn',
        itemSelector: '.map-item'
    });

    // Инициализация версии клиента
    initDropdown({
        inputId: 'gv_search_input',
        dropdownId: 'gv-dropdown',
        listId: 'gv-list',
        countId: 'gv-count',
        resetBtnId: 'gv-reset-btn',
        itemSelector: '.gv-item'
    });

    // Инициализация достижений (премиум)
    initDropdown({
        inputId: 'ach_search_input',
        dropdownId: 'ach-dropdown',
        listId: 'ach-list',
        countId: 'ach-count',
        resetBtnId: 'ach-reset-btn',
        itemSelector: '.ach-item'
    });

    // Кнопка «Топ-5 редких» — выбирает первые 5 чекбоксов (список уже отсортирован по редкости)
    (function() {
        var btn = document.getElementById('ach-top5-btn');
        if (!btn) return;
        btn.addEventListener('click', function() {
            var checkboxes = document.querySelectorAll('#ach-list .ach-item input[type="checkbox"]');
            var allChecked = true;
            for (var i = 0; i < Math.min(5, checkboxes.length); i++) {
                if (!checkboxes[i].checked) { allChecked = false; break; }
            }
            // Сначала снимаем всё
            checkboxes.forEach(function(cb) { cb.checked = false; });
            // Если не все 5 были отмечены — отмечаем первые 5
            if (!allChecked) {
                for (var j = 0; j < Math.min(5, checkboxes.length); j++) {
                    checkboxes[j].checked = true;
                }
            }
        });
    })();


    // Комплексная фильтрация списка техники
    (function () {
        const searchInput = document.getElementById('tank-search');
        const list = document.getElementById('tank-list');
        const count = document.querySelector('.tank-count');

        if (!searchInput || !list) return;

        const items = Array.from(list.querySelectorAll('.tank-item'));

        // Селекторы фильтров: нация, уровень, тип
        // Они находятся вне формы, но мы можем найти их по name
        const getNations = () => Array.from(document.querySelectorAll('input[name="nation"]:checked')).map(el => el.value);
        const getLevels = () => Array.from(document.querySelectorAll('input[name="level"]:checked')).map(el => el.value);
        const getTypes = () => Array.from(document.querySelectorAll('input[name="type"]:checked')).map(el => el.value);

        const updateList = () => {
            const query = searchInput.value.trim().toLowerCase();
            const selectedNations = getNations();
            const selectedLevels = getLevels();
            const selectedTypes = getTypes();

            let visibleCount = 0;

            items.forEach(item => {
                const name = (item.dataset.name || '').toLowerCase();
                const nation = item.dataset.nation || '';
                const level = item.dataset.level || '';
                const type = item.dataset.type || '';

                // Проверка по текстовому поиску
                const matchesSearch = !query || name.includes(query);

                // Проверка по фильтрам (если фильтр не выбран — подходит всё)
                const matchesNation = selectedNations.length === 0 || selectedNations.includes(nation);
                const matchesLevel = selectedLevels.length === 0 || selectedLevels.includes(level);
                // Типы в базе могут отличаться от фильтров, но здесь мы используем точное совпадение значений
                const matchesType = selectedTypes.length === 0 || selectedTypes.includes(type);

                const isVisible = matchesSearch && matchesNation && matchesLevel && matchesType;
                
                item.style.display = isVisible ? 'flex' : 'none';
                if (isVisible) visibleCount++;
            });

            if (count) count.textContent = String(visibleCount);
        };

        // Слушаем изменения в текстовом поле
        searchInput.addEventListener('input', updateList);

        // Слушаем изменения в чекбоксах фильтров
        // Находим все чекбоксы групп
        const filterInputs = document.querySelectorAll('input[name="nation"], input[name="level"], input[name="type"]');
        filterInputs.forEach(input => {
            input.addEventListener('change', updateList);
        });

        // Инициализация при загрузке
        updateList();
    })();
</script>
{% endblock %}
