{# replays/templates/replays/detail.html #}
{% extends "base.html" %}
{% load static humanize %}
{% load comments_xtd comments custom_comments_tags %}
{% load webp_tags %}

{% block title %}Реплей #{{ replay.id }} - {{ replay_data.player_name }}{% endblock %}
{% block meta_description %}
  {{ replay.short_description|default:"Подробная статистика боя: карта, техника, урон, ассист, фраги."|truncatechars:160 }}
{% endblock %}
{% block canonical_url %}{{ request.build_absolute_uri }}{% endblock %}
{% block body_class %}replays detail{% endblock %}
{% block content_mod %}content--solo{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/replay-detail.css' %}">

{% if parse_error %}
  <div class="card error">
    <h2>Ошибка обработки реплея</h2>
    <p>Не удалось извлечь данные из файла реплея: {{ parse_error }}</p>
    <a href="{{ back_url }}" class="btn btn--ghost">← К списку реплеев</a>
  </div>
{% else %}

  <div class="replay-wrapper">
    <div class="replay-tabs">
      <a href="{{ back_url }}" class="btn btn--ghost" style="margin-right:12px;">← Назад к списку</a>
      <div class="tab active" data-tab="personal">Личный результат</div>
      <div class="tab" data-tab="team">Командный результат</div>
      <div class="tab" data-tab="detailed">Подробный отчёт</div>
    </div>

    <div class="right-ajax">
      <div class="replay-download" style="display: flex; gap: 10px;">
        <button id="download-replay-btn"
                type="button"
                class="big-red-button"
                data-authenticated="{{ user.is_authenticated|lower }}"
                data-download-url="{% url 'replay_download' replay.pk %}"
                style="display: flex; align-items: center; justify-content: center;">
          Скачать
        </button>
        <button id="share-replay-btn"
                type="button"
                class="big-red-button"
                style="background: #4a5568; padding: 10px 20px; display: flex; align-items: center; justify-content: center;"
                title="Скопировать ссылку на реплей в буфер обмена">
          Поделиться
        </button>
      </div>
    </div>

    <!-- TAB: Личный результат -->
    <div class="replay-tab-wrapper active" id="tab-personal">
      <div class="tanks-image {% if battle_outcome.status_class == 'victory' %}win{% else %}{{ battle_outcome.status_class }}{% endif %}" {% if battle_outcome.status_class == 'victory' %}{% webp_background 'style/images/wot/battleresults/win.png' %}{% endif %}>
        <div class="map-battle-info">
          <span class="reason">{{ replay.map.map_display_name|default:replay.map_name|default:'Неизвестная карта' }}</span>
          <span class="reason">&nbsp;-&nbsp;</span>
          <span class="reason">{{ battle_type_label }}</span>
        </div>
        <div class="winner-team {{ battle_outcome.status_class }}">
          <span class="status">{{ battle_outcome.status_text }}</span>
          <div class="reason">{{ battle_outcome.reason_text }}</div>
        </div>

        <div class="battle-records" {% if battle_outcome.status_class == 'victory' %}{% webp_background 'style/images/wot/battleresults/linewin.png' %}{% endif %}>
          <div class="achievements" data-number="{{ achievements_count_in_badges }}">
            {% for ach in achievements_nonbattle %}
              <div>
                <img
                  src="{% static ach.image_big_with_rank %}"
                  alt="{{ ach.name }}"
                  title="&lt;div class='title'&gt;{{ ach.name|escape }}&lt;/div&gt;&lt;img src='{% static ach.image_big_with_rank %}' /&gt; {{ ach.description|default_if_none:''|escape }}{% if ach.condition %}&lt;div class='condition'&gt;{{ ach.condition|linebreaksbr|escape }}&lt;/div&gt;{% endif %}">
              </div>
            {% endfor %}

            {% if has_marks_on_gun %}
              <div class="marks-on-gun">
                {% if marks_image_url %}
                  {% if 'http' in marks_image_url %}
                    {# Внешний URL #}
                    <img
                      src="{{ marks_image_url }}"
                      alt="{{ marks_data.name }}"
                      title="&lt;div class='title'&gt;{{ marks_data.name|escape }}&lt;/div&gt;&lt;img src='{{ marks_image_url }}' style='width:80px!important;height:80px!important;'/&gt;&lt;div class='description'&gt;{{ marks_data.description|escape }}&lt;/div&gt;&lt;div class='stats'&gt;Процентиль урона: {{ damage_rating }}%&lt;/div&gt;{% if marks_data.general_condition %}&lt;div class='condition'&gt;{{ marks_data.general_condition|escape }}&lt;/div&gt;{% endif %}">
                  {% else %}
                    {# Локальный файл #}
                    <img
                      src="{% static marks_image_url %}"
                      alt="{{ marks_data.name }}"
                      title="&lt;div class='title'&gt;{{ marks_data.name|escape }}&lt;/div&gt;&lt;img src='{% static marks_image_url %}' style='width:80px!important;height:80px!important;'/&gt;&lt;div class='description'&gt;{{ marks_data.description|escape }}&lt;/div&gt;&lt;div class='stats'&gt;Процентиль урона: {{ damage_rating }}%&lt;/div&gt;{% if marks_data.general_condition %}&lt;div class='condition'&gt;{{ marks_data.general_condition|escape }}&lt;/div&gt;{% endif %}">
                  {% endif %}
                {% endif %}
              </div>
            {% endif %}

            {% if has_mastery %}
              <div class="mastery">
                <img
                  src="{% static mastery_image %}"
                  alt="{{ mastery_label }}"
                  title="&lt;div class='title'&gt;Знак классности «{{ mastery_label }}»&lt;/div&gt;&lt;img class='achi' src='{% static mastery_image %}' style='width:67px!important;height:71px!important;' alt='{{ mastery_label }}'/&gt;Присваивается игроку за мастерство владения&lt;/&gt;боевой машиной. Для присвоения необходимо&lt;/&gt;заработать больше опыта за бой, чем средний&lt;/&gt;максимальный опыт за предыдущие 7 дней&lt;/&gt;у игроков на данной машине.">
              </div>
            {% endif %}
          </div>

          <div class="income {% if personal_data.crystal %}bond{% endif %}">
            <div class="credit">
              <span class="count">{{ personal_data.credits|intcomma }}</span>
              {% webp_image 'style/images/wot/library/CreditsIconBig.png' 'Credits' %}
            </div>
            <div class="xp">
              <span class="count">{{ personal_data.xp|intcomma }}</span>
              {% webp_image 'style/images/wot/library/XpIconBig.png' 'XP' %}
            </div>
            {% if personal_data.crystal %}
                <div class="bond">
                    <span class="count">{{ personal_data.crystal|intcomma }}</span>
                    {% webp_image 'style/images/wot/library/crystal_16x16.png' 'Bond' %}
                </div>
            {% endif %}
          </div>

          <div class="dossier" data-number="{{ achievements_battle_count }}">
            {% for ach in achievements_battle %}
              <div class="achi-img-cont">
                <img
                  src="{% static ach.image_big_with_rank %}"
                  alt="{{ ach.name }}"
                  title="&lt;div class='title'&gt;{{ ach.name|escape }}&lt;/div&gt;&lt;img src='{% static ach.image_big_with_rank %} '/&gt; {{ ach.description|default_if_none:''|escape }}{% if ach.condition %}&lt;div class='condition'&gt;{{ ach.condition|linebreaksbr|escape }}&lt;/div&gt;{% endif %}">
              </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <div style="background:#14120e; display:flex;">
        <div class="half">
          <div class="map-stat">
            {% if replay.map %}
                <picture>
                    <source srcset="{% static 'style/images/wot/map/stats/' %}{{ replay.map.map_name }}.webp" type="image/webp">
                    <img src="{% static 'style/images/wot/map/stats/' %}{{ replay.map.map_name }}.png" alt="{{ replay.map.map_display_name|default:replay.map.map_name }}" class="map">
                </picture>
            {% else %}
                {% webp_image 'maps/map_placeholder.jpg' 'Неизвестная карта' class='map' %}
            {% endif %}
            <div class="stat">
                <div style="display: flex">
                  <div class="stat-tank" >
                    <picture>
                        <source srcset="{% static 'style/images/wot/shop/vehicles/180x135/' %}{{ replay.tank.vehicleId }}.webp" type="image/webp">
                        <img src="{% static 'style/images/wot/shop/vehicles/180x135/' %}{{ replay.tank.vehicleId }}.png" alt="{{ replay.tank.name }}" class="tank new">
                    </picture>
                    <span class="name ">"{{ replay.tank.name }}"</span>
                    <picture>
                        <source srcset="{% static 'style/images/wot/vehicleTypes/' %}{{ replay.tank.type }}.webp" type="image/webp">
                        <img src="{% static 'style/images/wot/vehicleTypes/' %}{{ replay.tank.type }}.png" alt="" class="type">
                    </picture>
                    <picture>
                        <source srcset="{% static 'style/images/wot/levels/tank_level_' %}{{ replay.tank.level }}.webp" type="image/webp">
                        <img src="{% static 'style/images/wot/levels/tank_level_' %}{{ replay.tank.level }}.png" alt="" class="level">
                    </picture>
                  </div>

                  <div class="stat-text" >
                    <div class="name">
                      {{ details.playerName }}
                      {% if details.clanAbbrev %} [{{ details.clanAbbrev }}]{% endif %}
                    </div>
                    {{ replay.battle_date }}
                    <div class="death-reason">{{ death_reason_text }}</div>
                  </div>
                </div>

              <div class="income">
                <table>
                  <tbody>
                  <tr class="premium-row">
                    <td class="desc"></td>
                    <td class="inactive">Базовый аккаунт</td>
                    <td class="active premium">Танковый премиум</td>
                  </tr>

                  <tr>
                    <td class="desc">Серебро</td>
                    <td class="inactive">
                      <span>{{ income.credits_base|default:0|intcomma }}</span>
                      {% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}
                    </td>
                    <td class="active">
                      <span>{{ income.credits_premium|default:0|intcomma }}</span>
                      {% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}
                    </td>
                  </tr>

                  {% if income.is_first_win %}
                  <tr>
                    <td class="desc">Опыт<br>Награда за первую победу в день (x{{ detailed_report.economics.multipliers.daily }})</td>
                    <td class="inactive">
                      {{ income.xp_with_first_base|default:0|intcomma }}
                      {% webp_image 'style/images/wot/library/XpIcon.png' 'XP' class='xp' %}
                    </td>
                    <td class="active">
                      {{ income.xp_with_first_premium|default:0|intcomma }}
                      {% webp_image 'style/images/wot/library/XpIcon.png' 'XP' class='xp' %}
                    </td>
                  </tr>
                  {% endif %}

                  <tr>
                    <td class="desc">Опыт</td>
                    <td class="inactive">
                      {{ income.xp_base|default:0|intcomma }}
                      {% webp_image 'style/images/wot/library/XpIcon.png' 'XP' class='xp' %}
                    </td>
                    <td class="active">
                      {{ income.xp_premium|default:0|intcomma }}
                      {% webp_image 'style/images/wot/library/XpIcon.png' 'XP' class='xp' %}
                    </td>
                  </tr>

                  <tr class="no-border">
                    <td class="desc">Процент попаданий</td>
                    <td>{{ income.hits }}/{{ income.shots }}</td>
                    <td>{{ income.hit_percent|floatformat:2 }}%</td>
                  </tr>

                  <tr class="no-border">
                    <td class="desc"></td>
                    <td><span style="color:#6183a6;">{{ income.assist_total|default:0|intcomma }}</span></td>
                    <td><span style="color:#d9aa66;">{{ income.damage_total|default:0|intcomma }}</span></td>
                  </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="clearfix">&nbsp;</div>
          </div>
        </div>

        <div class="half" style="padding-bottom:15px;">

          <div class="hit-list">
            <table>
              <tbody>
              <tr class="title">
                <td class="table-title" style="width: 147.5px; max-width: 147.5px; text-align: padding-right: 5px; line-height: 28px; color: #bcbdbe; font-weight: bold; text-shadow: 1px 1px 2px #000; padding-top: 3px;">Игрок</td>
                <td class="table-title" style="width: 153px; max-width: 153px; padding-left: 5px; line-height: 28px; color: #bcbdbe; font-weight: bold; text-shadow: 1px 1px 2px #000; padding-top: 3px;">Техника</td>

                <td class="spotted summary-header" style="width: 33px; max-width: 33px; text-align: center;" title="Обнаружение&lt;br&gt;Количество танков противника, которых вы обнаружили">
                  {{ interactions_summary.spotted_tanks }}
                </td>

                <td class="assits summary-header" style="width: 33px; max-width: 33px; text-align: center;" title="Урон по засвету&lt;br&gt;Суммарный урон по целям, обнаруженным или оглушённым вами">
                  {{ detailed_report.battle_stats.assist_total }}
                </td>

                <td class="assits summary-header" style="width: 33px; max-width: 33px; text-align: center;" title="Заблокированный урон&lt;br&gt;Урон, заблокированный бронёй вашего танка">
                  {{ detailed_report.battle_stats.damage_blocked }}
                </td>

                <td class="crits summary-header" style="width: 33px; max-width: 33px; text-align: center;" title="Критические попадания&lt;br&gt;Количество критов по модулям и экипажу">
                  {{ interactions_summary.crits_total }}
                </td>

                <td class="damage summary-header" style="width: 33px; max-width: 33px; text-align: center;" title="Нанесённый урон&lt;br&gt;Суммарный урон по всем целям">
                  {{ interactions_summary.piercings_total }}
                </td>

                <td class="kill summary-header" style="width: 34px; max-width: 34px; text-align: center;" title="Уничтожение&lt;br&gt;Количество уничтоженных вами танков">
                  {{ interactions_summary.destroyed_tanks }}
                </td>
              </tr>
              </tbody>
            </table>
          </div>

          <div class="hit-list">
            <table style="width:100%;">
              <tbody>
              {% for row in interaction_rows %}
              <tr class="row {% if row.destroyed %}dead{% endif %}">
                <td class="name" {% if row.destroyed %}{% webp_background 'style/images/wot/battleresults/hit-list-bg-dead.png' %}{% else %}{% webp_background 'style/images/wot/battleresults/hit-list-bg.png' %}{% endif %}>{{ row.name }}</td>
                <td class="vehicle" {% if row.destroyed %}{% webp_background 'style/images/wot/battleresults/hit-list-bg-dead.png' %}{% else %}{% webp_background 'style/images/wot/battleresults/hit-list-bg.png' %}{% endif %}>
                  {% if row.vehicle_img %}
                    <picture>
                      <source srcset="{% static row.vehicle_img|slice:':-4' %}.webp" type="image/webp">
                      <img class="tank new" src="{% static row.vehicle_img %}" alt="{{ row.vehicle_name }}">
                    </picture>
                  {% endif %}
                  <span>{{ row.vehicle_name }}</span>
                </td>
                <td class="spotted" {% if row.destroyed %}{% webp_background 'style/images/wot/battleresults/hit-list-bg-dead.png' %}{% else %}{% webp_background 'style/images/wot/battleresults/hit-list-bg.png' %}{% endif %}>
                  <picture>
                    <source srcset="{% static 'style/images/wot/battleresults/battleResults-19.webp' %}" type="image/webp">
                    <img {% if not row.spotted %}style="opacity:0.1;"{% endif %}
                         src="{% static 'style/images/wot/battleresults/battleResults-19.png' %}">
                  </picture>
                </td>
                <td class="assist" {% if row.destroyed %}{% webp_background 'style/images/wot/battleresults/hit-list-bg-dead.png' %}{% else %}{% webp_background 'style/images/wot/battleresults/hit-list-bg.png' %}{% endif %}>
                  <picture>
                    <source srcset="{% static 'style/images/wot/battleresults/battleResults-25.webp' %}" type="image/webp">
                    <img {% if not row.assist %}style="opacity:0.1;"{% endif %}
                         src="{% static 'style/images/wot/battleresults/battleResults-25.png' %}"
                         class="interaction-icon"
                         title="Урон по засвету: {% if row.assist_value %}{{ row.assist_value|intcomma }}{% else %}0{% endif %}">
                  </picture>
                </td>
                <td class="assist" {% if row.destroyed %}{% webp_background 'style/images/wot/battleresults/hit-list-bg-dead.png' %}{% else %}{% webp_background 'style/images/wot/battleresults/hit-list-bg.png' %}{% endif %}>
                  <picture>
                    <source srcset="{% static 'style/images/wot/battleresults/teamStatsComponents-12.webp' %}" type="image/webp">
                    <img class="bigger interaction-icon" {% if not row.blocked %}style="opacity:0.1;"{% endif %}
                         src="{% static 'style/images/wot/battleresults/teamStatsComponents-12.png' %}"
                         title="Урон, заблокированный бронёй: {% if row.blocked_damage %}{{ row.blocked_damage|intcomma }}{% else %}0{% endif %}">
                  </picture>
                </td>
                <td class="crits" {% if row.destroyed %}{% webp_background 'style/images/wot/battleresults/hit-list-bg-dead.png' %}{% else %}{% webp_background 'style/images/wot/battleresults/hit-list-bg.png' %}{% endif %}>
                  <picture>
                    <source srcset="{% static 'style/images/wot/battleresults/battleResults-21.webp' %}" type="image/webp">
                    <img {% if not row.crits %}style="opacity:0.1;"{% endif %}
                         src="{% static 'style/images/wot/battleresults/battleResults-21.png' %}">
                  </picture>
                  {% if row.crits_count %}<div class="info">{{ row.crits_count }}</div>{% endif %}
                </td>
                <td class="damage" {% if row.destroyed %}{% webp_background 'style/images/wot/battleresults/hit-list-bg-dead.png' %}{% else %}{% webp_background 'style/images/wot/battleresults/hit-list-bg.png' %}{% endif %}>
                  <picture>
                    <source srcset="{% static 'style/images/wot/battleresults/battleResults-20.webp' %}" type="image/webp">
                    <img {% if not row.damaged %}style="opacity:0.1;"{% endif %}
                         src="{% static 'style/images/wot/battleresults/battleResults-20.png' %}"
                         class="interaction-icon"
                         title="Нанесённый урон: {% if row.damage_dealt %}{{ row.damage_dealt|intcomma }}{% else %}0{% endif %}">
                  </picture>
                  {% if row.damage_piercings %}<div class="info">{{ row.damage_piercings }}</div>{% endif %}
                </td>
                <td class="kill" {% if row.destroyed %}{% webp_background 'style/images/wot/battleresults/hit-list-bg-dead.png' %}{% else %}{% webp_background 'style/images/wot/battleresults/hit-list-bg.png' %}{% endif %}>
                  <picture>
                    <source srcset="{% static 'style/images/wot/battleresults/battleResults-23.webp' %}" type="image/webp">
                    <img {% if not row.destroyed %}style="opacity:0.1;"{% endif %}
                         src="{% static 'style/images/wot/battleresults/battleResults-23.png' %}">
                  </picture>
                </td>
              </tr>
              <tr class="space"></tr>
              {% empty %}
              <tr>
                <td colspan="8" class="text-center text-muted">Нет взаимодействий</td>
              </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div> <!-- /map + interactions -->
    </div> <!-- /tab-personal -->

    <!-- TAB: Командный результат -->
    <div class="replay-tab-wrapper" id="tab-team">
      <div class="team-score">
        <!-- Союзники -->
        <div class="half score">
          <div class="team-name">{{ team_results.allies_name }}</div>

          {% for player in team_results.allies_players %}
          <div class="personal-data" data-player="{{ player.avatar_id }}">
            <div class="header {% if not player.is_alive %}dead{% endif %}" {% if player.is_alive %}{% webp_background 'style/images/wot/battleresults/hit-list-bg.png' %}{% else %}{% webp_background 'style/images/wot/battleresults/hit-list-bg-dead.png' %}{% endif %}>
              <div class="tank">
                <picture>
                  <source srcset="{% static 'style/images/wot/shop/vehicles/180x135/' %}{{ player.vehicle_tag }}.webp" type="image/webp">
                  <img class="tank new" src="{% static 'style/images/wot/shop/vehicles/180x135/' %}{{ player.vehicle_tag }}.png" alt="{{ player.vehicle_display_name }}" loading="lazy">
                </picture>
                <picture>
                  <source srcset="{% static 'style/images/wot/vehicleTypes/' %}{{ player.tank_type }}.webp" type="image/webp">
                  <img class="type" src="{% static 'style/images/wot/vehicleTypes/' %}{{ player.tank_type }}.png" alt="" loading="lazy">
                </picture>
                <picture>
                  <source srcset="{% static 'style/images/wot/levels/tank_level_' %}{{ player.tank_level }}.webp" type="image/webp">
                  <img class="level" src="{% static 'style/images/wot/levels/tank_level_' %}{{ player.tank_level }}.png" alt="" loading="lazy">
                </picture>
              </div>
              <div class="info">
                <div class="name">
                  <a href="profile/{{ player.avatar_id }}/{{ player.player_name }}" target="_blank">{{ player.display_name }}</a>
                </div>
                <span>{{ player.vehicle_display_name }}</span>
                <div>{{ player.death_text }}</div>
              </div>
            </div>

            {% if player.medals.medals_list %}
            <div class="medals">
              {% for medal in player.medals.medals_list %}
              <img src="{% static medal.image_big %}"
                   alt="{{ medal.name }}"
                   title="&lt;div class='title'&gt;{{ medal.name|escape }}&lt;/div&gt;&lt;img src='{% static medal.image_big %}'/&gt;{{ medal.description|default_if_none:''|escape }}{% if medal.condition %}&lt;div class='condition'&gt;{{ medal.condition|linebreaksbr|escape }}&lt;/div&gt;{% endif %}">
              {% endfor %}
            </div>
            {% endif %}

            <div class="data-wrapper">
              <div class="row">Произведено выстрелов<span class="right">{{ player.shots }}</span></div>
              <div class="row padding"> прямых попаданий/пробитий<span class="right">{{ player.direct_hits }}/{{ player.piercings }}</span></div>
              <div class="row padding"> осколочно-фугасных повреждений<span class="right">{{ player.explosion_hits }}</span></div>
              <div class="row">Нанесение урона<span class="right">{{ player.damage_dealt|floatformat:0 }}</span></div>
              <div class="row padding"> с дистанции свыше 300 м<span class="right">{{ player.sniper_damage|floatformat:0 }}</span></div>
              <div class="row">Получено попаданий<span class="right">{{ player.hits_received }}</span></div>
              <div class="row padding"> пробитий<span class="right">{{ player.piercings_received }}</span></div>
              <div class="row padding"> не нанёсших урон<span class="right">{{ player.no_damage_hits_received }}</span></div>
              <div class="row">Получено попаданий осколками<span class="right">{{ player.explosion_hits_received }}</span></div>
              <div class="row">Урон, заблокированный бронёй<span class="right">{{ player.damage_blocked|floatformat:0 }}</span></div>
              <div class="row">Урон союзникам (уничтожено/повреждений)<span class="right">{{ player.team_kills }}/{{ player.team_damage|floatformat:0 }}</span></div>
              <div class="row">Обнаружено машин противника<span class="right">{{ player.spotted }}</span></div>
              <div class="row">Повреждено/уничтожено машин противника<span class="right">{{ player.damaged_count }}/{{ player.kills }}</span></div>
              <div class="row">Урон, нанесённый с помощью данного игрока<span class="right">{{ player.assist_damage|floatformat:0 }}</span></div>
              {% if player.stun_damage > 0 %}
              <div class="row"><span class="left">Урон по оглушённым вами целям</span><span class="right">{{ player.stun_damage|floatformat:0 }}</span></div>
              <div class="row"><span class="left">Нанесено оглушений</span><span class="right">{{ player.stun_count }}</span></div>
              {% endif %}
              <div class="row">Очки захвата/защиты базы<span class="right">{{ player.capture_points }}/{{ player.defense_points }}</span></div>
              <div class="row">Пройдено километров<span class="right">{{ player.distance }}</span></div>
            </div>
            <div class="close">Закрыть</div>
          </div>
          {% endfor %}

          <div class="dataTables_wrapper no-footer">
            <table class="tank-list score dataTable no-footer">
              <thead>
              <tr>
                <th class="player-platoon" data-sort-key="platoon" data-sort-type="number"><div>&nbsp;</div></th>
                <th class="player-names" data-sort-key="player" data-sort-type="string"><div>&nbsp;</div></th>
                <th class="tanks-name" data-sort-key="vehicle" data-sort-type="string"><div>&nbsp;</div></th>
                <th class="damage sorting_desc" data-sort-key="damage" data-sort-type="number" data-sort-default="desc"><div>&nbsp;</div></th>
                <th class="kills" data-sort-key="kills" data-sort-type="number"><div>&nbsp;</div></th>
                <th class="xp" data-sort-key="xp" data-sort-type="number"><div>&nbsp;</div></th>
              </tr>
              </thead>
              <tbody>
              {% for player in team_results.allies_players %}
              <tr{% if player.is_current_player or not player.is_alive %} class="{% if player.is_current_player %}current-player{% endif %}{% if player.is_current_player and not player.is_alive %} {% endif %}{% if not player.is_alive %}dead{% endif %}"{% endif %} data-player="{{ player.avatar_id }}">
                <td class="player-platoon" data-sort-value="{{ player.platoon_id|default_if_none:'' }}">{% if player.platoon_id %}<div class="number{% if player.is_own_platoon %} own-platoon{% endif %}">{{ player.platoon_id }}</div>{% endif %}</td>
                <td class="player-names" data-sort-value="{{ player.display_name|default_if_none:'' }}">{{ player.display_name }}</td>
                <td class="tanks-name" data-sort-value="{{ player.vehicle_display_name|default_if_none:'' }}">
                  <picture>
                    <source srcset="{% static 'style/images/wot/shop/vehicles/180x135/' %}{{ player.vehicle_tag }}.webp" type="image/webp">
                    <img class="tank new" src="{% static 'style/images/wot/shop/vehicles/180x135/' %}{{ player.vehicle_tag }}.png" alt="" loading="lazy">
                  </picture>
                  <span>{{ player.vehicle_display_name }}</span>
                  {% if player.medals.has_medals %}
                  <div class="medal" title="{{ player.medals.title|safe }}">
                    {% if player.medals.count > 1 %}<div class="num">{{ player.medals.count }}</div>{% endif %}
                  </div>
                  {% endif %}
                </td>
                <td class="damage sorting_1" data-sort-value="{{ player.damage_dealt|default_if_none:0 }}">{{ player.damage_dealt|floatformat:0 }}</td>
                <td class="kills" data-sort-value="{{ player.kills|default_if_none:0 }}">{{ player.kills }}</td>
                <td class="xp" data-sort-value="{{ player.xp|default_if_none:0 }}">{{ player.xp }} {% webp_image 'style/images/wot/library/XpIcon.png' 'XP' class='xp' %}</td>
              </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Противники -->
        <div class="half score">
          <div class="team-name">{{ team_results.enemies_name }}</div>

          {% for player in team_results.enemies_players %}
          <div class="personal-data left" data-player="{{ player.avatar_id }}">
            <div class="header {% if not player.is_alive %}dead{% endif %}" {% if player.is_alive %}{% webp_background 'style/images/wot/battleresults/hit-list-bg.png' %}{% else %}{% webp_background 'style/images/wot/battleresults/hit-list-bg-dead.png' %}{% endif %}>
              <div class="tank">
                <picture>
                  <source srcset="{% static 'style/images/wot/shop/vehicles/180x135/' %}{{ player.vehicle_tag }}.webp" type="image/webp">
                  <img class="tank new" src="{% static 'style/images/wot/shop/vehicles/180x135/' %}{{ player.vehicle_tag }}.png" alt="{{ player.vehicle_display_name }}" loading="lazy">
                </picture>
                <picture>
                  <source srcset="{% static 'style/images/wot/vehicleTypes/' %}{{ player.tank_type }}.webp" type="image/webp">
                  <img class="type" src="{% static 'style/images/wot/vehicleTypes/' %}{{ player.tank_type }}.png" alt="" loading="lazy">
                </picture>
                <picture>
                  <source srcset="{% static 'style/images/wot/levels/tank_level_' %}{{ player.tank_level }}.webp" type="image/webp">
                  <img class="level" src="{% static 'style/images/wot/levels/tank_level_' %}{{ player.tank_level }}.png" alt="" loading="lazy">
                </picture>
              </div>
              <div class="info">
                <div class="name">
                  <a href="profile/{{ player.avatar_id }}/{{ player.player_name }}" target="_blank">{{ player.display_name }}</a>
                </div>
                <span>{{ player.vehicle_display_name }}</span>
                {% if player.medals.has_medals %}
                <div class="medal" title="{{ player.medals.title|safe }}">
                  {% if player.medals.count > 1 %}<div class="num">{{ player.medals.count }}</div>{% endif %}
                </div>
                {% endif %}
                <div>{{ player.death_text }}</div>
              </div>
            </div>

            {% if player.medals.medals_list %}
            <div class="medals">
              {% for medal in player.medals.medals_list %}
              <img src="{% static medal.image_big %}"
                   alt="{{ medal.name }}"
                   title="&lt;div class='title'&gt;{{ medal.name|escape }}&lt;/div&gt;&lt;img src='{% static medal.image_big %}'/&gt;{{ medal.description|default_if_none:''|escape }}{% if medal.condition %}&lt;div class='condition'&gt;{{ medal.condition|linebreaksbr|escape }}&lt;/div&gt;{% endif %}">
              {% endfor %}
            </div>
            {% endif %}

            <div class="data-wrapper">
              <div class="row">Произведено выстрелов<span class="right">{{ player.shots }}</span></div>
              <div class="row padding"> прямых попаданий/пробитий<span class="right">{{ player.direct_hits }}/{{ player.piercings }}</span></div>
              <div class="row padding"> осколочно-фугасных повреждений<span class="right">{{ player.explosion_hits }}</span></div>
              <div class="row">Нанесение урона<span class="right">{{ player.damage_dealt|floatformat:0 }}</span></div>
              <div class="row padding"> с дистанции свыше 300 м<span class="right">{{ player.sniper_damage|floatformat:0 }}</span></div>
              <div class="row">Получено попаданий<span class="right">{{ player.hits_received }}</span></div>
              <div class="row padding"> пробитий<span class="right">{{ player.piercings_received }}</span></div>
              <div class="row padding"> не нанёсших урон<span class="right">{{ player.no_damage_hits_received }}</span></div>
              <div class="row">Получено попаданий осколками<span class="right">{{ player.explosion_hits_received }}</span></div>
              <div class="row">Урон, заблокированный бронёй<span class="right">{{ player.damage_blocked|floatformat:0 }}</span></div>
              <div class="row">Урон союзникам (уничтожено/повреждений)<span class="right">{{ player.team_kills }}/{{ player.team_damage|floatformat:0 }}</span></div>
              <div class="row">Обнаружено машин противника<span class="right">{{ player.spotted }}</span></div>
              <div class="row">Повреждено/уничтожено машин противника<span class="right">{{ player.damaged_count }}/{{ player.kills }}</span></div>
              <div class="row">Урон, нанесённый с помощью данного игрока<span class="right">{{ player.assist_damage|floatformat:0 }}</span></div>
              {% if player.stun_damage > 0 %}
              <div class="row"><span class="left">Урон по оглушённым вами целям</span><span class="right">{{ player.stun_damage|floatformat:0 }}</span></div>
              <div class="row"><span class="left">Нанесено оглушений</span><span class="right">{{ player.stun_count }}</span></div>
              {% endif %}
              <div class="row">Очки захвата/защиты базы<span class="right">{{ player.capture_points }}/{{ player.defense_points }}</span></div>
              <div class="row">Пройдено километров<span class="right">{{ player.distance }}</span></div>
            </div>
            <div class="close">Закрыть</div>
          </div>
          {% endfor %}

          <div class="dataTables_wrapper no-footer">
            <table class="tank-list score dataTable no-footer">
              <thead>
              <tr>
                <th class="player-platoon" data-sort-key="platoon" data-sort-type="number"><div>&nbsp;</div></th>
                <th class="player-names" data-sort-key="player" data-sort-type="string"><div>&nbsp;</div></th>
                <th class="tanks-name" data-sort-key="vehicle" data-sort-type="string"><div>&nbsp;</div></th>
                <th class="damage sorting_desc" data-sort-key="damage" data-sort-type="number" data-sort-default="desc"><div>&nbsp;</div></th>
                <th class="kills" data-sort-key="kills" data-sort-type="number"><div>&nbsp;</div></th>
                <th class="xp" data-sort-key="xp" data-sort-type="number"><div>&nbsp;</div></th>
              </tr>
              </thead>
              <tbody>
              {% for player in team_results.enemies_players %}
              <tr{% if not player.is_alive %} class="dead"{% endif %} data-player="{{ player.avatar_id }}">
                <td class="player-platoon" data-sort-value="{{ player.platoon_id|default_if_none:'' }}">{% if player.platoon_id %}<div class="number{% if player.is_own_platoon %} own-platoon{% endif %}">{{ player.platoon_id }}</div>{% endif %}</td>
                <td class="player-names" data-sort-value="{{ player.display_name|default_if_none:'' }}">{{ player.display_name }}</td>
                <td class="tanks-name" data-sort-value="{{ player.vehicle_display_name|default_if_none:'' }}">
                  <picture>
                    <source srcset="{% static 'style/images/wot/shop/vehicles/180x135/' %}{{ player.vehicle_tag }}.webp" type="image/webp">
                    <img class="tank new" src="{% static 'style/images/wot/shop/vehicles/180x135/' %}{{ player.vehicle_tag }}.png" alt="" loading="lazy">
                  </picture>
                  <span>{{ player.vehicle_display_name }}</span>
                  {% if player.medals.has_medals %}
                  <div class="medal" title="{{ player.medals.title|safe }}">
                    {% if player.medals.count > 1 %}<div class="num">{{ player.medals.count }}</div>{% endif %}
                  </div>
                  {% endif %}
                </td>
                <td class="damage sorting_1" data-sort-value="{{ player.damage_dealt|default_if_none:0 }}">{{ player.damage_dealt|floatformat:0 }}</td>
                <td class="kills" data-sort-value="{{ player.kills|default_if_none:0 }}">{{ player.kills }}</td>
                <td class="xp" data-sort-value="{{ player.xp|default_if_none:0 }}">{{ player.xp }} {% webp_image 'style/images/wot/library/XpIcon.png' 'XP' class='xp' %}</td>
              </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div> <!-- /team-score -->
    </div> <!-- /tab-team -->

    <!-- TAB: Подробный отчёт -->
    <div class="replay-tab-wrapper" id="tab-detailed">
      <div class="personal-data tab">
        <div class="titles-line">
          <span>Статистика</span>
          <span class="credit">Кредиты</span>
          <span class="base {% if not detailed_report.economics.is_premium %}active{% else %}inactive{% endif %}">Базовый аккаунт</span>
          <span class="premium {% if detailed_report.economics.is_premium %}active{% else %}inactive{% endif %}">Танковый премиум</span>
        </div>

        <!-- Две колонки -->
        <div class="columns grid-2">
          <!-- СТАТИСТИКА -->
          <div class="col-left">
            <div class="data-wrapper stat">
              <div class="row"><span class="left">Произведено выстрелов</span><span class="right">{{ detailed_report.battle_stats.shots }}</span></div>
              <div class="row padding"><span class="left">прямых попаданий/пробитий</span><span class="right">{{ detailed_report.battle_stats.direct_hits }}/{{ detailed_report.battle_stats.piercings }}</span></div>
              <div class="row padding"><span class="left">осколочно-фугасных повреждений</span><span class="right">{{ detailed_report.battle_stats.explosion_hits }}</span></div>
              <div class="row"><span class="left">Нанесение урона</span><span class="right">{{ detailed_report.battle_stats.damage_dealt|intcomma }}</span></div>
              <div class="row padding"><span class="left">с дистанции свыше 300 м</span><span class="right">{{ detailed_report.battle_stats.sniper_damage|intcomma }}</span></div>
              <div class="row"><span class="left">Получено попаданий</span><span class="right">{{ detailed_report.battle_stats.hits_received }}</span></div>
              <div class="row padding"><span class="left">пробитий</span><span class="right">{{ detailed_report.battle_stats.piercings_received }}</span></div>
              <div class="row padding"><span class="left">не нанёсших урон</span><span class="right">{{ detailed_report.battle_stats.no_damage_hits_received }}</span></div>
              <div class="row"><span class="left">Получено попаданий осколками</span><span class="right">{{ detailed_report.battle_stats.explosion_hits_received }}</span></div>
              <div class="row"><span class="left">Урон, заблокированный бронёй</span><span class="right">{{ detailed_report.battle_stats.damage_blocked|intcomma }}</span></div>
              <div class="row">
                <span class="left">Урон союзникам (уничтожено/повреждений)</span>
                <span class="right{% if detailed_report.battle_stats.team_damage > 0 %} red{% endif %}">{{ detailed_report.battle_stats.team_kills }}/{{ detailed_report.battle_stats.team_damage|intcomma }}</span>
              </div>
              <div class="row"><span class="left">Обнаружено машин противника</span><span class="right">{{ detailed_report.battle_stats.spotted }}</span></div>
              <div class="row"><span class="left">Повреждено/уничтожено машин противника</span><span class="right">{{ detailed_report.battle_stats.damaged_count }}/{{ detailed_report.battle_stats.kills }}</span></div>
              <div class="row"><span class="left">Урон, нанесённый с помощью данного игрока</span><span class="right">{{ detailed_report.battle_stats.assist_total|intcomma }}</span></div>
              {% if detailed_report.battle_stats.stun_damage > 0 %}
              <div class="row"><span class="left">Урон по оглушённым вами целям</span><span class="right">{{ detailed_report.battle_stats.stun_damage|intcomma }}</span></div>
              <div class="row"><span class="left">Нанесено оглушений</span><span class="right">{{ detailed_report.battle_stats.stun_count }}</span></div>
              {% endif %}
              <div class="row"><span class="left">Очки захвата/защиты базы</span><span class="right">{{ detailed_report.battle_stats.capture_points }}/{{ detailed_report.battle_stats.defense_points }}</span></div>
              <div class="row"><span class="left">Пройдено километров</span><span class="right">{{ detailed_report.battle_stats.distance }}</span></div>
            </div>
          </div>

          <!-- КРЕДИТЫ + БОНЫ -->
          <div class="col-right">
            <div class="data-wrapper credit normal {% if not detailed_report.economics.is_premium %}active{% else %}inactive{% endif %}" style="margin-left: 0px !important;">
  <div class="row"><span class="left">Начислено за бой</span><span class="right">{{ detailed_report.credits.base.accrued|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>

  {% if detailed_report.credits.base.order_credits > 0 %}
    <div class="row"><span class="left">Боевые выплаты</span><span class="right">{{ detailed_report.credits.base.order_credits|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>
  {% endif %}

  {% if detailed_report.credits.base.booster_effect > 0 %}
    <div class="row"><span class="left">Эффект от личных резервов</span><span class="right">{{ detailed_report.credits.base.booster_effect|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>
  {% endif %}

  {% if detailed_report.credits.event_credits > 0 or detailed_report.gold.base.event_income > 0 %}
    <div class="row {% if detailed_report.gold.base.event_income > 0 %}gold{% endif %}">
      <span class="left">Бонус за боевые задачи и события</span><span class="right">{{ detailed_report.credits.event_credits|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}
      {% if detailed_report.gold.base.event_income > 0 %}<span class="gold">{{ detailed_report.gold.base.event_income|intcomma }}{% webp_image 'style/images/wot/library/GoldIcon.png' 'Gold' class='credit' %}</span>{% endif %}
    </span></div>
  {% endif %}

  {% if detailed_report.credits.base.team_subs_bonus > 0 %}
    <div class="row"><span class="left">Командный бонус от игроков с подпиской</span><span class="right">{{ detailed_report.credits.base.team_subs_bonus|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>
  {% endif %}

  {% if detailed_report.credits.base.achievement > 0 %}
    <div class="row"><span class="left">За достойное сопротивление</span><span class="right">{{ detailed_report.credits.base.achievement|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>
  {% endif %}

  <div class="row top"><span class="left">Штраф за урон союзникам</span><span class="right">{{ detailed_report.credits.base.team_damage_penalty|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>
  <div class="row"><span class="left">Компенсация за урон от союзников</span><span class="right">{{ detailed_report.credits.base.team_damage_compensation|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>

  <div class="row top {% if detailed_report.gold.base.total_for_battle > 0 %}gold{% endif %}">
    <span class="left">Итого за бой:</span><span class="right">{{ detailed_report.credits.base.total_for_battle|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}
      {% if detailed_report.gold.base.total_for_battle > 0 %}<span class="gold">{{ detailed_report.gold.base.total_for_battle|intcomma }}{% webp_image 'style/images/wot/library/GoldIcon.png' 'Gold' class='credit' %}</span>{% endif %}
    </span></div>

  <div class="row top"><span class="left">Автоматический ремонт техники</span><span class="right red">-{{ detailed_report.credits.costs.auto_repair|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>
  <div class="row"><span class="left">Автопополнение боекомплекта</span><span class="right red">-{{ detailed_report.credits.costs.auto_ammo|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>

  {% if detailed_report.credits.costs.auto_equipment > 0 or detailed_report.gold.base.total_for_battle > 0 %}
    <div class="row"><span class="left">Автопополнение снаряжения</span><span class="right red">-{{ detailed_report.credits.costs.auto_equipment|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>

  {% endif %}

  <div class="row top gold" >
    <span class="left">Итого:</span>
    <span class="right {% if detailed_report.credits.base.after_costs < 0 %}red{% endif %}">{{ detailed_report.credits.base.after_costs|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}
      <span class="gold">{{ detailed_report.gold.base.total_for_battle|default:0|intcomma }}{% webp_image 'style/images/wot/library/GoldIcon.png' 'Gold' class='credit' %}</span>
    </span>
  </div>
</div>

   <div class="data-wrapper credit premium {% if detailed_report.economics.is_premium %}active{% else %}inactive{% endif %}">
  <div class="row">&nbsp;<span class="right">{{ detailed_report.credits.premium.accrued|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>

  {% if detailed_report.credits.premium.order_credits > 0 %}
    <div class="row">&nbsp;<span class="right">{{ detailed_report.credits.premium.order_credits|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>
  {% endif %}

  {% if detailed_report.credits.premium.booster_effect > 0 %}
    <div class="row">&nbsp;<span class="right">{{ detailed_report.credits.premium.booster_effect|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>
  {% endif %}

  {% if detailed_report.credits.event_credits > 0 or detailed_report.gold.base.event_income > 0 %}
    <div class="row {% if detailed_report.gold.base.event_income > 0 %}gold{% endif %}">&nbsp;
      <span class="right">{{ detailed_report.credits.event_credits|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}
      {% if detailed_report.gold.base.event_income > 0 %}<span class="gold">{{ detailed_report.gold.base.event_income|intcomma }}{% webp_image 'style/images/wot/library/GoldIcon.png' 'Gold' class='credit' %}</span>{% endif %}
    </span></div>
  {% endif %}

  {% if detailed_report.credits.premium.team_subs_bonus > 0 %}
    <div class="row">&nbsp;<span class="right">{{ detailed_report.credits.premium.team_subs_bonus|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>
  {% endif %}

  {% if detailed_report.credits.premium.achievement > 0 %}
    <div class="row">&nbsp;<span class="right">{{ detailed_report.credits.premium.achievement|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>
  {% endif %}

  <div class="row top">&nbsp;<span class="right">{{ detailed_report.credits.premium.team_damage_penalty|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>
  <div class="row">&nbsp;<span class="right">{{ detailed_report.credits.premium.team_damage_compensation|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>

  <div class="row top {% if detailed_report.gold.base.total_for_battle > 0 %}gold{% endif %}">&nbsp;
    <span class="right">{{ detailed_report.credits.premium.total_for_battle|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}
      {% if detailed_report.gold.base.total_for_battle > 0 %}<span class="gold">{{ detailed_report.gold.base.total_for_battle|intcomma }}{% webp_image 'style/images/wot/library/GoldIcon.png' 'Gold' class='credit' %}</span>{% endif %}
    </span></div>

  <div class="row top">&nbsp;<span class="right red">-{{ detailed_report.credits.costs.auto_repair|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>
  <div class="row">&nbsp;<span class="right red">-{{ detailed_report.credits.costs.auto_ammo|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>

  {% if detailed_report.credits.costs.auto_equipment > 0 or detailed_report.gold.base.total_for_battle > 0 %}
    <div class="row">&nbsp;<span class="right red">-{{ detailed_report.credits.costs.auto_equipment|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>

  {% endif %}

  <div class="row top gold">
    &nbsp;<span class="right {% if detailed_report.credits.premium.after_costs < 0 %}red{% endif %}">{{ detailed_report.credits.premium.after_costs|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}
      <span class="gold">{{ detailed_report.gold.base.total_for_battle|default:0|intcomma }}{% webp_image 'style/images/wot/library/GoldIcon.png' 'Gold' class='credit' %}</span>
    </span>
  </div>
</div>

            <div class="data-wrapper bonds">
                {% if detailed_report.economics.total_crystal > 0 %}
                  <div class="titles-line"><span>Боны</span></div>
                      <div class="data-wrapper">
                        {% if detailed_report.economics.achievement_crystal > 0 %}
                            <div class="row"><span class="left">За достижения</span><span class="right">{{ detailed_report.economics.achievement_crystal }}{% webp_image 'style/images/wot/library/crystal_16x16.png' '' class='credit' %}</span></div>
                        {% endif %}
                        {% if detailed_report.economics.event_crystal > 0 %}
                            <div class="row"><span class="left">За выполнение задач</span><span class="right">{{ detailed_report.economics.event_crystal }}{% webp_image 'style/images/wot/library/crystal_16x16.png' '' class='credit' %}</span></div>
                        {% endif %}
                        {% if detailed_report.economics.special_vehicle_crystal > 0 %}
                            <div class="row"><span class="left">За особые свойства машины</span><span class="right">{{ detailed_report.economics.special_vehicle_crystal }}{% webp_image 'style/images/wot/library/crystal_16x16.png' '' class='credit' %}</span></div>
                        {% endif %}
                        <div class="row top"><span class="left">Итого:</span><span class="right">{{ detailed_report.economics.total_crystal }}{% webp_image 'style/images/wot/library/crystal_16x16.png' '' class='credit' %}</span></div>
                      </div>
                {% endif %}
            </div>
          </div> <!-- /col-right -->
        </div> <!-- /columns -->

        <div class="clearfix"></div>

        <div class="titles-line second">Время<span>Опыт</span></div>
        <div class="data-wrapper time">
          <div class="row">Начало боя<span class="right">{{ detailed_report.time_stats.battle_start_formatted }}</span></div>
          <div class="row">Продолжительность боя<span class="right">{{ detailed_report.time_stats.battle_duration_formatted }}</span></div>
          <div class="row">Время в бою до уничтожения<span class="right">{{ detailed_report.time_stats.lifetime_formatted }}</span></div>
        </div>

        <div class="data-wrapper xp normal {% if not detailed_report.economics.is_premium %}active{% else %}inactive{% endif %}">
          <div class="row bonus">
            <span class="left">Начислено за бой</span>
            <span class="right">
              {{ detailed_report.xp.base.accrued|intcomma }}{% webp_image 'style/images/wot/library/XpIcon.png' 'XP' class='credit' %}
              <span class="bonus">{{ detailed_report.xp.base.free_accrued|intcomma }}{% webp_image 'style/images/wot/library/FreeXpIcon-1.png' 'FreeXP' class='credit' %}</span>
            </span>
          </div>
        </div>


      <div class="data-wrapper xp premium {% if detailed_report.economics.is_premium %}active{% else %}inactive{% endif %}">
          <div class="row bonus" style="height:20px;">

            <span class="right">
              {{ detailed_report.xp.premium.accrued|intcomma }}{% webp_image 'style/images/wot/library/XpIcon.png' 'XP' class='credit' %}
              <span class="bonus">{{ detailed_report.xp.premium.free_accrued|intcomma }}{% webp_image 'style/images/wot/library/FreeXpIcon-1.png' 'FreeXP' class='credit' %}</span>
            </span>
          </div>
        </div>

      </div> <!-- /personal-data tab -->
    </div> <!-- /tab-detailed -->
        <!-- Stats container -->
        <div class="replay-stats-container" style="display: inline-block; margin-right: 20px; vertical-align: middle;">
          <div style="display: inline-flex; align-items: center; gap: 12px;">
            <!-- Like button -->
            {% if user.is_authenticated %}
              <button id="like-button" class="like-btn {% if user_has_liked %}liked{% endif %}" data-replay-id="{{ replay.id }}">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="{% if user_has_liked %}#ff4458{% else %}none{% endif %}" stroke="{% if user_has_liked %}#ff4458{% else %}#888{% endif %}" stroke-width="2">
                  <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                </svg>
                <span id="likes-count">{{ likes_count }}</span>
              </button>
            {% else %}
              <span class="like-btn disabled" title="Войдите, чтобы поставить лайк">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#888" stroke-width="2">
                  <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                </svg>
                <span>{{ likes_count }}</span>
              </span>
            {% endif %}

            <!-- Comments -->
            {% get_comment_count for replay as comment_count %}
            <span class="stat-item" style="display: inline-flex; align-items: center; gap: 4px; color: #888; font-size: 13px;">
              <i class="far fa-comments" style="font-size: 16px;"></i>
              <span>{{ comment_count|default:"0" }}</span>
            </span>

            <!-- Views -->
            <span class="stat-item" style="display: inline-flex; align-items: center; gap: 4px; color: #888; font-size: 13px;">
              <i class="far fa-eye" style="font-size: 16px;"></i>
              <span>{{ replay.view_count|intcomma }}</span>
            </span>

            <!-- Downloads -->
            <span class="stat-item" style="display: inline-flex; align-items: center; gap: 4px; color: #888; font-size: 13px;">
              <i class="fas fa-download" style="font-size: 16px;"></i>
              <span>{{ replay.download_count|intcomma }}</span>
            </span>
          </div>
        </div>
        <div class="right down-info">
          <span class="gray">Сервер:</span>{{ details.serverName }}
          <span class="gray">Режим боя:</span>{{ details.battleModeLabel }}
          <span class="gray">Текущая версия:</span>{{ details.clientVersion }}
          <span class="gray">Отправитель:</span>{{ details.playerName }}
            {% if replay.user %}
                <span class="gray">Загрузил:</span>{{ replay.user.username }}
            {% endif %}
        </div>
  </div> <!-- /replay-wrapper -->

  <div class="card" style="margin-top: 0.5rem; background: #14120e; padding: 20px; border-radius: 5px;">
    <div class="card-body">
                {% if replay.short_description %}
                    <div class="title text-lg font-semibold text-white" style="margin-bottom: 2rem;">{{ replay.short_description }}</div>
                {% else %}
                    <div class="title text-lg font-semibold text-white" style="margin-bottom: 2rem;">
                        {{ replay.tank.name|default:'Неизвестный танк' }} • {{ replay.map.map_display_name|default:replay.map_name|default:'Неизвестная карта' }}
                    </div>
                {% endif %}
      <h2 class="card-title" style="color: #c3c3c3; margin-bottom: 1rem; font-size: 1.75rem; font-weight: bold; margin-top: 1.5rem;">Комментарии</h2>
      <hr style="border-color: #333;"/>

      <div class="comment-form-wrapper" style="margin-top: 1.5rem;">
        {% if user.is_authenticated %}
          {% custom_render_comment_form replay %}
        {% else %}
          <p style="color: #ccc;">
            Пожалуйста, <a href="{% url 'account_login' %}?next={{ request.path|urlencode }}">войдите в аккаунт</a>
            или <a href="{% url 'account_signup' %}?next={{ request.path|urlencode }}">зарегистрируйтесь</a>,
            чтобы оставлять комментарии.
          </p>
        {% endif %}
      </div>

      <div class="comment-list-wrapper" style="margin-top: 2rem;">
        {% render_comment_list for replay %}
      </div>
    </div>
  </div>

{% endif %}

<!-- Tabs init -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const tabs = document.querySelectorAll('.replay-tabs .tab');
  const tabContents = document.querySelectorAll('.replay-tab-wrapper');

  function switchTab(targetTab) {
    tabs.forEach(tab => tab.classList.remove('active'));
    tabContents.forEach(content => content.classList.remove('active'));
    const activeTab = document.querySelector(`[data-tab="${targetTab}"]`);
    const activeContent = document.getElementById(`tab-${targetTab}`);
    if (activeTab && activeContent) {
      activeTab.classList.add('active');
      activeContent.classList.add('active');
    }
  }

  tabs.forEach(tab => {
    tab.addEventListener('click', function () {
      const targetTab = this.getAttribute('data-tab');
      switchTab(targetTab);
    });
  });

  initTeamScoreSorting();
  initDownloadButton();
  initShareButton();
  initPlayerDataToggle();
});

function initDownloadButton() {
  const downloadBtn = document.getElementById('download-replay-btn');
  if (!downloadBtn) return;

  downloadBtn.addEventListener('click', function(e) {
    e.preventDefault();

    const isAuthenticated = downloadBtn.dataset.authenticated === 'true';

    if (!isAuthenticated) {
      if (confirm('Для скачивания реплеев необходимо авторизоваться. Перейти на страницу входа?')) {
        window.location.href = '{% url "account_login" %}?next={{ request.path|urlencode }}';
      }
      return;
    }

    // Если авторизован, открываем ссылку для скачивания
    const downloadUrl = downloadBtn.dataset.downloadUrl;
    if (downloadUrl) {
      window.open(downloadUrl, '_blank');
    }
  });
}

function initShareButton() {
  const shareBtn = document.getElementById('share-replay-btn');
  if (!shareBtn) return;

  shareBtn.addEventListener('click', async function(e) {
    e.preventDefault();

    // Формируем чистый URL без GET-параметров
    const cleanUrl = window.location.origin + window.location.pathname;

    try {
      // Пробуем использовать современный Clipboard API
      await navigator.clipboard.writeText(cleanUrl);

      // Показываем уведомление об успехе
      const originalText = shareBtn.textContent;
      shareBtn.textContent = 'Скопировано!';
      shareBtn.style.background = '#2d7a4f'; // Приглушенный зелёный

      setTimeout(() => {
        shareBtn.textContent = originalText;
        shareBtn.style.background = '#4a5568'; // Возвращаем серо-синий
      }, 2000);

    } catch (err) {
      // Fallback для старых браузеров
      const textArea = document.createElement('textarea');
      textArea.value = cleanUrl;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();

      try {
        document.execCommand('copy');

        const originalText = shareBtn.textContent;
        shareBtn.textContent = 'Скопировано!';
        shareBtn.style.background = '#2d7a4f';

        setTimeout(() => {
          shareBtn.textContent = originalText;
          shareBtn.style.background = '#4a5568';
        }, 2000);

      } catch (err) {
        alert('Не удалось скопировать ссылку');
      }

      document.body.removeChild(textArea);
    }
  });
}

function initTeamScoreSorting() {
  const tables = document.querySelectorAll('#tab-team table.tank-list');

  tables.forEach(table => {
    const allHeaders = Array.from(table.querySelectorAll('th'));
    const sortableHeaders = allHeaders.filter(header => header.dataset.sortType);
    const tbody = table.querySelector('tbody');
    if (!tbody || !sortableHeaders.length) {
      return;
    }

    const initialRows = Array.from(tbody.querySelectorAll('tr'));
    applyStripe(initialRows);

    const defaultHeader = sortableHeaders.find(header => header.classList.contains('sorting_desc') || header.classList.contains('sorting_asc'));
    if (defaultHeader) {
      const defaultIndex = allHeaders.indexOf(defaultHeader);
      if (defaultIndex >= 0) {
        const defaultDirection = defaultHeader.classList.contains('sorting_desc') ? 'desc' : 'asc';
        defaultHeader.dataset.sortDirection = defaultDirection;
        defaultHeader.classList.add('sorting_1');
        updateColumnHighlight(table, defaultIndex);

        // Применяем начальную сортировку по убыванию
        const rows = Array.from(tbody.querySelectorAll('tr'));
        rows.sort((rowA, rowB) => {
          const sortType = defaultHeader.dataset.sortType || 'string';
          const valueA = getCellValue(rowA.children[defaultIndex], sortType);
          const valueB = getCellValue(rowB.children[defaultIndex], sortType);
          if (valueA < valueB) {
            return defaultDirection === 'asc' ? -1 : 1;
          }
          if (valueA > valueB) {
            return defaultDirection === 'asc' ? 1 : -1;
          }
          return 0;
        });
        rows.forEach(row => tbody.appendChild(row));
        applyStripe(rows);
      }
    } else if (sortableHeaders[0]) {
      const fallbackIndex = allHeaders.indexOf(sortableHeaders[0]);
      sortableHeaders[0].classList.add('sorting_1');
      if (fallbackIndex >= 0) {
        updateColumnHighlight(table, fallbackIndex);
      }
    }

    sortableHeaders.forEach(header => {
      header.addEventListener('click', () => {
        const columnIndex = allHeaders.indexOf(header);
        if (columnIndex < 0) {
          return;
        }

        const sortType = header.dataset.sortType || 'string';
        // Если колонка еще не имеет направления сортировки, начинаем с убывания
        // Иначе переключаем направление
        const currentDirection = header.dataset.sortDirection;
        let nextDirection;
        if (!currentDirection) {
          nextDirection = 'desc'; // Первый клик всегда сортирует по убыванию
        } else {
          nextDirection = currentDirection === 'asc' ? 'desc' : 'asc';
        }

        sortableHeaders.forEach(otherHeader => {
          otherHeader.classList.remove('sorting_asc', 'sorting_desc', 'sorting_1');
          delete otherHeader.dataset.sortDirection;
        });

        const rows = Array.from(tbody.querySelectorAll('tr'));
        rows.sort((rowA, rowB) => {
          const valueA = getCellValue(rowA.children[columnIndex], sortType);
          const valueB = getCellValue(rowB.children[columnIndex], sortType);
          if (valueA < valueB) {
            return nextDirection === 'asc' ? -1 : 1;
          }
          if (valueA > valueB) {
            return nextDirection === 'asc' ? 1 : -1;
          }
          return 0;
        });

        rows.forEach(row => tbody.appendChild(row));
        applyStripe(rows);
        updateColumnHighlight(table, columnIndex);

        header.classList.add(nextDirection === 'asc' ? 'sorting_asc' : 'sorting_desc', 'sorting_1');
        header.dataset.sortDirection = nextDirection;
      });
    });
  });

  function getCellValue(cell, sortType) {
    if (!cell) {
      return sortType === 'number' ? 0 : '';
    }
    const raw = (cell.getAttribute('data-sort-value') ?? cell.textContent ?? '').toString().trim();
    if (sortType === 'number') {
      const normalized = raw.replace(/\s+/g, '').replace(',', '.');
      const num = parseFloat(normalized);
      return Number.isNaN(num) ? 0 : num;
    }
    return raw.toLowerCase();
  }

  function applyStripe(rows) {
    rows.forEach((row, index) => {
      row.classList.remove('odd', 'even');
      row.classList.add(index % 2 === 0 ? 'odd' : 'even');
    });
  }

  function updateColumnHighlight(tableElement, columnIndex) {
    const bodyRows = tableElement.querySelectorAll('tbody tr');
    bodyRows.forEach(row => {
      Array.from(row.children).forEach((cell, idx) => {
        if (idx === columnIndex) {
          cell.classList.add('sorting_1');
        } else {
          cell.classList.remove('sorting_1');
        }
      });
    });
  }
}

function initPlayerDataToggle() {
  // Получаем все строки игроков в таблице командного результата
  const playerRows = document.querySelectorAll('#tab-team table.tank-list tbody tr[data-player]');

  playerRows.forEach(row => {
    // Делаем строку кликабельной
    row.style.cursor = 'pointer';

    row.addEventListener('click', function(e) {
      // Игнорируем клики по ссылкам внутри строки
      if (e.target.tagName === 'A') return;

      const playerId = this.getAttribute('data-player');
      if (!playerId) return;

      // Находим соответствующий блок personal-data
      const personalDataBlock = document.querySelector(`.personal-data[data-player="${playerId}"]`);
      if (!personalDataBlock) return;

      // Проверяем, открыто ли уже это окно
      const isAlreadyOpen = personalDataBlock.classList.contains('active');

      // Закрываем все открытые окна
      const allPersonalData = document.querySelectorAll('.personal-data.active');
      allPersonalData.forEach(block => block.classList.remove('active'));

      // Если окно не было открыто, открываем его
      if (!isAlreadyOpen) {
        personalDataBlock.classList.add('active');
      }

      // Реинициализируем тултипы для медалей в открытом окне
      if (personalDataBlock.classList.contains('active') && window.jQuery && window.jQuery.ui) {
        setTimeout(() => {
          const medalImgs = personalDataBlock.querySelectorAll('.medals img');
          medalImgs.forEach(img => {
            const title = img.getAttribute('title');
            if (title) {
              window.jQuery(img).attr('data-title', title);
              img.removeAttribute('title');
            }
          });
        }, 50);
      }
    });
  });

  // Обработчик для кнопок "Закрыть" внутри personal-data
  const closeButtons = document.querySelectorAll('.personal-data .close');
  closeButtons.forEach(button => {
    button.style.cursor = 'pointer';
    button.addEventListener('click', function(e) {
      e.stopPropagation(); // Предотвращаем всплытие события
      const personalDataBlock = this.closest('.personal-data');
      if (personalDataBlock) {
        personalDataBlock.classList.remove('active');
      }
    });
  });

  // Закрытие по клику вне области personal-data
  document.addEventListener('click', function(e) {
    // Если клик не внутри personal-data и не на строке игрока
    if (!e.target.closest('.personal-data') && !e.target.closest('table.tank-list tbody tr[data-player]')) {
      const activeBlocks = document.querySelectorAll('.personal-data.active');
      activeBlocks.forEach(block => block.classList.remove('active'));
    }
  });
}
</script>

<!-- jQuery UI tooltips init (использует title с HTML-сущностями) -->
<script>
(function () {
  function decodeHtml(s) {
    if (!s) return "";
    var ta = document.createElement("textarea");
    ta.innerHTML = s;
    var decoded = ta.value;
    // Конвертируем \n в <br> для переносов строк
    decoded = decoded.replace(/\\n/g, '<br>');
    // Конвертируем множественные пробелы в начале строк в &nbsp; для сохранения отступов
    decoded = decoded.replace(/(<br>)([ ]{2,})/g, function(match, br, spaces) {
      return br + spaces.replace(/ /g, '&nbsp;');
    });
    // Обрабатываем отступы в начале текста
    decoded = decoded.replace(/^([ ]{2,})/g, function(match, spaces) {
      return spaces.replace(/ /g, '&nbsp;');
    });
    return decoded;
  }

  function initAchiTooltips() {
    if (!window.jQuery) { console.warn("jQuery не загружен - тултипы не инициализированы"); return; }
    if (!$.ui || !$.ui.tooltip) { console.warn("jQuery UI Tooltip не загружен - тултипы не инициализированы"); return; }

    var selector = ".achievements img, .dossier img, .tank-list .medal, .personal-data .medals img, .interaction-icon, .summary-header";

    $(selector).each(function () {
      var $el = $(this);
      var t = $el.attr("title");
      if (t) {
        $el.attr("data-title", t);
        $el.removeAttr("title");
      }
    });

    $(document).tooltip({
      items: selector,
      content: function () {
        var $el = $(this);
        var raw = $el.attr("data-title") || "";
        var html = decodeHtml(raw);
        return html || "";
      },
      position: { my: "left+12 center", at: "right center", collision: "flipfit" },
      show: { effect: "fade", duration: 120 },
      hide: { effect: "fade", duration: 80 },
      track: false,
      classes: { "ui-tooltip": "achi-tooltip" },
      tooltipClass: "achi-tooltip"
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initAchiTooltips);
  } else {
    initAchiTooltips();
  }
})();
</script>

<script>
// Обработка лайков
(function() {
  const likeButton = document.getElementById('like-button');

  if (!likeButton) {
    return; // Кнопка отсутствует (пользователь не авторизован)
  }

  likeButton.addEventListener('click', function() {
    const replayId = this.dataset.replayId;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;

    // Если нет CSRF токена в форме комментариев, получаем из cookie
    const token = csrfToken || getCookie('csrftoken');

    fetch(`/replays/${replayId}/vote/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': token
      }
    })
    .then(response => response.json())
    .then(data => {
      // Обновляем счетчик
      document.getElementById('likes-count').textContent = data.likes_count;

      // Обновляем визуальное состояние кнопки
      const svg = likeButton.querySelector('svg');
      if (data.liked) {
        likeButton.classList.add('liked');
        svg.setAttribute('fill', '#ff4458');
        svg.setAttribute('stroke', '#ff4458');
      } else {
        likeButton.classList.remove('liked');
        svg.setAttribute('fill', 'none');
        svg.setAttribute('stroke', '#888');
      }
    })
    .catch(error => {
      console.error('Ошибка при обработке лайка:', error);
      alert('Произошла ошибка. Пожалуйста, попробуйте позже.');
    });
  });

  // Функция для получения cookie
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
})();
</script>

{% endblock %}
