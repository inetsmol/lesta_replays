{# replays/templates/replays/detail.html #}
{% extends "base.html" %}
{% load static humanize %}
{% load comments_xtd comments custom_comments_tags %}
{% load webp_tags %}

{% block title %}–†–µ–ø–ª–µ–π #{{ replay.id }} - {{ replay_data.player_name }}{% endblock %}
{% block meta_description %}
  {{ replay.short_description|default:"–ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—è: –∫–∞—Ä—Ç–∞, —Ç–µ—Ö–Ω–∏–∫–∞, —É—Ä–æ–Ω, –∞—Å—Å–∏—Å—Ç, —Ñ—Ä–∞–≥–∏."|truncatechars:160 }}
{% endblock %}
{% block canonical_url %}{{ request.build_absolute_uri }}{% endblock %}
{% block body_class %}replays detail{% endblock %}
{% block content_mod %}content--solo{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/replay-detail.css' %}">

{% if show_anti_abuse_banner %}
<div id="anti-abuse-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); z-index: 9999; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(8px);">
    <div class="anti-abuse-modal" style="background: #1f1f1f; padding: 40px; border-radius: 12px; border: 1px solid #ff4458; text-align: center; max-width: 600px; box-shadow: 0 0 30px rgba(255, 68, 88, 0.4); position: relative; overflow: hidden;">
        
        <!-- Background Glow -->
        <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,68,88,0.1) 0%, rgba(0,0,0,0) 70%); z-index: 0; pointer-events: none;"></div>
        
        <div style="position: relative; z-index: 1;">
            <div style="margin-bottom: 20px;">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="#ff4458" style="display: inline-block;">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                </svg>
            </div>

            <h2 style="color: #ff4458; margin-bottom: 15px; font-size: 28px; font-weight: bold;">–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h2>
            <p style="color: #ddd; margin-bottom: 25px; font-size: 16px; line-height: 1.6;">
                –í—ã —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É. –ù–∞–∫—Ä—É—Ç–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ —Å–æ–∑–¥–∞–µ—Ç –ª–∏—à–Ω—é—é –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä.
            </p>

            <div style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 20px; margin-bottom: 30px;">
                <p style="color: #fff; font-size: 18px; margin-bottom: 15px; font-weight: 500;">
                    –õ—É—á—à–µ –ø–æ–¥–¥–µ—Ä–∂–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç! üöÄ
                </p>
                <p style="color: #b0b0b0; font-size: 14px; margin-bottom: 20px;">
                    –í–º–µ—Å—Ç–æ –Ω–∞–∫—Ä—É—Ç–∫–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤, –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–º–æ—á—å —Å–µ—Ä–≤–µ—Ä—É —Ä–∞–±–æ—Ç–∞—Ç—å –±—ã—Å—Ç—Ä–µ–µ –∏ —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ. –ö–∞–∂–¥—ã–µ 100 ‚ÇΩ —É—Å–∫–æ—Ä—è—é—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É –∏ –æ–ø–ª–∞—á–∏–≤–∞—é—Ç —Ö–æ—Å—Ç–∏–Ω–≥.
                </p>
                
                <div style="display: flex; flex-direction: column; gap: 20px; align-items: center; width: 100%;">
                    
                    <!-- YooMoney iframe -->
                    <div style="width: 100%; display: flex; justify-content: center;">
                      <iframe
                        src="https://yoomoney.ru/quickpay/fundraise/button?billNumber=1D58232QB73.251002&"
                        width="220"
                        height="50"
                        frameborder="0"
                        allowtransparency="true"
                        scrolling="no"
                        style="max-width: 100%;"
                        class="rounded-lg shadow-lg">
                      </iframe>
                    </div>

                    <!-- T-Bank Button from sidebar -->
                    <a
                        href="https://www.tinkoff.ru/rm/r_QOueoIJBoY.BitHUDZPXL/7F9Zp34216"
                        target="_blank"
                        rel="noopener"
                        class="group relative w-full flex items-center justify-center gap-2 px-6 py-3.5 rounded-lg font-semibold text-white overflow-hidden transition-all duration-300 hover:scale-105 hover:shadow-2xl active:scale-95"
                        style="max-width: 250px;"> <!-- added max-width to match iframe roughly -->

                        <!-- Gradient -->
                        <div class="absolute inset-0 bg-gradient-to-r from-amber-500 via-orange-500 to-yellow-500"></div>

                        <!-- Glare -->
                        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent translate-x-[-200%] group-hover:translate-x-[200%] transition-transform duration-700"></div>

                        <!-- Glow -->
                        <div class="absolute inset-0 bg-yellow-400 blur-xl opacity-50 group-hover:opacity-70 transition-opacity animate-pulse"></div>

                        <!-- Content -->
                        <span class="relative z-10 flex items-center gap-2">
                          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" class="group-hover:rotate-90 transition-transform duration-300">
                            <path d="M12 3C7.03 3 3 7.03 3 12s4.03 9 9 9 9-4.03 9-9-4.03-9-9-9zm1 5v3h3v2h-3v3h-2v-3H8v-2h3V8h2z"/>
                          </svg>
                          <span class="text-base">–¢-–ë–∞–Ω–∫ –¥–æ–Ω–∞—Ç</span>
                        </span>
                    </a>
                </div>
            </div>

            <p style="color: #888; font-size: 14px; margin-bottom: 5px;">–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–Ω–∏–º–µ—Ç—Å—è —á–µ—Ä–µ–∑:</p>
            <div style="font-size: 36px; font-weight: bold; color: #fff; font-variant-numeric: tabular-nums;" id="abuse-timer">60</div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        let timeLeft = 60;
        const timerElement = document.getElementById('abuse-timer');
        const overlay = document.getElementById('anti-abuse-overlay');
        
        // Prevent scrolling
        document.body.style.overflow = 'hidden';
        
        const interval = setInterval(function() {
            timeLeft--;
            timerElement.innerText = timeLeft;
            
            if (timeLeft <= 0) {
                clearInterval(interval);
                overlay.style.display = 'none';
                document.body.style.overflow = '';
            }
        }, 1000);
    });
</script>
{% endif %}

{% if parse_error %}
  <div class="card error">
    <h2>–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–ø–ª–µ—è</h2>
    <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞ —Ä–µ–ø–ª–µ—è: {{ parse_error }}</p>
    <a href="{{ back_url }}" class="btn btn--ghost">‚Üê –ö —Å–ø–∏—Å–∫—É —Ä–µ–ø–ª–µ–µ–≤</a>
  </div>
{% else %}

  <div class="replay-wrapper">
    <div class="replay-tabs">
      <a href="{{ back_url }}" class="btn btn--ghost" style="margin-right:12px;">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
      <div class="tab active" data-tab="personal">–õ–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
      <div class="tab" data-tab="team">–ö–æ–º–∞–Ω–¥–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
      <div class="tab" data-tab="detailed">–ü–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á—ë—Ç</div>
    </div>

    <div class="right-ajax">
      <div class="replay-download" style="display: flex; gap: 10px;">
        <button id="download-replay-btn"
                type="button"
                class="big-red-button"
                data-authenticated="{{ user.is_authenticated|lower }}"
                data-download-url="{% url 'replay_download' replay.pk %}"
                style="display: flex; align-items: center; justify-content: center;">
          –°–∫–∞—á–∞—Ç—å
        </button>
        <button id="share-replay-btn"
                type="button"
                class="big-red-button"
                style="background: #4a5568; padding: 10px 20px; display: flex; align-items: center; justify-content: center;"
                title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ —Ä–µ–ø–ª–µ–π –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞">
          –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
        </button>
      </div>
    </div>

    <!-- TAB: –õ–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç -->
    <div class="replay-tab-wrapper active" id="tab-personal">
      <div class="tanks-image {% if battle_outcome.status_class == 'victory' %}win{% else %}{{ battle_outcome.status_class }}{% endif %}" {% if battle_outcome.status_class == 'victory' %}{% webp_background 'style/images/wot/battleresults/win.png' %}{% endif %}>
        <div class="map-battle-info">
          <span class="reason">{{ replay.map.map_display_name|default:replay.map_name|default:'–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞' }}</span>
          <span class="reason">&nbsp;-&nbsp;</span>
          <span class="reason">{{ battle_type_label }}</span>
        </div>
        <div class="winner-team {{ battle_outcome.status_class }}">
          <span class="status">{{ battle_outcome.status_text }}</span>
          <div class="reason">{{ battle_outcome.reason_text }}</div>
        </div>

        <div class="battle-records" {% if battle_outcome.status_class == 'victory' %}{% webp_background 'style/images/wot/battleresults/linewin.png' %}{% endif %}>
          <div class="achievements" data-number="{{ achievements_count_in_badges }}">
            {% for ach in achievements_nonbattle %}
              <div>
                <img
                  src="{% static ach.image_big_with_rank %}"
                  alt="{{ ach.name }}"
                  title="&lt;div class='title'&gt;{{ ach.name|escape }}&lt;/div&gt;&lt;img src='{% static ach.image_big_with_rank %}' /&gt; {{ ach.description|default_if_none:''|escape }}{% if ach.condition %}&lt;div class='condition'&gt;{{ ach.condition|linebreaksbr|escape }}&lt;/div&gt;{% endif %}">
              </div>
            {% endfor %}

            {% if has_marks_on_gun %}
              <div class="marks-on-gun">
                {% if marks_image_url %}
                  {% if 'http' in marks_image_url %}
                    {# –í–Ω–µ—à–Ω–∏–π URL #}
                    <img
                      src="{{ marks_image_url }}"
                      alt="{{ marks_data.name }}"
                      title="&lt;div class='title'&gt;{{ marks_data.name|escape }}&lt;/div&gt;&lt;img src='{{ marks_image_url }}' style='width:80px!important;height:80px!important;'/&gt;&lt;div class='description'&gt;{{ marks_data.description|escape }}&lt;/div&gt;&lt;div class='stats'&gt;–ü—Ä–æ—Ü–µ–Ω—Ç–∏–ª—å —É—Ä–æ–Ω–∞: {{ damage_rating }}%&lt;/div&gt;{% if marks_data.general_condition %}&lt;div class='condition'&gt;{{ marks_data.general_condition|escape }}&lt;/div&gt;{% endif %}">
                  {% else %}
                    {# –õ–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª #}
                    <img
                      src="{% static marks_image_url %}"
                      alt="{{ marks_data.name }}"
                      title="&lt;div class='title'&gt;{{ marks_data.name|escape }}&lt;/div&gt;&lt;img src='{% static marks_image_url %}' style='width:80px!important;height:80px!important;'/&gt;&lt;div class='description'&gt;{{ marks_data.description|escape }}&lt;/div&gt;&lt;div class='stats'&gt;–ü—Ä–æ—Ü–µ–Ω—Ç–∏–ª—å —É—Ä–æ–Ω–∞: {{ damage_rating }}%&lt;/div&gt;{% if marks_data.general_condition %}&lt;div class='condition'&gt;{{ marks_data.general_condition|escape }}&lt;/div&gt;{% endif %}">
                  {% endif %}
                {% endif %}
              </div>
            {% endif %}

            {% if has_mastery %}
              <div class="mastery">
                <img
                  src="{% static mastery_image %}"
                  alt="{{ mastery_label }}"
                  title="&lt;div class='title'&gt;–ó–Ω–∞–∫ –∫–ª–∞—Å—Å–Ω–æ—Å—Ç–∏ ¬´{{ mastery_label }}¬ª&lt;/div&gt;&lt;img class='achi' src='{% static mastery_image %}' style='width:67px!important;height:71px!important;' alt='{{ mastery_label }}'/&gt;–ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è –∏–≥—Ä–æ–∫—É –∑–∞ –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ –≤–ª–∞–¥–µ–Ω–∏—è&lt;/&gt;–±–æ–µ–≤–æ–π –º–∞—à–∏–Ω–æ–π. –î–ª—è –ø—Ä–∏—Å–≤–æ–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ&lt;/&gt;–∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å –±–æ–ª—å—à–µ –æ–ø—ã—Ç–∞ –∑–∞ –±–æ–π, —á–µ–º —Å—Ä–µ–¥–Ω–∏–π&lt;/&gt;–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –æ–ø—ã—Ç –∑–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ 7 –¥–Ω–µ–π&lt;/&gt;—É –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ –¥–∞–Ω–Ω–æ–π –º–∞—à–∏–Ω–µ.">
              </div>
            {% endif %}
          </div>

          <div class="income {% if personal_data.crystal %}bond{% endif %}">
            <div class="credit">
              <span class="count">{{ personal_data.credits|intcomma }}</span>
              {% webp_image 'style/images/wot/library/CreditsIconBig.png' 'Credits' %}
            </div>
            <div class="xp">
              <span class="count">{{ personal_data.xp|intcomma }}</span>
              {% webp_image 'style/images/wot/library/XpIconBig.png' 'XP' %}
            </div>
            {% if personal_data.crystal %}
                <div class="bond">
                    <span class="count">{{ personal_data.crystal|intcomma }}</span>
                    {% webp_image 'style/images/wot/library/crystal_16x16.png' 'Bond' %}
                </div>
            {% endif %}
          </div>

          <div class="dossier" data-number="{{ achievements_battle_count }}">
            {% for ach in achievements_battle %}
              <div class="achi-img-cont">
                <img
                  src="{% static ach.image_big_with_rank %}"
                  alt="{{ ach.name }}"
                  title="&lt;div class='title'&gt;{{ ach.name|escape }}&lt;/div&gt;&lt;img src='{% static ach.image_big_with_rank %} '/&gt; {{ ach.description|default_if_none:''|escape }}{% if ach.condition %}&lt;div class='condition'&gt;{{ ach.condition|linebreaksbr|escape }}&lt;/div&gt;{% endif %}">
              </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <div style="background:#14120e; display:flex;">
        <div class="half">
          <div class="map-stat">
            {% if replay.map %}
                <picture>
                    <source srcset="{% static 'style/images/wot/map/stats/' %}{{ replay.map.map_name }}.webp" type="image/webp">
                    <img src="{% static 'style/images/wot/map/stats/' %}{{ replay.map.map_name }}.png" alt="{{ replay.map.map_display_name|default:replay.map.map_name }}" class="map">
                </picture>
            {% else %}
                {% webp_image 'maps/map_placeholder.jpg' '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞' class='map' %}
            {% endif %}
            <div class="stat">
                <div style="display: flex">
                  <div class="stat-tank" >
                    <picture>
                        <source srcset="{% static 'style/images/wot/shop/vehicles/180x135/' %}{{ replay.tank.vehicleId }}.webp" type="image/webp">
                        <img src="{% static 'style/images/wot/shop/vehicles/180x135/' %}{{ replay.tank.vehicleId }}.png" alt="{{ replay.tank.name }}" class="tank new">
                    </picture>
                    <span class="name ">"{{ replay.tank.name }}"</span>
                    <picture>
                        <source srcset="{% static 'style/images/wot/vehicleTypes/' %}{{ replay.tank.type }}.webp" type="image/webp">
                        <img src="{% static 'style/images/wot/vehicleTypes/' %}{{ replay.tank.type }}.png" alt="" class="type">
                    </picture>
                    <picture>
                        <source srcset="{% static 'style/images/wot/levels/tank_level_' %}{{ replay.tank.level }}.webp" type="image/webp">
                        <img src="{% static 'style/images/wot/levels/tank_level_' %}{{ replay.tank.level }}.png" alt="" class="level">
                    </picture>
                  </div>

                  <div class="stat-text" >
                    <div class="name">
                      {{ details.playerName }}
                      {% if details.clanAbbrev %} [{{ details.clanAbbrev }}]{% endif %}
                    </div>
                    {{ replay.battle_date }}
                    <div class="death-reason">{{ death_reason_text }}</div>
                  </div>
                </div>

              <div class="income">
                <table>
                  <tbody>
                  <tr class="premium-row">
                    <td class="desc"></td>
                    <td class="inactive">–ë–∞–∑–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç</td>
                    <td class="active premium">–¢–∞–Ω–∫–æ–≤—ã–π –ø—Ä–µ–º–∏—É–º</td>
                  </tr>

                  <tr>
                    <td class="desc">–°–µ—Ä–µ–±—Ä–æ</td>
                    <td class="inactive">
                      <span>{{ income.credits_base|default:0|intcomma }}</span>
                      {% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}
                    </td>
                    <td class="active">
                      <span>{{ income.credits_premium|default:0|intcomma }}</span>
                      {% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}
                    </td>
                  </tr>

                  {% if income.is_first_win %}
                  <tr>
                    <td class="desc">–û–ø—ã—Ç<br>–ù–∞–≥—Ä–∞–¥–∞ –∑–∞ –ø–µ—Ä–≤—É—é –ø–æ–±–µ–¥—É –≤ –¥–µ–Ω—å (x{{ detailed_report.economics.multipliers.daily }})</td>
                    <td class="inactive">
                      {{ income.xp_with_first_base|default:0|intcomma }}
                      {% webp_image 'style/images/wot/library/XpIcon.png' 'XP' class='xp' %}
                    </td>
                    <td class="active">
                      {{ income.xp_with_first_premium|default:0|intcomma }}
                      {% webp_image 'style/images/wot/library/XpIcon.png' 'XP' class='xp' %}
                    </td>
                  </tr>
                  {% endif %}

                  <tr>
                    <td class="desc">–û–ø—ã—Ç</td>
                    <td class="inactive">
                      {{ income.xp_base|default:0|intcomma }}
                      {% webp_image 'style/images/wot/library/XpIcon.png' 'XP' class='xp' %}
                    </td>
                    <td class="active">
                      {{ income.xp_premium|default:0|intcomma }}
                      {% webp_image 'style/images/wot/library/XpIcon.png' 'XP' class='xp' %}
                    </td>
                  </tr>

                  <tr class="no-border">
                    <td class="desc">–ü—Ä–æ—Ü–µ–Ω—Ç –ø–æ–ø–∞–¥–∞–Ω–∏–π</td>
                    <td>{{ income.hits }}/{{ income.shots }}</td>
                    <td>{{ income.hit_percent|floatformat:2 }}%</td>
                  </tr>

                  <tr class="no-border">
                    <td class="desc"></td>
                    <td><span style="color:#6183a6;">{{ income.assist_total|default:0|intcomma }}</span></td>
                    <td><span style="color:#d9aa66;">{{ income.damage_total|default:0|intcomma }}</span></td>
                  </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="clearfix">&nbsp;</div>
          </div>
        </div>

        <div class="half" style="padding-bottom:15px;">

          <div class="hit-list">
            <table>
              <tbody>
              <tr class="title">
                <td class="table-title" style="width: 147.5px; max-width: 147.5px; text-align: padding-right: 5px; line-height: 28px; color: #bcbdbe; font-weight: bold; text-shadow: 1px 1px 2px #000; padding-top: 3px;">–ò–≥—Ä–æ–∫</td>
                <td class="table-title" style="width: 153px; max-width: 153px; padding-left: 5px; line-height: 28px; color: #bcbdbe; font-weight: bold; text-shadow: 1px 1px 2px #000; padding-top: 3px;">–¢–µ—Ö–Ω–∏–∫–∞</td>

                <td class="spotted summary-header" style="width: 33px; max-width: 33px; text-align: center;" title="–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ&lt;br&gt;–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∞–Ω–∫–æ–≤ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞, –∫–æ—Ç–æ—Ä—ã—Ö –≤—ã –æ–±–Ω–∞—Ä—É–∂–∏–ª–∏">
                  {{ interactions_summary.spotted_tanks }}
                </td>

                <td class="assits summary-header" style="width: 33px; max-width: 33px; text-align: center;" title="–£—Ä–æ–Ω –ø–æ –∑–∞—Å–≤–µ—Ç—É&lt;br&gt;–°—É–º–º–∞—Ä–Ω—ã–π —É—Ä–æ–Ω –ø–æ —Ü–µ–ª—è–º, –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–º –∏–ª–∏ –æ–≥–ª—É—à—ë–Ω–Ω—ã–º –≤–∞–º–∏">
                  {{ detailed_report.battle_stats.assist_total }}
                </td>

                <td class="assits summary-header" style="width: 33px; max-width: 33px; text-align: center;" title="–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —É—Ä–æ–Ω&lt;br&gt;–£—Ä–æ–Ω, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±—Ä–æ–Ω—ë–π –≤–∞—à–µ–≥–æ —Ç–∞–Ω–∫–∞">
                  {{ detailed_report.battle_stats.damage_blocked }}
                </td>

                <td class="crits summary-header" style="width: 33px; max-width: 33px; text-align: center;" title="–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–ø–∞–¥–∞–Ω–∏—è&lt;br&gt;–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫—Ä–∏—Ç–æ–≤ –ø–æ –º–æ–¥—É–ª—è–º –∏ —ç–∫–∏–ø–∞–∂—É">
                  {{ interactions_summary.crits_total }}
                </td>

                <td class="damage summary-header" style="width: 33px; max-width: 33px; text-align: center;" title="–ù–∞–Ω–µ—Å—ë–Ω–Ω—ã–π —É—Ä–æ–Ω&lt;br&gt;–°—É–º–º–∞—Ä–Ω—ã–π —É—Ä–æ–Ω –ø–æ –≤—Å–µ–º —Ü–µ–ª—è–º">
                  {{ interactions_summary.piercings_total }}
                </td>

                <td class="kill summary-header" style="width: 34px; max-width: 34px; text-align: center;" title="–£–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ&lt;br&gt;–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–Ω—ã—Ö –≤–∞–º–∏ —Ç–∞–Ω–∫–æ–≤">
                  {{ interactions_summary.destroyed_tanks }}
                </td>
              </tr>
              </tbody>
            </table>
          </div>

          <div class="hit-list">
            <table style="width:100%;">
              <tbody>
              {% for row in interaction_rows %}
              <tr class="row {% if row.destroyed %}dead{% endif %}">
                <td class="name" {% if row.destroyed %}{% webp_background 'style/images/wot/battleresults/hit-list-bg-dead.png' %}{% else %}{% webp_background 'style/images/wot/battleresults/hit-list-bg.png' %}{% endif %}>{{ row.name }}</td>
                <td class="vehicle" {% if row.destroyed %}{% webp_background 'style/images/wot/battleresults/hit-list-bg-dead.png' %}{% else %}{% webp_background 'style/images/wot/battleresults/hit-list-bg.png' %}{% endif %}>
                  {% if row.vehicle_img %}
                    <picture>
                      <source srcset="{% static row.vehicle_img|slice:':-4' %}.webp" type="image/webp">
                      <img class="tank new" src="{% static row.vehicle_img %}" alt="{{ row.vehicle_name }}">
                    </picture>
                  {% endif %}
                  <span>{{ row.vehicle_name }}</span>
                </td>
                <td class="spotted" {% if row.destroyed %}{% webp_background 'style/images/wot/battleresults/hit-list-bg-dead.png' %}{% else %}{% webp_background 'style/images/wot/battleresults/hit-list-bg.png' %}{% endif %}>
                  <picture>
                    <source srcset="{% static 'style/images/wot/battleresults/battleResults-19.webp' %}" type="image/webp">
                    <img {% if not row.spotted %}style="opacity:0.1;"{% endif %}
                         src="{% static 'style/images/wot/battleresults/battleResults-19.png' %}">
                  </picture>
                </td>
                <td class="assist" {% if row.destroyed %}{% webp_background 'style/images/wot/battleresults/hit-list-bg-dead.png' %}{% else %}{% webp_background 'style/images/wot/battleresults/hit-list-bg.png' %}{% endif %}>
                  <picture>
                    <source srcset="{% static 'style/images/wot/battleresults/battleResults-25.webp' %}" type="image/webp">
                    <img {% if not row.assist %}style="opacity:0.1;"{% endif %}
                         src="{% static 'style/images/wot/battleresults/battleResults-25.png' %}"
                         class="interaction-icon"
                         title="–£—Ä–æ–Ω –ø–æ –∑–∞—Å–≤–µ—Ç—É: {% if row.assist_value %}{{ row.assist_value|intcomma }}{% else %}0{% endif %}">
                  </picture>
                </td>
                <td class="assist" {% if row.destroyed %}{% webp_background 'style/images/wot/battleresults/hit-list-bg-dead.png' %}{% else %}{% webp_background 'style/images/wot/battleresults/hit-list-bg.png' %}{% endif %}>
                  <picture>
                    <source srcset="{% static 'style/images/wot/battleresults/teamStatsComponents-12.webp' %}" type="image/webp">
                    <img class="bigger interaction-icon" {% if not row.blocked %}style="opacity:0.1;"{% endif %}
                         src="{% static 'style/images/wot/battleresults/teamStatsComponents-12.png' %}"
                         title="–£—Ä–æ–Ω, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±—Ä–æ–Ω—ë–π: {% if row.blocked_damage %}{{ row.blocked_damage|intcomma }}{% else %}0{% endif %}">
                  </picture>
                </td>
                <td class="crits" {% if row.destroyed %}{% webp_background 'style/images/wot/battleresults/hit-list-bg-dead.png' %}{% else %}{% webp_background 'style/images/wot/battleresults/hit-list-bg.png' %}{% endif %}>
                  <picture>
                    <source srcset="{% static 'style/images/wot/battleresults/battleResults-21.webp' %}" type="image/webp">
                    <img {% if not row.crits %}style="opacity:0.1;"{% endif %}
                         src="{% static 'style/images/wot/battleresults/battleResults-21.png' %}">
                  </picture>
                  {% if row.crits_count %}<div class="info">{{ row.crits_count }}</div>{% endif %}
                </td>
                <td class="damage" {% if row.destroyed %}{% webp_background 'style/images/wot/battleresults/hit-list-bg-dead.png' %}{% else %}{% webp_background 'style/images/wot/battleresults/hit-list-bg.png' %}{% endif %}>
                  <picture>
                    <source srcset="{% static 'style/images/wot/battleresults/battleResults-20.webp' %}" type="image/webp">
                    <img {% if not row.damaged %}style="opacity:0.1;"{% endif %}
                         src="{% static 'style/images/wot/battleresults/battleResults-20.png' %}"
                         class="interaction-icon"
                         title="–ù–∞–Ω–µ—Å—ë–Ω–Ω—ã–π —É—Ä–æ–Ω: {% if row.damage_dealt %}{{ row.damage_dealt|intcomma }}{% else %}0{% endif %}">
                  </picture>
                  {% if row.damage_piercings %}<div class="info">{{ row.damage_piercings }}</div>{% endif %}
                </td>
                <td class="kill" {% if row.destroyed %}{% webp_background 'style/images/wot/battleresults/hit-list-bg-dead.png' %}{% else %}{% webp_background 'style/images/wot/battleresults/hit-list-bg.png' %}{% endif %}>
                  <picture>
                    <source srcset="{% static 'style/images/wot/battleresults/battleResults-23.webp' %}" type="image/webp">
                    <img {% if not row.destroyed %}style="opacity:0.1;"{% endif %}
                         src="{% static 'style/images/wot/battleresults/battleResults-23.png' %}">
                  </picture>
                </td>
              </tr>
              <tr class="space"></tr>
              {% empty %}
              <tr>
                <td colspan="8" class="text-center text-muted">–ù–µ—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π</td>
              </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div> <!-- /map + interactions -->
    </div> <!-- /tab-personal -->

    <!-- TAB: –ö–æ–º–∞–Ω–¥–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç -->
    <div class="replay-tab-wrapper" id="tab-team">
      <div class="team-score">
        <!-- –°–æ—é–∑–Ω–∏–∫–∏ -->
        <div class="half score">
          <div class="team-name">{{ team_results.allies_name }}</div>

          {% for player in team_results.allies_players %}
          <div class="personal-data" data-player="{{ player.avatar_id }}">
            <div class="header {% if not player.is_alive %}dead{% endif %}" {% if player.is_alive %}{% webp_background 'style/images/wot/battleresults/hit-list-bg.png' %}{% else %}{% webp_background 'style/images/wot/battleresults/hit-list-bg-dead.png' %}{% endif %}>
              <div class="tank">
                <picture>
                  <source srcset="{% static 'style/images/wot/shop/vehicles/180x135/' %}{{ player.vehicle_tag }}.webp" type="image/webp">
                  <img class="tank new" src="{% static 'style/images/wot/shop/vehicles/180x135/' %}{{ player.vehicle_tag }}.png" alt="{{ player.vehicle_display_name }}" loading="lazy">
                </picture>
                <picture>
                  <source srcset="{% static 'style/images/wot/vehicleTypes/' %}{{ player.tank_type }}.webp" type="image/webp">
                  <img class="type" src="{% static 'style/images/wot/vehicleTypes/' %}{{ player.tank_type }}.png" alt="" loading="lazy">
                </picture>
                <picture>
                  <source srcset="{% static 'style/images/wot/levels/tank_level_' %}{{ player.tank_level }}.webp" type="image/webp">
                  <img class="level" src="{% static 'style/images/wot/levels/tank_level_' %}{{ player.tank_level }}.png" alt="" loading="lazy">
                </picture>
              </div>
              <div class="info">
                <div class="name">
                  <a href="profile/{{ player.avatar_id }}/{{ player.player_name }}" target="_blank">{{ player.display_name }}</a>
                </div>
                <span>{{ player.vehicle_display_name }}</span>
                <div>{{ player.death_text }}</div>
              </div>
            </div>

            {% if player.medals.medals_list %}
            <div class="medals">
              {% for medal in player.medals.medals_list %}
              <img src="{% static medal.image_big %}"
                   alt="{{ medal.name }}"
                   title="&lt;div class='title'&gt;{{ medal.name|escape }}&lt;/div&gt;&lt;img src='{% static medal.image_big %}'/&gt;{{ medal.description|default_if_none:''|escape }}{% if medal.condition %}&lt;div class='condition'&gt;{{ medal.condition|linebreaksbr|escape }}&lt;/div&gt;{% endif %}">
              {% endfor %}
            </div>
            {% endif %}

            <div class="data-wrapper">
              <div class="row">–ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–æ –≤—ã—Å—Ç—Ä–µ–ª–æ–≤<span class="right">{{ player.shots }}</span></div>
              <div class="row padding"> –ø—Ä—è–º—ã—Ö –ø–æ–ø–∞–¥–∞–Ω–∏–π/–ø—Ä–æ–±–∏—Ç–∏–π<span class="right">{{ player.direct_hits }}/{{ player.piercings }}</span></div>
              <div class="row padding"> –æ—Å–∫–æ–ª–æ—á–Ω–æ-—Ñ—É–≥–∞—Å–Ω—ã—Ö –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π<span class="right">{{ player.explosion_hits }}</span></div>
              <div class="row">–ù–∞–Ω–µ—Å–µ–Ω–∏–µ —É—Ä–æ–Ω–∞<span class="right">{{ player.damage_dealt|floatformat:0 }}</span></div>
              <div class="row padding"> —Å –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ —Å–≤—ã—à–µ 300 –º<span class="right">{{ player.sniper_damage|floatformat:0 }}</span></div>
              <div class="row">–ü–æ–ª—É—á–µ–Ω–æ –ø–æ–ø–∞–¥–∞–Ω–∏–π<span class="right">{{ player.hits_received }}</span></div>
              <div class="row padding"> –ø—Ä–æ–±–∏—Ç–∏–π<span class="right">{{ player.piercings_received }}</span></div>
              <div class="row padding"> –Ω–µ –Ω–∞–Ω—ë—Å—à–∏—Ö —É—Ä–æ–Ω<span class="right">{{ player.no_damage_hits_received }}</span></div>
              <div class="row">–ü–æ–ª—É—á–µ–Ω–æ –ø–æ–ø–∞–¥–∞–Ω–∏–π –æ—Å–∫–æ–ª–∫–∞–º–∏<span class="right">{{ player.explosion_hits_received }}</span></div>
              <div class="row">–£—Ä–æ–Ω, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±—Ä–æ–Ω—ë–π<span class="right">{{ player.damage_blocked|floatformat:0 }}</span></div>
              <div class="row">–£—Ä–æ–Ω —Å–æ—é–∑–Ω–∏–∫–∞–º (—É–Ω–∏—á—Ç–æ–∂–µ–Ω–æ/–ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π)<span class="right">{{ player.team_kills }}/{{ player.team_damage|floatformat:0 }}</span></div>
              <div class="row">–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –º–∞—à–∏–Ω –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞<span class="right">{{ player.spotted }}</span></div>
              <div class="row">–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–æ/—É–Ω–∏—á—Ç–æ–∂–µ–Ω–æ –º–∞—à–∏–Ω –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞<span class="right">{{ player.damaged_count }}/{{ player.kills }}</span></div>
              <div class="row">–£—Ä–æ–Ω, –Ω–∞–Ω–µ—Å—ë–Ω–Ω—ã–π —Å –ø–æ–º–æ—â—å—é –¥–∞–Ω–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞<span class="right">{{ player.assist_damage|floatformat:0 }}</span></div>
              {% if player.stun_damage > 0 %}
              <div class="row"><span class="left">–£—Ä–æ–Ω –ø–æ –æ–≥–ª—É—à—ë–Ω–Ω—ã–º –≤–∞–º–∏ —Ü–µ–ª—è–º</span><span class="right">{{ player.stun_damage|floatformat:0 }}</span></div>
              <div class="row"><span class="left">–ù–∞–Ω–µ—Å–µ–Ω–æ –æ–≥–ª—É—à–µ–Ω–∏–π</span><span class="right">{{ player.stun_count }}</span></div>
              {% endif %}
              <div class="row">–û—á–∫–∏ –∑–∞—Ö–≤–∞—Ç–∞/–∑–∞—â–∏—Ç—ã –±–∞–∑—ã<span class="right">{{ player.capture_points }}/{{ player.defense_points }}</span></div>
              <div class="row">–ü—Ä–æ–π–¥–µ–Ω–æ –∫–∏–ª–æ–º–µ—Ç—Ä–æ–≤<span class="right">{{ player.distance }}</span></div>
            </div>
            <div class="close">–ó–∞–∫—Ä—ã—Ç—å</div>
          </div>
          {% endfor %}

          <div class="dataTables_wrapper no-footer">
            <table class="tank-list score dataTable no-footer">
              <thead>
              <tr>
                <th class="player-platoon" data-sort-key="platoon" data-sort-type="number"><div>&nbsp;</div></th>
                <th class="player-names" data-sort-key="player" data-sort-type="string"><div>&nbsp;</div></th>
                <th class="tanks-name" data-sort-key="vehicle" data-sort-type="string"><div>&nbsp;</div></th>
                <th class="damage sorting_desc" data-sort-key="damage" data-sort-type="number" data-sort-default="desc"><div>&nbsp;</div></th>
                <th class="kills" data-sort-key="kills" data-sort-type="number"><div>&nbsp;</div></th>
                <th class="xp" data-sort-key="xp" data-sort-type="number"><div>&nbsp;</div></th>
              </tr>
              </thead>
              <tbody>
              {% for player in team_results.allies_players %}
              <tr{% if player.is_current_player or not player.is_alive %} class="{% if player.is_current_player %}current-player{% endif %}{% if player.is_current_player and not player.is_alive %} {% endif %}{% if not player.is_alive %}dead{% endif %}"{% endif %} data-player="{{ player.avatar_id }}">
                <td class="player-platoon" data-sort-value="{{ player.platoon_id|default_if_none:'' }}">{% if player.platoon_id %}<div class="number{% if player.is_own_platoon %} own-platoon{% endif %}">{{ player.platoon_id }}</div>{% endif %}</td>
                <td class="player-names" data-sort-value="{{ player.display_name|default_if_none:'' }}">{{ player.display_name }}</td>
                <td class="tanks-name" data-sort-value="{{ player.vehicle_display_name|default_if_none:'' }}">
                  <picture>
                    <source srcset="{% static 'style/images/wot/shop/vehicles/180x135/' %}{{ player.vehicle_tag }}.webp" type="image/webp">
                    <img class="tank new" src="{% static 'style/images/wot/shop/vehicles/180x135/' %}{{ player.vehicle_tag }}.png" alt="" loading="lazy">
                  </picture>
                  <span>{{ player.vehicle_display_name }}</span>
                  {% if player.medals.has_medals %}
                  <div class="medal" title="{{ player.medals.title|safe }}">
                    {% if player.medals.count > 1 %}<div class="num">{{ player.medals.count }}</div>{% endif %}
                  </div>
                  {% endif %}
                </td>
                <td class="damage sorting_1" data-sort-value="{{ player.damage_dealt|default_if_none:0 }}">{{ player.damage_dealt|floatformat:0 }}</td>
                <td class="kills" data-sort-value="{{ player.kills|default_if_none:0 }}">{{ player.kills }}</td>
                <td class="xp" data-sort-value="{{ player.xp|default_if_none:0 }}">{{ player.xp }} {% webp_image 'style/images/wot/library/XpIcon.png' 'XP' class='xp' %}</td>
              </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- –ü—Ä–æ—Ç–∏–≤–Ω–∏–∫–∏ -->
        <div class="half score">
          <div class="team-name">{{ team_results.enemies_name }}</div>

          {% for player in team_results.enemies_players %}
          <div class="personal-data left" data-player="{{ player.avatar_id }}">
            <div class="header {% if not player.is_alive %}dead{% endif %}" {% if player.is_alive %}{% webp_background 'style/images/wot/battleresults/hit-list-bg.png' %}{% else %}{% webp_background 'style/images/wot/battleresults/hit-list-bg-dead.png' %}{% endif %}>
              <div class="tank">
                <picture>
                  <source srcset="{% static 'style/images/wot/shop/vehicles/180x135/' %}{{ player.vehicle_tag }}.webp" type="image/webp">
                  <img class="tank new" src="{% static 'style/images/wot/shop/vehicles/180x135/' %}{{ player.vehicle_tag }}.png" alt="{{ player.vehicle_display_name }}" loading="lazy">
                </picture>
                <picture>
                  <source srcset="{% static 'style/images/wot/vehicleTypes/' %}{{ player.tank_type }}.webp" type="image/webp">
                  <img class="type" src="{% static 'style/images/wot/vehicleTypes/' %}{{ player.tank_type }}.png" alt="" loading="lazy">
                </picture>
                <picture>
                  <source srcset="{% static 'style/images/wot/levels/tank_level_' %}{{ player.tank_level }}.webp" type="image/webp">
                  <img class="level" src="{% static 'style/images/wot/levels/tank_level_' %}{{ player.tank_level }}.png" alt="" loading="lazy">
                </picture>
              </div>
              <div class="info">
                <div class="name">
                  <a href="profile/{{ player.avatar_id }}/{{ player.player_name }}" target="_blank">{{ player.display_name }}</a>
                </div>
                <span>{{ player.vehicle_display_name }}</span>
                {% if player.medals.has_medals %}
                <div class="medal" title="{{ player.medals.title|safe }}">
                  {% if player.medals.count > 1 %}<div class="num">{{ player.medals.count }}</div>{% endif %}
                </div>
                {% endif %}
                <div>{{ player.death_text }}</div>
              </div>
            </div>

            {% if player.medals.medals_list %}
            <div class="medals">
              {% for medal in player.medals.medals_list %}
              <img src="{% static medal.image_big %}"
                   alt="{{ medal.name }}"
                   title="&lt;div class='title'&gt;{{ medal.name|escape }}&lt;/div&gt;&lt;img src='{% static medal.image_big %}'/&gt;{{ medal.description|default_if_none:''|escape }}{% if medal.condition %}&lt;div class='condition'&gt;{{ medal.condition|linebreaksbr|escape }}&lt;/div&gt;{% endif %}">
              {% endfor %}
            </div>
            {% endif %}

            <div class="data-wrapper">
              <div class="row">–ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–æ –≤—ã—Å—Ç—Ä–µ–ª–æ–≤<span class="right">{{ player.shots }}</span></div>
              <div class="row padding"> –ø—Ä—è–º—ã—Ö –ø–æ–ø–∞–¥–∞–Ω–∏–π/–ø—Ä–æ–±–∏—Ç–∏–π<span class="right">{{ player.direct_hits }}/{{ player.piercings }}</span></div>
              <div class="row padding"> –æ—Å–∫–æ–ª–æ—á–Ω–æ-—Ñ—É–≥–∞—Å–Ω—ã—Ö –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π<span class="right">{{ player.explosion_hits }}</span></div>
              <div class="row">–ù–∞–Ω–µ—Å–µ–Ω–∏–µ —É—Ä–æ–Ω–∞<span class="right">{{ player.damage_dealt|floatformat:0 }}</span></div>
              <div class="row padding"> —Å –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ —Å–≤—ã—à–µ 300 –º<span class="right">{{ player.sniper_damage|floatformat:0 }}</span></div>
              <div class="row">–ü–æ–ª—É—á–µ–Ω–æ –ø–æ–ø–∞–¥–∞–Ω–∏–π<span class="right">{{ player.hits_received }}</span></div>
              <div class="row padding"> –ø—Ä–æ–±–∏—Ç–∏–π<span class="right">{{ player.piercings_received }}</span></div>
              <div class="row padding"> –Ω–µ –Ω–∞–Ω—ë—Å—à–∏—Ö —É—Ä–æ–Ω<span class="right">{{ player.no_damage_hits_received }}</span></div>
              <div class="row">–ü–æ–ª—É—á–µ–Ω–æ –ø–æ–ø–∞–¥–∞–Ω–∏–π –æ—Å–∫–æ–ª–∫–∞–º–∏<span class="right">{{ player.explosion_hits_received }}</span></div>
              <div class="row">–£—Ä–æ–Ω, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±—Ä–æ–Ω—ë–π<span class="right">{{ player.damage_blocked|floatformat:0 }}</span></div>
              <div class="row">–£—Ä–æ–Ω —Å–æ—é–∑–Ω–∏–∫–∞–º (—É–Ω–∏—á—Ç–æ–∂–µ–Ω–æ/–ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π)<span class="right">{{ player.team_kills }}/{{ player.team_damage|floatformat:0 }}</span></div>
              <div class="row">–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –º–∞—à–∏–Ω –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞<span class="right">{{ player.spotted }}</span></div>
              <div class="row">–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–æ/—É–Ω–∏—á—Ç–æ–∂–µ–Ω–æ –º–∞—à–∏–Ω –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞<span class="right">{{ player.damaged_count }}/{{ player.kills }}</span></div>
              <div class="row">–£—Ä–æ–Ω, –Ω–∞–Ω–µ—Å—ë–Ω–Ω—ã–π —Å –ø–æ–º–æ—â—å—é –¥–∞–Ω–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞<span class="right">{{ player.assist_damage|floatformat:0 }}</span></div>
              {% if player.stun_damage > 0 %}
              <div class="row"><span class="left">–£—Ä–æ–Ω –ø–æ –æ–≥–ª—É—à—ë–Ω–Ω—ã–º –≤–∞–º–∏ —Ü–µ–ª—è–º</span><span class="right">{{ player.stun_damage|floatformat:0 }}</span></div>
              <div class="row"><span class="left">–ù–∞–Ω–µ—Å–µ–Ω–æ –æ–≥–ª—É—à–µ–Ω–∏–π</span><span class="right">{{ player.stun_count }}</span></div>
              {% endif %}
              <div class="row">–û—á–∫–∏ –∑–∞—Ö–≤–∞—Ç–∞/–∑–∞—â–∏—Ç—ã –±–∞–∑—ã<span class="right">{{ player.capture_points }}/{{ player.defense_points }}</span></div>
              <div class="row">–ü—Ä–æ–π–¥–µ–Ω–æ –∫–∏–ª–æ–º–µ—Ç—Ä–æ–≤<span class="right">{{ player.distance }}</span></div>
            </div>
            <div class="close">–ó–∞–∫—Ä—ã—Ç—å</div>
          </div>
          {% endfor %}

          <div class="dataTables_wrapper no-footer">
            <table class="tank-list score dataTable no-footer">
              <thead>
              <tr>
                <th class="player-platoon" data-sort-key="platoon" data-sort-type="number"><div>&nbsp;</div></th>
                <th class="player-names" data-sort-key="player" data-sort-type="string"><div>&nbsp;</div></th>
                <th class="tanks-name" data-sort-key="vehicle" data-sort-type="string"><div>&nbsp;</div></th>
                <th class="damage sorting_desc" data-sort-key="damage" data-sort-type="number" data-sort-default="desc"><div>&nbsp;</div></th>
                <th class="kills" data-sort-key="kills" data-sort-type="number"><div>&nbsp;</div></th>
                <th class="xp" data-sort-key="xp" data-sort-type="number"><div>&nbsp;</div></th>
              </tr>
              </thead>
              <tbody>
              {% for player in team_results.enemies_players %}
              <tr{% if not player.is_alive %} class="dead"{% endif %} data-player="{{ player.avatar_id }}">
                <td class="player-platoon" data-sort-value="{{ player.platoon_id|default_if_none:'' }}">{% if player.platoon_id %}<div class="number{% if player.is_own_platoon %} own-platoon{% endif %}">{{ player.platoon_id }}</div>{% endif %}</td>
                <td class="player-names" data-sort-value="{{ player.display_name|default_if_none:'' }}">{{ player.display_name }}</td>
                <td class="tanks-name" data-sort-value="{{ player.vehicle_display_name|default_if_none:'' }}">
                  <picture>
                    <source srcset="{% static 'style/images/wot/shop/vehicles/180x135/' %}{{ player.vehicle_tag }}.webp" type="image/webp">
                    <img class="tank new" src="{% static 'style/images/wot/shop/vehicles/180x135/' %}{{ player.vehicle_tag }}.png" alt="" loading="lazy">
                  </picture>
                  <span>{{ player.vehicle_display_name }}</span>
                  {% if player.medals.has_medals %}
                  <div class="medal" title="{{ player.medals.title|safe }}">
                    {% if player.medals.count > 1 %}<div class="num">{{ player.medals.count }}</div>{% endif %}
                  </div>
                  {% endif %}
                </td>
                <td class="damage sorting_1" data-sort-value="{{ player.damage_dealt|default_if_none:0 }}">{{ player.damage_dealt|floatformat:0 }}</td>
                <td class="kills" data-sort-value="{{ player.kills|default_if_none:0 }}">{{ player.kills }}</td>
                <td class="xp" data-sort-value="{{ player.xp|default_if_none:0 }}">{{ player.xp }} {% webp_image 'style/images/wot/library/XpIcon.png' 'XP' class='xp' %}</td>
              </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div> <!-- /team-score -->
    </div> <!-- /tab-team -->

    <!-- TAB: –ü–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á—ë—Ç -->
    <div class="replay-tab-wrapper" id="tab-detailed">
      <div class="personal-data tab">
        <div class="titles-line">
          <span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
          <span class="credit">–ö—Ä–µ–¥–∏—Ç—ã</span>
          <span class="base {% if not detailed_report.economics.is_premium %}active{% else %}inactive{% endif %}">–ë–∞–∑–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç</span>
          <span class="premium {% if detailed_report.economics.is_premium %}active{% else %}inactive{% endif %}">–¢–∞–Ω–∫–æ–≤—ã–π –ø—Ä–µ–º–∏—É–º</span>
        </div>

        <!-- –î–≤–µ –∫–æ–ª–æ–Ω–∫–∏ -->
        <div class="columns grid-2">
          <!-- –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
          <div class="col-left">
            <div class="data-wrapper stat">
              <div class="row"><span class="left">–ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–æ –≤—ã—Å—Ç—Ä–µ–ª–æ–≤</span><span class="right">{{ detailed_report.battle_stats.shots }}</span></div>
              <div class="row padding"><span class="left">–ø—Ä—è–º—ã—Ö –ø–æ–ø–∞–¥–∞–Ω–∏–π/–ø—Ä–æ–±–∏—Ç–∏–π</span><span class="right">{{ detailed_report.battle_stats.direct_hits }}/{{ detailed_report.battle_stats.piercings }}</span></div>
              <div class="row padding"><span class="left">–æ—Å–∫–æ–ª–æ—á–Ω–æ-—Ñ—É–≥–∞—Å–Ω—ã—Ö –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π</span><span class="right">{{ detailed_report.battle_stats.explosion_hits }}</span></div>
              <div class="row"><span class="left">–ù–∞–Ω–µ—Å–µ–Ω–∏–µ —É—Ä–æ–Ω–∞</span><span class="right">{{ detailed_report.battle_stats.damage_dealt|intcomma }}</span></div>
              <div class="row padding"><span class="left">—Å –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ —Å–≤—ã—à–µ 300 –º</span><span class="right">{{ detailed_report.battle_stats.sniper_damage|intcomma }}</span></div>
              <div class="row"><span class="left">–ü–æ–ª—É—á–µ–Ω–æ –ø–æ–ø–∞–¥–∞–Ω–∏–π</span><span class="right">{{ detailed_report.battle_stats.hits_received }}</span></div>
              <div class="row padding"><span class="left">–ø—Ä–æ–±–∏—Ç–∏–π</span><span class="right">{{ detailed_report.battle_stats.piercings_received }}</span></div>
              <div class="row padding"><span class="left">–Ω–µ –Ω–∞–Ω—ë—Å—à–∏—Ö —É—Ä–æ–Ω</span><span class="right">{{ detailed_report.battle_stats.no_damage_hits_received }}</span></div>
              <div class="row"><span class="left">–ü–æ–ª—É—á–µ–Ω–æ –ø–æ–ø–∞–¥–∞–Ω–∏–π –æ—Å–∫–æ–ª–∫–∞–º–∏</span><span class="right">{{ detailed_report.battle_stats.explosion_hits_received }}</span></div>
              <div class="row"><span class="left">–£—Ä–æ–Ω, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±—Ä–æ–Ω—ë–π</span><span class="right">{{ detailed_report.battle_stats.damage_blocked|intcomma }}</span></div>
              <div class="row">
                <span class="left">–£—Ä–æ–Ω —Å–æ—é–∑–Ω–∏–∫–∞–º (—É–Ω–∏—á—Ç–æ–∂–µ–Ω–æ/–ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π)</span>
                <span class="right{% if detailed_report.battle_stats.team_damage > 0 %} red{% endif %}">{{ detailed_report.battle_stats.team_kills }}/{{ detailed_report.battle_stats.team_damage|intcomma }}</span>
              </div>
              <div class="row"><span class="left">–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –º–∞—à–∏–Ω –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞</span><span class="right">{{ detailed_report.battle_stats.spotted }}</span></div>
              <div class="row"><span class="left">–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–æ/—É–Ω–∏—á—Ç–æ–∂–µ–Ω–æ –º–∞—à–∏–Ω –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞</span><span class="right">{{ detailed_report.battle_stats.damaged_count }}/{{ detailed_report.battle_stats.kills }}</span></div>
              <div class="row"><span class="left">–£—Ä–æ–Ω, –Ω–∞–Ω–µ—Å—ë–Ω–Ω—ã–π —Å –ø–æ–º–æ—â—å—é –¥–∞–Ω–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞</span><span class="right">{{ detailed_report.battle_stats.assist_total|intcomma }}</span></div>
              {% if detailed_report.battle_stats.stun_damage > 0 %}
              <div class="row"><span class="left">–£—Ä–æ–Ω –ø–æ –æ–≥–ª—É—à—ë–Ω–Ω—ã–º –≤–∞–º–∏ —Ü–µ–ª—è–º</span><span class="right">{{ detailed_report.battle_stats.stun_damage|intcomma }}</span></div>
              <div class="row"><span class="left">–ù–∞–Ω–µ—Å–µ–Ω–æ –æ–≥–ª—É—à–µ–Ω–∏–π</span><span class="right">{{ detailed_report.battle_stats.stun_count }}</span></div>
              {% endif %}
              <div class="row"><span class="left">–û—á–∫–∏ –∑–∞—Ö–≤–∞—Ç–∞/–∑–∞—â–∏—Ç—ã –±–∞–∑—ã</span><span class="right">{{ detailed_report.battle_stats.capture_points }}/{{ detailed_report.battle_stats.defense_points }}</span></div>
              <div class="row"><span class="left">–ü—Ä–æ–π–¥–µ–Ω–æ –∫–∏–ª–æ–º–µ—Ç—Ä–æ–≤</span><span class="right">{{ detailed_report.battle_stats.distance }}</span></div>
            </div>
          </div>

          <!-- –ö–†–ï–î–ò–¢–´ + –ë–û–ù–´ -->
          <div class="col-right">
            <div class="data-wrapper credit normal {% if not detailed_report.economics.is_premium %}active{% else %}inactive{% endif %}" style="margin-left: 0px !important;">
  <div class="row"><span class="left">–ù–∞—á–∏—Å–ª–µ–Ω–æ –∑–∞ –±–æ–π</span><span class="right">{{ detailed_report.credits.base.accrued|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>

  {% if detailed_report.credits.base.order_credits > 0 %}
    <div class="row"><span class="left">–ë–æ–µ–≤—ã–µ –≤—ã–ø–ª–∞—Ç—ã</span><span class="right">{{ detailed_report.credits.base.order_credits|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>
  {% endif %}

  {% if detailed_report.credits.base.booster_effect > 0 %}
    <div class="row"><span class="left">–≠—Ñ—Ñ–µ–∫—Ç –æ—Ç –ª–∏—á–Ω—ã—Ö —Ä–µ–∑–µ—Ä–≤–æ–≤</span><span class="right">{{ detailed_report.credits.base.booster_effect|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>
  {% endif %}

  {% if detailed_report.credits.event_credits > 0 or detailed_report.gold.base.event_income > 0 %}
    <div class="row {% if detailed_report.gold.base.event_income > 0 %}gold{% endif %}">
      <span class="left">–ë–æ–Ω—É—Å –∑–∞ –±–æ–µ–≤—ã–µ –∑–∞–¥–∞—á–∏ –∏ —Å–æ–±—ã—Ç–∏—è</span><span class="right">{{ detailed_report.credits.event_credits|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}
      {% if detailed_report.gold.base.event_income > 0 %}<span class="gold">{{ detailed_report.gold.base.event_income|intcomma }}{% webp_image 'style/images/wot/library/GoldIcon.png' 'Gold' class='credit' %}</span>{% endif %}
    </span></div>
  {% endif %}

  {% if detailed_report.credits.base.team_subs_bonus > 0 %}
    <div class="row"><span class="left">–ö–æ–º–∞–Ω–¥–Ω—ã–π –±–æ–Ω—É—Å –æ—Ç –∏–≥—Ä–æ–∫–æ–≤ —Å –ø–æ–¥–ø–∏—Å–∫–æ–π</span><span class="right">{{ detailed_report.credits.base.team_subs_bonus|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>
  {% endif %}

  {% if detailed_report.credits.base.achievement > 0 %}
    <div class="row"><span class="left">–ó–∞ –¥–æ—Å—Ç–æ–π–Ω–æ–µ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ</span><span class="right">{{ detailed_report.credits.base.achievement|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>
  {% endif %}

  <div class="row top"><span class="left">–®—Ç—Ä–∞—Ñ –∑–∞ —É—Ä–æ–Ω —Å–æ—é–∑–Ω–∏–∫–∞–º</span><span class="right">{{ detailed_report.credits.base.team_damage_penalty|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>
  <div class="row"><span class="left">–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –∑–∞ —É—Ä–æ–Ω –æ—Ç —Å–æ—é–∑–Ω–∏–∫–æ–≤</span><span class="right">{{ detailed_report.credits.base.team_damage_compensation|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>

  <div class="row top {% if detailed_report.gold.base.total_for_battle > 0 %}gold{% endif %}">
    <span class="left">–ò—Ç–æ–≥–æ –∑–∞ –±–æ–π:</span><span class="right">{{ detailed_report.credits.base.total_for_battle|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}
      {% if detailed_report.gold.base.total_for_battle > 0 %}<span class="gold">{{ detailed_report.gold.base.total_for_battle|intcomma }}{% webp_image 'style/images/wot/library/GoldIcon.png' 'Gold' class='credit' %}</span>{% endif %}
    </span></div>

  <div class="row top"><span class="left">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–º–æ–Ω—Ç —Ç–µ—Ö–Ω–∏–∫–∏</span><span class="right red">-{{ detailed_report.credits.costs.auto_repair|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>
  <div class="row"><span class="left">–ê–≤—Ç–æ–ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–æ–µ–∫–æ–º–ø–ª–µ–∫—Ç–∞</span><span class="right red">-{{ detailed_report.credits.costs.auto_ammo|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>

  {% if detailed_report.credits.costs.auto_equipment > 0 or detailed_report.gold.base.total_for_battle > 0 %}
    <div class="row"><span class="left">–ê–≤—Ç–æ–ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–Ω–∞—Ä—è–∂–µ–Ω–∏—è</span><span class="right red">-{{ detailed_report.credits.costs.auto_equipment|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>

  {% endif %}

  <div class="row top gold" >
    <span class="left">–ò—Ç–æ–≥–æ:</span>
    <span class="right {% if detailed_report.credits.base.after_costs < 0 %}red{% endif %}">{{ detailed_report.credits.base.after_costs|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}
      <span class="gold">{{ detailed_report.gold.base.total_for_battle|default:0|intcomma }}{% webp_image 'style/images/wot/library/GoldIcon.png' 'Gold' class='credit' %}</span>
    </span>
  </div>
</div>

   <div class="data-wrapper credit premium {% if detailed_report.economics.is_premium %}active{% else %}inactive{% endif %}">
  <div class="row">&nbsp;<span class="right">{{ detailed_report.credits.premium.accrued|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>

  {% if detailed_report.credits.premium.order_credits > 0 %}
    <div class="row">&nbsp;<span class="right">{{ detailed_report.credits.premium.order_credits|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>
  {% endif %}

  {% if detailed_report.credits.premium.booster_effect > 0 %}
    <div class="row">&nbsp;<span class="right">{{ detailed_report.credits.premium.booster_effect|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>
  {% endif %}

  {% if detailed_report.credits.event_credits > 0 or detailed_report.gold.base.event_income > 0 %}
    <div class="row {% if detailed_report.gold.base.event_income > 0 %}gold{% endif %}">&nbsp;
      <span class="right">{{ detailed_report.credits.event_credits|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}
      {% if detailed_report.gold.base.event_income > 0 %}<span class="gold">{{ detailed_report.gold.base.event_income|intcomma }}{% webp_image 'style/images/wot/library/GoldIcon.png' 'Gold' class='credit' %}</span>{% endif %}
    </span></div>
  {% endif %}

  {% if detailed_report.credits.premium.team_subs_bonus > 0 %}
    <div class="row">&nbsp;<span class="right">{{ detailed_report.credits.premium.team_subs_bonus|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>
  {% endif %}

  {% if detailed_report.credits.premium.achievement > 0 %}
    <div class="row">&nbsp;<span class="right">{{ detailed_report.credits.premium.achievement|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>
  {% endif %}

  <div class="row top">&nbsp;<span class="right">{{ detailed_report.credits.premium.team_damage_penalty|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>
  <div class="row">&nbsp;<span class="right">{{ detailed_report.credits.premium.team_damage_compensation|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>

  <div class="row top {% if detailed_report.gold.base.total_for_battle > 0 %}gold{% endif %}">&nbsp;
    <span class="right">{{ detailed_report.credits.premium.total_for_battle|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}
      {% if detailed_report.gold.base.total_for_battle > 0 %}<span class="gold">{{ detailed_report.gold.base.total_for_battle|intcomma }}{% webp_image 'style/images/wot/library/GoldIcon.png' 'Gold' class='credit' %}</span>{% endif %}
    </span></div>

  <div class="row top">&nbsp;<span class="right red">-{{ detailed_report.credits.costs.auto_repair|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>
  <div class="row">&nbsp;<span class="right red">-{{ detailed_report.credits.costs.auto_ammo|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>

  {% if detailed_report.credits.costs.auto_equipment > 0 or detailed_report.gold.base.total_for_battle > 0 %}
    <div class="row">&nbsp;<span class="right red">-{{ detailed_report.credits.costs.auto_equipment|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}</span></div>

  {% endif %}

  <div class="row top gold">
    &nbsp;<span class="right {% if detailed_report.credits.premium.after_costs < 0 %}red{% endif %}">{{ detailed_report.credits.premium.after_costs|intcomma }}{% webp_image 'style/images/wot/library/CreditsIcon.png' 'Credits' class='credit' %}
      <span class="gold">{{ detailed_report.gold.base.total_for_battle|default:0|intcomma }}{% webp_image 'style/images/wot/library/GoldIcon.png' 'Gold' class='credit' %}</span>
    </span>
  </div>
</div>

            <div class="data-wrapper bonds">
                {% if detailed_report.economics.total_crystal > 0 %}
                  <div class="titles-line"><span>–ë–æ–Ω—ã</span></div>
                      <div class="data-wrapper">
                        {% if detailed_report.economics.achievement_crystal > 0 %}
                            <div class="row"><span class="left">–ó–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</span><span class="right">{{ detailed_report.economics.achievement_crystal }}{% webp_image 'style/images/wot/library/crystal_16x16.png' '' class='credit' %}</span></div>
                        {% endif %}
                        {% if detailed_report.economics.event_crystal > 0 %}
                            <div class="row"><span class="left">–ó–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á</span><span class="right">{{ detailed_report.economics.event_crystal }}{% webp_image 'style/images/wot/library/crystal_16x16.png' '' class='credit' %}</span></div>
                        {% endif %}
                        {% if detailed_report.economics.special_vehicle_crystal > 0 %}
                            <div class="row"><span class="left">–ó–∞ –æ—Å–æ–±—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ –º–∞—à–∏–Ω—ã</span><span class="right">{{ detailed_report.economics.special_vehicle_crystal }}{% webp_image 'style/images/wot/library/crystal_16x16.png' '' class='credit' %}</span></div>
                        {% endif %}
                        <div class="row top"><span class="left">–ò—Ç–æ–≥–æ:</span><span class="right">{{ detailed_report.economics.total_crystal }}{% webp_image 'style/images/wot/library/crystal_16x16.png' '' class='credit' %}</span></div>
                      </div>
                {% endif %}
            </div>
          </div> <!-- /col-right -->
        </div> <!-- /columns -->

        <div class="clearfix"></div>

        <div class="titles-line second">–í—Ä–µ–º—è<span>–û–ø—ã—Ç</span></div>
        <div class="data-wrapper time">
          <div class="row">–ù–∞—á–∞–ª–æ –±–æ—è<span class="right">{{ detailed_report.time_stats.battle_start_formatted }}</span></div>
          <div class="row">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±–æ—è<span class="right">{{ detailed_report.time_stats.battle_duration_formatted }}</span></div>
          <div class="row">–í—Ä–µ–º—è –≤ –±–æ—é –¥–æ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è<span class="right">{{ detailed_report.time_stats.lifetime_formatted }}</span></div>
        </div>

        <div class="data-wrapper xp normal {% if not detailed_report.economics.is_premium %}active{% else %}inactive{% endif %}">
          <div class="row bonus">
            <span class="left">–ù–∞—á–∏—Å–ª–µ–Ω–æ –∑–∞ –±–æ–π</span>
            <span class="right">
              {{ detailed_report.xp.base.accrued|intcomma }}{% webp_image 'style/images/wot/library/XpIcon.png' 'XP' class='credit' %}
              <span class="bonus">{{ detailed_report.xp.base.free_accrued|intcomma }}{% webp_image 'style/images/wot/library/FreeXpIcon-1.png' 'FreeXP' class='credit' %}</span>
            </span>
          </div>
        </div>


      <div class="data-wrapper xp premium {% if detailed_report.economics.is_premium %}active{% else %}inactive{% endif %}">
          <div class="row bonus" style="height:20px;">

            <span class="right">
              {{ detailed_report.xp.premium.accrued|intcomma }}{% webp_image 'style/images/wot/library/XpIcon.png' 'XP' class='credit' %}
              <span class="bonus">{{ detailed_report.xp.premium.free_accrued|intcomma }}{% webp_image 'style/images/wot/library/FreeXpIcon-1.png' 'FreeXP' class='credit' %}</span>
            </span>
          </div>
        </div>

      </div> <!-- /personal-data tab -->
    </div> <!-- /tab-detailed -->
        <!-- Stats container -->
        <div class="replay-stats-container" style="display: inline-block; margin-right: 20px; vertical-align: middle;">
          <div style="display: inline-flex; align-items: center; gap: 12px;">
            <!-- Like button -->
            {% if user.is_authenticated %}
              <button id="like-button" class="like-btn {% if user_has_liked %}liked{% endif %}" data-replay-id="{{ replay.id }}">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="{% if user_has_liked %}#ff4458{% else %}none{% endif %}" stroke="{% if user_has_liked %}#ff4458{% else %}#888{% endif %}" stroke-width="2">
                  <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                </svg>
                <span id="likes-count">{{ likes_count }}</span>
              </button>
            {% else %}
              <span class="like-btn disabled" title="–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#888" stroke-width="2">
                  <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                </svg>
                <span>{{ likes_count }}</span>
              </span>
            {% endif %}

            <!-- Comments -->
            {% get_comment_count for replay as comment_count %}
            <span class="stat-item" style="display: inline-flex; align-items: center; gap: 4px; color: #888; font-size: 13px;">
              <i class="far fa-comments" style="font-size: 16px;"></i>
              <span>{{ comment_count|default:"0" }}</span>
            </span>

            <!-- Views -->
            <span class="stat-item" style="display: inline-flex; align-items: center; gap: 4px; color: #888; font-size: 13px;">
              <i class="far fa-eye" style="font-size: 16px;"></i>
              <span>{{ replay.view_count|intcomma }}</span>
            </span>

            <!-- Downloads -->
            <span class="stat-item" style="display: inline-flex; align-items: center; gap: 4px; color: #888; font-size: 13px;">
              <i class="fas fa-download" style="font-size: 16px;"></i>
              <span>{{ replay.download_count|intcomma }}</span>
            </span>
          </div>
        </div>
        <div class="right down-info">
          <span class="gray">–°–µ—Ä–≤–µ—Ä:</span>{{ details.serverName }}
          <span class="gray">–†–µ–∂–∏–º –±–æ—è:</span>{{ details.battleModeLabel }}
          <span class="gray">–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è:</span>{{ details.clientVersion }}
          <span class="gray">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:</span>{{ details.playerName }}
            {% if replay.user %}
                <span class="gray">–ó–∞–≥—Ä—É–∑–∏–ª:</span>{{ replay.user.username }}
            {% endif %}
        </div>
  </div> <!-- /replay-wrapper -->

  <div class="card" style="margin-top: 0.5rem; background: #14120e; padding: 20px; border-radius: 5px;">
    <div class="card-body">
                <div class="description-header" style="margin-bottom: 2rem;">
                    <div id="desc-container">
                        {% if replay.short_description %}
                            <div class="title text-lg font-semibold text-white">{{ replay.short_description }}</div>
                        {% else %}
                            <div class="title text-lg font-semibold text-white">
                                {{ replay.tank.name|default:'–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∞–Ω–∫' }} ‚Ä¢ {{ replay.map.map_display_name|default:replay.map_name|default:'–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞' }}
                            </div>
                        {% endif %}
                    </div>

                    {% if user == replay.user %}
                        <div style="margin-top: 0.5rem;">
                            <button id="edit-desc-btn" class="btn btn--ghost btn--small" style="padding: 4px 12px; font-size: 13px; opacity: 0.8;">
                                {% if replay.short_description %}
                                    <i class="fas fa-pencil-alt"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ
                                {% else %}
                                    <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ
                                {% endif %}
                            </button>
                        </div>

                        <div id="edit-desc-form" style="display:none; margin-top: 10px; max-width: 600px;">
                            <input type="text" id="desc-input" class="form-control" 
                                   value="{{ replay.short_description|default:'' }}" 
                                   maxlength="60"
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–¥–æ 60 —Å–∏–º–≤–æ–ª–æ–≤)..."
                                   style="width: 100%; padding: 8px; margin-bottom: 10px; background-color: #1f1f1f; border: 1px solid #444; color: #fff; border-radius: 4px;">
                            
                            <div style="display: flex; gap: 10px;">
                                <button id="save-desc-btn" class="btn big-red-button" style="padding: 5px 15px; font-size: 14px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                <button id="cancel-desc-btn" class="btn btn--ghost btn--small">–û—Ç–º–µ–Ω–∞</button>
                            </div>
                        </div>

                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
                                const editBtn = document.getElementById('edit-desc-btn');
                                const formDiv = document.getElementById('edit-desc-form');
                                const descContainer = document.getElementById('desc-container');
                                const input = document.getElementById('desc-input');
                                const saveBtn = document.getElementById('save-desc-btn');
                                const cancelBtn = document.getElementById('cancel-desc-btn');
                                
                                if (editBtn) {
                                    editBtn.addEventListener('click', function() {
                                        editBtn.style.display = 'none';
                                        descContainer.style.display = 'none';
                                        formDiv.style.display = 'block';
                                        input.focus();
                                    });
                                    
                                    cancelBtn.addEventListener('click', function() {
                                        formDiv.style.display = 'none';
                                        descContainer.style.display = 'block';
                                        editBtn.style.display = 'inline-block';
                                        // Reset value to original
                                        input.value = "{{ replay.short_description|escapejs }}"; 
                                    });
                                    
                                    saveBtn.addEventListener('click', function() {
                                        const newDesc = input.value;
                                        
                                        // Simple spinner or disable
                                        saveBtn.disabled = true;
                                        saveBtn.innerText = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

                                        fetch("{% url 'replay_update_description' replay.pk %}", {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json',
                                                'X-CSRFToken': '{{ csrf_token }}'
                                            },
                                            body: JSON.stringify({short_description: newDesc})
                                        })
                                        .then(response => response.json())
                                        .then(data => {
                                            if (data.success) {
                                                // Reload to update the view (handle fallback logic etc)
                                                window.location.reload();
                                            } else {
                                                alert('–û—à–∏–±–∫–∞: ' + (data.error || 'Unknown error'));
                                                saveBtn.disabled = false;
                                                saveBtn.innerText = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                                            }
                                        })
                                        .catch(error => {
                                            console.error('Error:', error);
                                            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                                            saveBtn.disabled = false;
                                            saveBtn.innerText = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                                        });
                                    });
                                }
                            });
                        </script>
                    {% endif %}
                </div>
      <h2 class="card-title" style="color: #c3c3c3; margin-bottom: 1rem; font-size: 1.75rem; font-weight: bold; margin-top: 1.5rem;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h2>
      <hr style="border-color: #333;"/>

      <div class="comment-form-wrapper" style="margin-top: 1.5rem;">
        {% if user.is_authenticated %}
          {% custom_render_comment_form replay %}
        {% else %}
          <p style="color: #ccc;">
            –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, <a href="{% url 'account_login' %}?next={{ request.path|urlencode }}">–≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç</a>
            –∏–ª–∏ <a href="{% url 'account_signup' %}?next={{ request.path|urlencode }}">–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</a>,
            —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–ª—è—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.
          </p>
        {% endif %}
      </div>

      <div class="comment-list-wrapper" style="margin-top: 2rem;">
        {% render_comment_list for replay %}
      </div>
    </div>
  </div>

{% endif %}

<!-- Tabs init -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const tabs = document.querySelectorAll('.replay-tabs .tab');
  const tabContents = document.querySelectorAll('.replay-tab-wrapper');

  function switchTab(targetTab) {
    tabs.forEach(tab => tab.classList.remove('active'));
    tabContents.forEach(content => content.classList.remove('active'));
    const activeTab = document.querySelector(`[data-tab="${targetTab}"]`);
    const activeContent = document.getElementById(`tab-${targetTab}`);
    if (activeTab && activeContent) {
      activeTab.classList.add('active');
      activeContent.classList.add('active');
    }
  }

  tabs.forEach(tab => {
    tab.addEventListener('click', function () {
      const targetTab = this.getAttribute('data-tab');
      switchTab(targetTab);
    });
  });

  initTeamScoreSorting();
  initDownloadButton();
  initShareButton();
  initPlayerDataToggle();
});

function initDownloadButton() {
  const downloadBtn = document.getElementById('download-replay-btn');
  if (!downloadBtn) return;

  downloadBtn.addEventListener('click', function(e) {
    e.preventDefault();

    const isAuthenticated = downloadBtn.dataset.authenticated === 'true';

    if (!isAuthenticated) {
      if (confirm('–î–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ä–µ–ø–ª–µ–µ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è. –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞?')) {
        window.location.href = '{% url "account_login" %}?next={{ request.path|urlencode }}';
      }
      return;
    }

    // –ï—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    const downloadUrl = downloadBtn.dataset.downloadUrl;
    if (downloadUrl) {
      window.open(downloadUrl, '_blank');

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–Ω–∞—Ç–∞ –ø–æ—Å–ª–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
      setTimeout(() => {
        window.dispatchEvent(new CustomEvent('open-donation-modal'));
      }, 500);
    }
  });
}

function initShareButton() {
  const shareBtn = document.getElementById('share-replay-btn');
  if (!shareBtn) return;

  shareBtn.addEventListener('click', async function(e) {
    e.preventDefault();

    // –§–æ—Ä–º–∏—Ä—É–µ–º —á–∏—Å—Ç—ã–π URL –±–µ–∑ GET-–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    const cleanUrl = window.location.origin + window.location.pathname;

    try {
      // –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π Clipboard API
      await navigator.clipboard.writeText(cleanUrl);

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
      const originalText = shareBtn.textContent;
      shareBtn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
      shareBtn.style.background = '#2d7a4f'; // –ü—Ä–∏–≥–ª—É—à–µ–Ω–Ω—ã–π –∑–µ–ª—ë–Ω—ã–π

      setTimeout(() => {
        shareBtn.textContent = originalText;
        shareBtn.style.background = '#4a5568'; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–µ—Ä–æ-—Å–∏–Ω–∏–π
      }, 2000);

    } catch (err) {
      // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
      const textArea = document.createElement('textarea');
      textArea.value = cleanUrl;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();

      try {
        document.execCommand('copy');

        const originalText = shareBtn.textContent;
        shareBtn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
        shareBtn.style.background = '#2d7a4f';

        setTimeout(() => {
          shareBtn.textContent = originalText;
          shareBtn.style.background = '#4a5568';
        }, 2000);

      } catch (err) {
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É');
      }

      document.body.removeChild(textArea);
    }
  });
}

function initTeamScoreSorting() {
  const tables = document.querySelectorAll('#tab-team table.tank-list');

  tables.forEach(table => {
    const allHeaders = Array.from(table.querySelectorAll('th'));
    const sortableHeaders = allHeaders.filter(header => header.dataset.sortType);
    const tbody = table.querySelector('tbody');
    if (!tbody || !sortableHeaders.length) {
      return;
    }

    const initialRows = Array.from(tbody.querySelectorAll('tr'));
    applyStripe(initialRows);

    const defaultHeader = sortableHeaders.find(header => header.classList.contains('sorting_desc') || header.classList.contains('sorting_asc'));
    if (defaultHeader) {
      const defaultIndex = allHeaders.indexOf(defaultHeader);
      if (defaultIndex >= 0) {
        const defaultDirection = defaultHeader.classList.contains('sorting_desc') ? 'desc' : 'asc';
        defaultHeader.dataset.sortDirection = defaultDirection;
        defaultHeader.classList.add('sorting_1');
        updateColumnHighlight(table, defaultIndex);

        // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –ø–æ —É–±—ã–≤–∞–Ω–∏—é
        const rows = Array.from(tbody.querySelectorAll('tr'));
        rows.sort((rowA, rowB) => {
          const sortType = defaultHeader.dataset.sortType || 'string';
          const valueA = getCellValue(rowA.children[defaultIndex], sortType);
          const valueB = getCellValue(rowB.children[defaultIndex], sortType);
          if (valueA < valueB) {
            return defaultDirection === 'asc' ? -1 : 1;
          }
          if (valueA > valueB) {
            return defaultDirection === 'asc' ? 1 : -1;
          }
          return 0;
        });
        rows.forEach(row => tbody.appendChild(row));
        applyStripe(rows);
      }
    } else if (sortableHeaders[0]) {
      const fallbackIndex = allHeaders.indexOf(sortableHeaders[0]);
      sortableHeaders[0].classList.add('sorting_1');
      if (fallbackIndex >= 0) {
        updateColumnHighlight(table, fallbackIndex);
      }
    }

    sortableHeaders.forEach(header => {
      header.addEventListener('click', () => {
        const columnIndex = allHeaders.indexOf(header);
        if (columnIndex < 0) {
          return;
        }

        const sortType = header.dataset.sortType || 'string';
        // –ï—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∞ –µ—â–µ –Ω–µ –∏–º–µ–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏, –Ω–∞—á–∏–Ω–∞–µ–º —Å —É–±—ã–≤–∞–Ω–∏—è
        // –ò–Ω–∞—á–µ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        const currentDirection = header.dataset.sortDirection;
        let nextDirection;
        if (!currentDirection) {
          nextDirection = 'desc'; // –ü–µ—Ä–≤—ã–π –∫–ª–∏–∫ –≤—Å–µ–≥–¥–∞ —Å–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø–æ —É–±—ã–≤–∞–Ω–∏—é
        } else {
          nextDirection = currentDirection === 'asc' ? 'desc' : 'asc';
        }

        sortableHeaders.forEach(otherHeader => {
          otherHeader.classList.remove('sorting_asc', 'sorting_desc', 'sorting_1');
          delete otherHeader.dataset.sortDirection;
        });

        const rows = Array.from(tbody.querySelectorAll('tr'));
        rows.sort((rowA, rowB) => {
          const valueA = getCellValue(rowA.children[columnIndex], sortType);
          const valueB = getCellValue(rowB.children[columnIndex], sortType);
          if (valueA < valueB) {
            return nextDirection === 'asc' ? -1 : 1;
          }
          if (valueA > valueB) {
            return nextDirection === 'asc' ? 1 : -1;
          }
          return 0;
        });

        rows.forEach(row => tbody.appendChild(row));
        applyStripe(rows);
        updateColumnHighlight(table, columnIndex);

        header.classList.add(nextDirection === 'asc' ? 'sorting_asc' : 'sorting_desc', 'sorting_1');
        header.dataset.sortDirection = nextDirection;
      });
    });
  });

  function getCellValue(cell, sortType) {
    if (!cell) {
      return sortType === 'number' ? 0 : '';
    }
    const raw = (cell.getAttribute('data-sort-value') ?? cell.textContent ?? '').toString().trim();
    if (sortType === 'number') {
      const normalized = raw.replace(/\s+/g, '').replace(',', '.');
      const num = parseFloat(normalized);
      return Number.isNaN(num) ? 0 : num;
    }
    return raw.toLowerCase();
  }

  function applyStripe(rows) {
    rows.forEach((row, index) => {
      row.classList.remove('odd', 'even');
      row.classList.add(index % 2 === 0 ? 'odd' : 'even');
    });
  }

  function updateColumnHighlight(tableElement, columnIndex) {
    const bodyRows = tableElement.querySelectorAll('tbody tr');
    bodyRows.forEach(row => {
      Array.from(row.children).forEach((cell, idx) => {
        if (idx === columnIndex) {
          cell.classList.add('sorting_1');
        } else {
          cell.classList.remove('sorting_1');
        }
      });
    });
  }
}

function initPlayerDataToggle() {
  // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –∏–≥—Ä–æ–∫–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü–µ –∫–æ–º–∞–Ω–¥–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
  const playerRows = document.querySelectorAll('#tab-team table.tank-list tbody tr[data-player]');

  playerRows.forEach(row => {
    // –î–µ–ª–∞–µ–º —Å—Ç—Ä–æ–∫—É –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ–π
    row.style.cursor = 'pointer';

    row.addEventListener('click', function(e) {
      // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –ø–æ —Å—Å—ã–ª–∫–∞–º –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫–∏
      if (e.target.tagName === 'A') return;

      const playerId = this.getAttribute('data-player');
      if (!playerId) return;

      // –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –±–ª–æ–∫ personal-data
      const personalDataBlock = document.querySelector(`.personal-data[data-player="${playerId}"]`);
      if (!personalDataBlock) return;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–∫—Ä—ã—Ç–æ –ª–∏ —É–∂–µ —ç—Ç–æ –æ–∫–Ω–æ
      const isAlreadyOpen = personalDataBlock.classList.contains('active');

      // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –æ–∫–Ω–∞
      const allPersonalData = document.querySelectorAll('.personal-data.active');
      allPersonalData.forEach(block => block.classList.remove('active'));

      // –ï—Å–ª–∏ –æ–∫–Ω–æ –Ω–µ –±—ã–ª–æ –æ—Ç–∫—Ä—ã—Ç–æ, –æ—Ç–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ
      if (!isAlreadyOpen) {
        personalDataBlock.classList.add('active');
      }

      // –†–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç—É–ª—Ç–∏–ø—ã –¥–ª—è –º–µ–¥–∞–ª–µ–π –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –æ–∫–Ω–µ
      if (personalDataBlock.classList.contains('active') && window.jQuery && window.jQuery.ui) {
        setTimeout(() => {
          const medalImgs = personalDataBlock.querySelectorAll('.medals img');
          medalImgs.forEach(img => {
            const title = img.getAttribute('title');
            if (title) {
              window.jQuery(img).attr('data-title', title);
              img.removeAttribute('title');
            }
          });
        }, 50);
      }
    });
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–ó–∞–∫—Ä—ã—Ç—å" –≤–Ω—É—Ç—Ä–∏ personal-data
  const closeButtons = document.querySelectorAll('.personal-data .close');
  closeButtons.forEach(button => {
    button.style.cursor = 'pointer';
    button.addEventListener('click', function(e) {
      e.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
      const personalDataBlock = this.closest('.personal-data');
      if (personalDataBlock) {
        personalDataBlock.classList.remove('active');
      }
    });
  });

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –æ–±–ª–∞—Å—Ç–∏ personal-data
  document.addEventListener('click', function(e) {
    // –ï—Å–ª–∏ –∫–ª–∏–∫ –Ω–µ –≤–Ω—É—Ç—Ä–∏ personal-data –∏ –Ω–µ –Ω–∞ —Å—Ç—Ä–æ–∫–µ –∏–≥—Ä–æ–∫–∞
    if (!e.target.closest('.personal-data') && !e.target.closest('table.tank-list tbody tr[data-player]')) {
      const activeBlocks = document.querySelectorAll('.personal-data.active');
      activeBlocks.forEach(block => block.classList.remove('active'));
    }
  });
}
</script>

<!-- jQuery UI tooltips init (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç title —Å HTML-—Å—É—â–Ω–æ—Å—Ç—è–º–∏) -->
<script>
(function () {
  function decodeHtml(s) {
    if (!s) return "";
    var ta = document.createElement("textarea");
    ta.innerHTML = s;
    var decoded = ta.value;
    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º \n –≤ <br> –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫
    decoded = decoded.replace(/\\n/g, '<br>');
    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫ –≤ &nbsp; –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—Å—Ç—É–ø–æ–≤
    decoded = decoded.replace(/(<br>)([ ]{2,})/g, function(match, br, spaces) {
      return br + spaces.replace(/ /g, '&nbsp;');
    });
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã –≤ –Ω–∞—á–∞–ª–µ —Ç–µ–∫—Å—Ç–∞
    decoded = decoded.replace(/^([ ]{2,})/g, function(match, spaces) {
      return spaces.replace(/ /g, '&nbsp;');
    });
    return decoded;
  }

  function initAchiTooltips() {
    if (!window.jQuery) { console.warn("jQuery –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω - —Ç—É–ª—Ç–∏–ø—ã –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã"); return; }
    if (!$.ui || !$.ui.tooltip) { console.warn("jQuery UI Tooltip –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω - —Ç—É–ª—Ç–∏–ø—ã –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã"); return; }

    var selector = ".achievements img, .dossier img, .tank-list .medal, .personal-data .medals img, .interaction-icon, .summary-header";

    $(selector).each(function () {
      var $el = $(this);
      var t = $el.attr("title");
      if (t) {
        $el.attr("data-title", t);
        $el.removeAttr("title");
      }
    });

    $(document).tooltip({
      items: selector,
      content: function () {
        var $el = $(this);
        var raw = $el.attr("data-title") || "";
        var html = decodeHtml(raw);
        return html || "";
      },
      position: { my: "left+12 center", at: "right center", collision: "flipfit" },
      show: { effect: "fade", duration: 120 },
      hide: { effect: "fade", duration: 80 },
      track: false,
      classes: { "ui-tooltip": "achi-tooltip" },
      tooltipClass: "achi-tooltip"
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initAchiTooltips);
  } else {
    initAchiTooltips();
  }
})();
</script>

<script>
// –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª–∞–π–∫–æ–≤
(function() {
  const likeButton = document.getElementById('like-button');

  if (!likeButton) {
    return; // –ö–Ω–æ–ø–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω)
  }

  likeButton.addEventListener('click', function() {
    const replayId = this.dataset.replayId;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;

    // –ï—Å–ª–∏ –Ω–µ—Ç CSRF —Ç–æ–∫–µ–Ω–∞ –≤ —Ñ–æ—Ä–º–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –ø–æ–ª—É—á–∞–µ–º –∏–∑ cookie
    const token = csrfToken || getCookie('csrftoken');

    fetch(`/replays/${replayId}/vote/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': token
      }
    })
    .then(response => response.json())
    .then(data => {
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
      document.getElementById('likes-count').textContent = data.likes_count;

      // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
      const svg = likeButton.querySelector('svg');
      if (data.liked) {
        likeButton.classList.add('liked');
        svg.setAttribute('fill', '#ff4458');
        svg.setAttribute('stroke', '#ff4458');
      } else {
        likeButton.classList.remove('liked');
        svg.setAttribute('fill', 'none');
        svg.setAttribute('stroke', '#888');
      }
    })
    .catch(error => {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ª–∞–π–∫–∞:', error);
      alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
    });
  });

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è cookie
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
})();
</script>

{% endblock %}
