{# replays/templates/replays/detail.html #}
{% extends "base.html" %}
{% load static humanize %}
{% load comments_xtd comments custom_comments_tags %}

{% block title %}Реплей #{{ replay.id }} - {{ replay_data.player_name }}{% endblock %}
{% block meta_description %}
  {{ replay.short_description|default:"Подробная статистика боя: карта, техника, урон, ассист, фраги."|truncatechars:160 }}
{% endblock %}
{% block canonical_url %}{{ request.build_absolute_uri }}{% endblock %}
{% block body_class %}replays detail{% endblock %}
{% block content_mod %}content--solo{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/replay-detail.css' %}">

{% if parse_error %}
  <div class="card error">
    <h2>Ошибка обработки реплея</h2>
    <p>Не удалось извлечь данные из файла реплея: {{ parse_error }}</p>
    <a href="{{ back_url }}" class="btn btn--ghost">← К списку реплеев</a>
  </div>
{% else %}

  <div class="replay-wrapper">
    <div class="replay-tabs">
      <a href="{{ back_url }}" class="btn btn--ghost" style="margin-right:12px;">← Назад к списку</a>
      <div class="tab active" data-tab="personal">Личный результат</div>
      <div class="tab" data-tab="team">Командный результат</div>
      <div class="tab" data-tab="detailed">Подробный отчёт</div>
    </div>

    <div class="right-ajax">
      <div class="replay-download">
        {% if user.is_authenticated %}
          <a href="{% url 'replay_download' replay.pk %}" target="_blank" class="big-red-button">Скачать</a>
        {% else %}
          <button type="button"
                  onclick="window.app.showAlert('Скачивать реплеи могут только авторизованные пользователи. Пожалуйста, войдите в аккаунт или зарегистрируйтесь.', function() { window.location.href='{% url 'account_login' %}?next={{ request.path|urlencode }}'; }, null);"
                  class="big-red-button">Скачать</button>
        {% endif %}
      </div>
    </div>

    <!-- TAB: Личный результат -->
    <div class="replay-tab-wrapper active" id="tab-personal">
      <div class="tanks-image {% if battle_outcome.status_class == 'victory' %}win{% else %}{{ battle_outcome.status_class }}{% endif %}">
        <div class="winner-team {{ battle_outcome.status_class }}">
          <span class="status">{{ battle_outcome.status_text }}</span>
          <div class="reason">{{ battle_outcome.reason_text }}</div>
        </div>

        <div class="battle-records">
          <div class="achievements" data-number="{{ achievements_count_in_badges }}">
            {% for ach in achievements_nonbattle %}
              <div>
                <img
                  src="{% static ach.image_big %}"
                  alt="{{ ach.name }}"
                  title="&lt;div class='title'&gt;{{ ach.name|escape }}&lt;/div&gt;&lt;img src='{% static ach.image_big %}' /&gt; {{ ach.description|default_if_none:''|escape }}{% if ach.condition %}&lt;div class='condition'&gt;{{ ach.condition|linebreaksbr|escape }}&lt;/div&gt;{% endif %}">
              </div>
            {% endfor %}

            {% if has_mastery %}
              <div class="mastery">
                <img
                  src="{% static mastery_image %}"
                  alt="{{ mastery_label }}"
                  title="&lt;div class='title'&gt;Знак классности «{{ mastery_label }}»&lt;/div&gt;&lt;img class='achi' src='{% static mastery_image %}' style='width:67px!important;height:71px!important;' alt='{{ mastery_label }}'/&gt;Присваивается игроку за мастерство владения&lt;/&gt;боевой машиной. Для присвоения необходимо&lt;/&gt;заработать больше опыта за бой, чем средний&lt;/&gt;максимальный опыт за предыдущие 7 дней&lt;/&gt;у игроков на данной машине.">
              </div>
            {% endif %}
          </div>

          <div class="income {% if personal_data.crystal %}bond{% endif %}">
            <div class="credit">
              <span class="count">{{ personal_data.credits|intcomma }}</span>
              <img src="{% static 'style/images/wot/library/CreditsIconBig.png' %}" alt="Credits">
            </div>
            <div class="xp">
              <span class="count">{{ personal_data.xp|intcomma }}</span>
              <img src="{% static 'style/images/wot/library/XpIconBig.png' %}" alt="XP">
            </div>
            {% if personal_data.crystal %}
                <div class="bond">
                    <span class="count">{{ personal_data.crystal|intcomma }}</span>
                    <img src="{% static 'style/images/wot/library/crystal_16x16.png' %}" alt="Bond">
                </div>
            {% endif %}
          </div>

          <div class="dossier" data-number="{{ achievements_battle_count }}">
            {% for ach in achievements_battle %}
              <div class="achi-img-cont">
                <img
                  src="{% static ach.image_big %}"
                  alt="{{ ach.name }}"
                  title="&lt;div class='title'&gt;{{ ach.name|escape }}&lt;/div&gt;&lt;img src='{% static ach.image_big %} '/&gt; {{ ach.description|default_if_none:''|escape }}{% if ach.condition %}&lt;div class='condition'&gt;{{ ach.condition|linebreaksbr|escape }}&lt;/div&gt;{% endif %}">
              </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="titles-line">
        <div class="half">
          <div class="battle-type">
            <span class="map-name">{{ replay.map.map_display_name|default:replay.map_name|default:'Неизвестная карта' }}</span>&nbsp;&nbsp;-&nbsp;&nbsp;{{ battle_type_label }}
          </div>
        </div>
        <div class="half">
          <div class="hit-list">
            <table>
              <tbody>
              <tr class="title">
                <td class="table-title" colspan="2">Боевая эффективность</td>

                <td class="spotted" title="Обнаруженные танки (шт.)">
                  <img {% if interactions_summary.spotted_tanks == 0 %}style="opacity:0.1;"{% endif %}
                       src="{% static 'style/images/wot/battleresults/battleResults-19.png' %}" alt="Spotted">
                  <div class="info">{{ interactions_summary.spotted_tanks }}</div>
                </td>

                <td class="assits" title="Помощь в уничтожении (число целей)">
                  <img {% if interactions_summary.assist_tanks == 0 %}style="opacity:0.1;"{% endif %}
                       src="{% static 'style/images/wot/battleresults/battleResults-25.png' %}" alt="Assist">
                  <div class="info">{{ interactions_summary.assist_tanks }}</div>
                </td>

                <td class="assits" title="Использование брони (число целей с рикошетами/непробитиями)">
                  <img class="bigger" {% if interactions_summary.blocked_tanks == 0 %}style="opacity:0.1;"{% endif %}
                       src="{% static 'style/images/wot/battleresults/teamStatsComponents-12.png' %}" alt="Armor use">
                  <div class="info">{{ interactions_summary.blocked_tanks }}</div>
                </td>

                <td class="crits" title="Критические попадания (шт.)">
                  <img {% if interactions_summary.crits_total == 0 %}style="opacity:0.1;"{% endif %}
                       src="{% static 'style/images/wot/battleresults/battleResults-21.png' %}" alt="Crits">
                  <div class="info">{{ interactions_summary.crits_total }}</div>
                </td>

                <td class="damage" title="Попадания, нанесящие урон (пробития, шт.)">
                  <img {% if interactions_summary.piercings_total == 0 %}style="opacity:0.1;"{% endif %}
                       src="{% static 'style/images/wot/battleresults/battleResults-20.png' %}" alt="Damaging hits">
                  <div class="info">{{ interactions_summary.piercings_total }}</div>
                </td>

                <td class="kill" title="Уничтоженные танки (шт.)">
                  <img {% if interactions_summary.destroyed_tanks == 0 %}style="opacity:0.1;"{% endif %}
                       src="{% static 'style/images/wot/battleresults/battleResults-23.png' %}" alt="Kills">
                  <div class="info">{{ interactions_summary.destroyed_tanks }}</div>
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div style="background:#14120e; display:flex;">
        <div class="half">
          <div class="map-stat">
            {% if replay.map %}
                <img class="map"
                     src="{% static 'style/images/wot/map/stats/' %}{{ replay.map.map_name }}.png"
                     alt="{{ replay.map.map_display_name|default:replay.map.map_name }}">
            {% else %}
                <img class="map"
                     src="{% static 'maps/map_placeholder.jpg' %}"
                     alt="Неизвестная карта">
            {% endif %}
            <div class="stat">
                <div style="display: flex">
                  <div class="stat-tank" >
                    <img class="tank new"
                         src="{% static 'style/images/wot/shop/vehicles/180x135/' %}{{ replay.tank.vehicleId }}.png"
                         alt="{{ replay.tank.name }}">
                    <span class="name ">"{{ replay.tank.name }}"</span>
                    <img class="type"
                         src="{% static 'style/images/wot/vehicleTypes/' %}{{ replay.tank.type }}.png" alt="">
                    <img class="level"
                         src="{% static 'style/images/wot/levels/tank_level_' %}{{ replay.tank.level }}.png" alt="">
                  </div>

                  <div class="stat-text" >
                    <div class="name">
                      {{ details.playerName }}
                      {% if details.clanAbbrev %} [{{ details.clanAbbrev }}]{% endif %}
                    </div>
                    {{ replay.battle_date }}
                    <div class="death-reason">{{ death_reason_text }}</div>
                  </div>
                </div>

              <div class="income">
                <table>
                  <tbody>
                  <tr class="premium-row">
                    <td class="desc"></td>
                    <td class="inactive">Базовый аккаунт</td>
                    <td class="active premium">Танковый премиум</td>
                  </tr>

                  <tr>
                    <td class="desc">Серебро</td>
                    <td class="inactive">
                      <span>{{ income.credits_base|default:0|intcomma }}</span>
                      <img class="credit" src="{% static 'style/images/wot/library/CreditsIcon.png' %}" alt="Credits">
                    </td>
                    <td class="active">
                      <span>{{ income.credits_premium|default:0|intcomma }}</span>
                      <img class="credit" src="{% static 'style/images/wot/library/CreditsIcon.png' %}" alt="Credits">
                    </td>
                  </tr>

                  {% if income.is_first_win %}
                  <tr>
                    <td class="desc">Опыт<br>Награда за первую победу в день (x{{ detailed_report.economics.multipliers.daily }})</td>
                    <td class="inactive">
                      {{ income.xp_with_first_base|default:0|intcomma }}
                      <img class="xp" src="{% static 'style/images/wot/library/XpIcon.png' %}" alt="XP">
                    </td>
                    <td class="active">
                      {{ income.xp_with_first_premium|default:0|intcomma }}
                      <img class="xp" src="{% static 'style/images/wot/library/XpIcon.png' %}" alt="XP">
                    </td>
                  </tr>
                  {% endif %}

                  <tr>
                    <td class="desc">Опыт</td>
                    <td class="inactive">
                      {{ income.xp_base|default:0|intcomma }}
                      <img class="xp" src="{% static 'style/images/wot/library/XpIcon.png' %}" alt="XP">
                    </td>
                    <td class="active">
                      {{ income.xp_premium|default:0|intcomma }}
                      <img class="xp" src="{% static 'style/images/wot/library/XpIcon.png' %}" alt="XP">
                    </td>
                  </tr>

                  <tr class="no-border">
                    <td class="desc">Процент попаданий</td>
                    <td>{{ income.hits }}/{{ income.shots }}</td>
                    <td>{{ income.hit_percent|floatformat:2 }}%</td>
                  </tr>

                  <tr class="no-border">
                    <td class="desc"></td>
                    <td><span style="color:#6183a6;">{{ income.assist_total|default:0|intcomma }}</span></td>
                    <td><span style="color:#d9aa66;">{{ income.damage_total|default:0|intcomma }}</span></td>
                  </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="clearfix">&nbsp;</div>
          </div>
        </div>

        <div class="half" style="padding-bottom:15px;">
          <div class="hit-list">
            <table style="width:100%;">
              <tbody>
              {% for row in interaction_rows %}
              <tr class="row {% if row.destroyed %}dead{% endif %}">
                <td class="name">{{ row.name }}</td>
                <td class="vehicle">
                  {% if row.vehicle_img %}
                    <img class="tank new" src="{% static row.vehicle_img %}" alt="{{ row.vehicle_name }}">
                  {% endif %}
                  <span>{{ row.vehicle_name }}</span>
                </td>
                <td class="spotted">
                  <img {% if not row.spotted %}style="opacity:0.1;"{% endif %}
                       src="{% static 'style/images/wot/battleresults/battleResults-19.png' %}">
                </td>
                <td class="assist">
                  <img {% if not row.assist %}style="opacity:0.1;"{% endif %}
                       src="{% static 'style/images/wot/battleresults/battleResults-25.png' %}">
                </td>
                <td class="assist">
                  <img class="bigger" {% if not row.blocked %}style="opacity:0.1;"{% endif %}
                       src="{% static 'style/images/wot/battleresults/teamStatsComponents-12.png' %}">
                </td>
                <td class="crits">
                  <img {% if not row.crits %}style="opacity:0.1;"{% endif %}
                       src="{% static 'style/images/wot/battleresults/battleResults-21.png' %}">
                  {% if row.crits_count %}<div class="info">{{ row.crits_count }}</div>{% endif %}
                </td>
                <td class="damage">
                  <img {% if not row.damaged %}style="opacity:0.1;"{% endif %}
                       src="{% static 'style/images/wot/battleresults/battleResults-20.png' %}">
                  {% if row.damage_piercings %}<div class="info">{{ row.damage_piercings }}</div>{% endif %}
                </td>
                <td class="kill">
                  <img {% if not row.destroyed %}style="opacity:0.1;"{% endif %}
                       src="{% static 'style/images/wot/battleresults/battleResults-23.png' %}">
                </td>
              </tr>
              <tr class="space"></tr>
              {% empty %}
              <tr>
                <td colspan="8" class="text-center text-muted">Нет взаимодействий</td>
              </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div> <!-- /map + interactions -->
    </div> <!-- /tab-personal -->

    <!-- TAB: Командный результат -->
    <div class="replay-tab-wrapper" id="tab-team">
      <div class="team-score">
        <!-- Союзники -->
        <div class="half score">
          <div class="team-name">{{ team_results.allies_name }}</div>

          {% for player in team_results.allies_players %}
          <div class="personal-data" data-player="{{ player.avatar_id }}">
            <div class="header {% if not player.is_alive %}dead{% endif %}">
              <div class="tank">
                <img class="tank new" src="{% static 'style/images/wot/shop/vehicles/180x135/' %}{{ player.vehicle_tag }}.png" alt="{{ player.vehicle_display_name }}">
                <img class="type" src="{% static 'style/images/wot/vehicleTypes/' %}{{ player.tank_type }}.png" alt="">
                <img class="level" src="{% static 'style/images/wot/levels/tank_level_' %}{{ player.tank_level }}.png" alt="">
              </div>
              <div class="info">
                <div class="name">
                  <a href="profile/{{ player.avatar_id }}/{{ player.player_name }}" target="_blank">{{ player.display_name }}</a>
                </div>
                <span>{{ player.vehicle_display_name }}</span>
                <div>{{ player.death_text }}</div>
              </div>
            </div>

            <div class="data-wrapper">
              <div class="row">Произведено выстрелов<span class="right">{{ player.shots }}</span></div>
              <div class="row padding"> прямых попаданий/пробитий<span class="right">{{ player.direct_hits }}/{{ player.piercings }}</span></div>
              <div class="row padding"> осколочно-фугасных повреждений<span class="right">{{ player.explosion_hits }}</span></div>
              <div class="row">Нанесение урона<span class="right">{{ player.damage_dealt|floatformat:0 }}</span></div>
              <div class="row padding"> с дистанции свыше 300 м<span class="right">{{ player.sniper_damage|floatformat:0 }}</span></div>
              <div class="row">Получено попаданий<span class="right">{{ player.hits_received }}</span></div>
              <div class="row padding"> пробитий<span class="right">{{ player.piercings_received }}</span></div>
              <div class="row padding"> не нанёсших урон<span class="right">{{ player.no_damage_hits_received }}</span></div>
              <div class="row">Получено попаданий осколками<span class="right">{{ player.explosion_hits_received }}</span></div>
              <div class="row">Урон, заблокированный бронёй<span class="right">{{ player.damage_blocked|floatformat:0 }}</span></div>
              <div class="row">Урон союзникам (уничтожено/повреждений)<span class="right">{{ player.team_kills }}/{{ player.team_damage|floatformat:0 }}</span></div>
              <div class="row">Обнаружено машин противника<span class="right">{{ player.spotted }}</span></div>
              <div class="row">Повреждено/уничтожено машин противника<span class="right">{{ player.damaged_count }}/{{ player.kills }}</span></div>
              <div class="row">Урон, нанесённый с помощью данного игрока<span class="right">{{ player.assist_damage|floatformat:0 }}</span></div>
              {% if player.stun_damage > 0 %}
              <div class="row"><span class="left">Урон по оглушённым вами целям</span><span class="right">{{ player.stun_damage|floatformat:0 }}</span></div>
              <div class="row"><span class="left">Нанесено оглушений</span><span class="right">{{ player.stun_count }}</span></div>
              {% endif %}
              <div class="row">Очки захвата/защиты базы<span class="right">{{ player.capture_points }}/{{ player.defense_points }}</span></div>
              <div class="row">Пройдено километров<span class="right">{{ player.distance }}</span></div>
            </div>
            <div class="close">Закрыть</div>
          </div>
          {% endfor %}

          <div class="dataTables_wrapper no-footer">
            <table class="tank-list score dataTable no-footer">
              <thead>
              <tr>
                <th class="player-platoon" data-sort-key="platoon" data-sort-type="number"><div>&nbsp;</div></th>
                <th class="player-names" data-sort-key="player" data-sort-type="string"><div>&nbsp;</div></th>
                <th class="tanks-name" data-sort-key="vehicle" data-sort-type="string"><div>&nbsp;</div></th>
                <th class="damage sorting_desc" data-sort-key="damage" data-sort-type="number" data-sort-default="desc"><div>&nbsp;</div></th>
                <th class="kills" data-sort-key="kills" data-sort-type="number"><div>&nbsp;</div></th>
                <th class="xp" data-sort-key="xp" data-sort-type="number"><div>&nbsp;</div></th>
              </tr>
              </thead>
              <tbody>
              {% for player in team_results.allies_players %}
              <tr{% if player.is_current_player or not player.is_alive %} class="{% if player.is_current_player %}current-player{% endif %}{% if player.is_current_player and not player.is_alive %} {% endif %}{% if not player.is_alive %}dead{% endif %}"{% endif %} data-player="{{ player.avatar_id }}">
                <td class="player-platoon" data-sort-value="{{ player.platoon_id|default_if_none:'' }}">{% if player.platoon_id %}<div class="number">{{ player.platoon_id }}</div>{% endif %}</td>
                <td class="player-names" data-sort-value="{{ player.display_name|default_if_none:'' }}">{{ player.display_name }}</td>
                <td class="tanks-name" data-sort-value="{{ player.vehicle_display_name|default_if_none:'' }}">
                  <img class="tank new" src="{% static 'style/images/wot/shop/vehicles/180x135/' %}{{ player.vehicle_tag }}.png" alt="">
                  <span>{{ player.vehicle_display_name }}</span>
                  {% if player.medals.has_medals %}
                  <div class="medal" title="{{ player.medals.title|safe }}">
                    {% if player.medals.count > 1 %}<div class="num">{{ player.medals.count }}</div>{% endif %}
                  </div>
                  {% endif %}
                </td>
                <td class="damage sorting_1" data-sort-value="{{ player.damage_dealt|default_if_none:0 }}">{{ player.damage_dealt|floatformat:0 }}</td>
                <td class="kills" data-sort-value="{{ player.kills|default_if_none:0 }}">{{ player.kills }}</td>
                <td class="xp" data-sort-value="{{ player.xp|default_if_none:0 }}">{{ player.xp }} <img class="xp" src="{% static 'style/images/wot/library/XpIcon.png' %}" alt="XP"></td>
              </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Противники -->
        <div class="half score">
          <div class="team-name">{{ team_results.enemies_name }}</div>

          {% for player in team_results.enemies_players %}
          <div class="personal-data left" data-player="{{ player.avatar_id }}">
            <div class="header {% if not player.is_alive %}dead{% endif %}">
              <div class="tank">
                <img class="tank new" src="{% static 'style/images/wot/shop/vehicles/180x135/' %}{{ player.vehicle_tag }}.png" alt="{{ player.vehicle_display_name }}">
                <img class="type" src="{% static 'style/images/wot/vehicleTypes/' %}{{ player.tank_type }}.png" alt="">
                <img class="level" src="{% static 'style/images/wot/levels/tank_level_' %}{{ player.tank_level }}.png" alt="">
              </div>
              <div class="info">
                <div class="name">
                  <a href="profile/{{ player.avatar_id }}/{{ player.player_name }}" target="_blank">{{ player.display_name }}</a>
                </div>
                <span>{{ player.vehicle_display_name }}</span>
                {% if player.medals.has_medals %}
                <div class="medal" title="{{ player.medals.title|safe }}">
                  {% if player.medals.count > 1 %}<div class="num">{{ player.medals.count }}</div>{% endif %}
                </div>
                {% endif %}
                <div>{{ player.death_text }}</div>
              </div>
            </div>

            <div class="data-wrapper">
              <div class="row">Произведено выстрелов<span class="right">{{ player.shots }}</span></div>
              <div class="row padding"> прямых попаданий/пробитий<span class="right">{{ player.direct_hits }}/{{ player.piercings }}</span></div>
              <div class="row padding"> осколочно-фугасных повреждений<span class="right">{{ player.explosion_hits }}</span></div>
              <div class="row">Нанесение урона<span class="right">{{ player.damage_dealt|floatformat:0 }}</span></div>
              <div class="row padding"> с дистанции свыше 300 м<span class="right">{{ player.sniper_damage|floatformat:0 }}</span></div>
              <div class="row">Получено попаданий<span class="right">{{ player.hits_received }}</span></div>
              <div class="row padding"> пробитий<span class="right">{{ player.piercings_received }}</span></div>
              <div class="row padding"> не нанёсших урон<span class="right">{{ player.no_damage_hits_received }}</span></div>
              <div class="row">Получено попаданий осколками<span class="right">{{ player.explosion_hits_received }}</span></div>
              <div class="row">Урон, заблокированный бронёй<span class="right">{{ player.damage_blocked|floatformat:0 }}</span></div>
              <div class="row">Урон союзникам (уничтожено/повреждений)<span class="right">{{ player.team_kills }}/{{ player.team_damage|floatformat:0 }}</span></div>
              <div class="row">Обнаружено машин противника<span class="right">{{ player.spotted }}</span></div>
              <div class="row">Повреждено/уничтожено машин противника<span class="right">{{ player.damaged_count }}/{{ player.kills }}</span></div>
              <div class="row">Урон, нанесённый с помощью данного игрока<span class="right">{{ player.assist_damage|floatformat:0 }}</span></div>
              {% if player.stun_damage > 0 %}
              <div class="row"><span class="left">Урон по оглушённым вами целям</span><span class="right">{{ player.stun_damage|floatformat:0 }}</span></div>
              <div class="row"><span class="left">Нанесено оглушений</span><span class="right">{{ player.stun_count }}</span></div>
              {% endif %}
              <div class="row">Очки захвата/защиты базы<span class="right">{{ player.capture_points }}/{{ player.defense_points }}</span></div>
              <div class="row">Пройдено километров<span class="right">{{ player.distance }}</span></div>
            </div>
            <div class="close">Закрыть</div>
          </div>
          {% endfor %}

          <div class="dataTables_wrapper no-footer">
            <table class="tank-list score dataTable no-footer">
              <thead>
              <tr>
                <th class="player-platoon" data-sort-key="platoon" data-sort-type="number"><div>&nbsp;</div></th>
                <th class="player-names" data-sort-key="player" data-sort-type="string"><div>&nbsp;</div></th>
                <th class="tanks-name" data-sort-key="vehicle" data-sort-type="string"><div>&nbsp;</div></th>
                <th class="damage sorting_desc" data-sort-key="damage" data-sort-type="number" data-sort-default="desc"><div>&nbsp;</div></th>
                <th class="kills" data-sort-key="kills" data-sort-type="number"><div>&nbsp;</div></th>
                <th class="xp" data-sort-key="xp" data-sort-type="number"><div>&nbsp;</div></th>
              </tr>
              </thead>
              <tbody>
              {% for player in team_results.enemies_players %}
              <tr{% if not player.is_alive %} class="dead"{% endif %} data-player="{{ player.avatar_id }}">
                <td class="player-platoon" data-sort-value="{{ player.platoon_id|default_if_none:'' }}">{% if player.platoon_id %}<div class="number">{{ player.platoon_id }}</div>{% endif %}</td>
                <td class="player-names" data-sort-value="{{ player.display_name|default_if_none:'' }}">{{ player.display_name }}</td>
                <td class="tanks-name" data-sort-value="{{ player.vehicle_display_name|default_if_none:'' }}">
                  <img class="tank new" src="{% static 'style/images/wot/shop/vehicles/180x135/' %}{{ player.vehicle_tag }}.png" alt="">
                  <span>{{ player.vehicle_display_name }}</span>
                  {% if player.achievements %}<div class="medal" title="Медали"></div>{% endif %}
                </td>
                <td class="damage sorting_1" data-sort-value="{{ player.damage_dealt|default_if_none:0 }}">{{ player.damage_dealt|floatformat:0 }}</td>
                <td class="kills" data-sort-value="{{ player.kills|default_if_none:0 }}">{{ player.kills }}</td>
                <td class="xp" data-sort-value="{{ player.xp|default_if_none:0 }}">{{ player.xp }} <img class="xp" src="{% static 'style/images/wot/library/XpIcon.png' %}" alt="XP"></td>
              </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div> <!-- /team-score -->
    </div> <!-- /tab-team -->

    <!-- TAB: Подробный отчёт -->
    <div class="replay-tab-wrapper" id="tab-detailed">
      <div class="personal-data tab">
        <div class="titles-line">
          <span>Статистика</span>
          <span class="credit">Кредиты</span>
          <span class="base {% if not detailed_report.economics.is_premium %}active{% else %}inactive{% endif %}">Базовый аккаунт</span>
          <span class="premium {% if detailed_report.economics.is_premium %}active{% else %}inactive{% endif %}">Танковый премиум</span>
        </div>

        <!-- Две колонки -->
        <div class="columns grid-2">
          <!-- СТАТИСТИКА -->
          <div class="col-left">
            <div class="data-wrapper stat">
              <div class="row"><span class="left">Произведено выстрелов</span><span class="right">{{ detailed_report.battle_stats.shots }}</span></div>
              <div class="row padding"><span class="left">прямых попаданий/пробитий</span><span class="right">{{ detailed_report.battle_stats.direct_hits }}/{{ detailed_report.battle_stats.piercings }}</span></div>
              <div class="row padding"><span class="left">осколочно-фугасных повреждений</span><span class="right">{{ detailed_report.battle_stats.explosion_hits }}</span></div>
              <div class="row"><span class="left">Нанесение урона</span><span class="right">{{ detailed_report.battle_stats.damage_dealt|intcomma }}</span></div>
              <div class="row padding"><span class="left">с дистанции свыше 300 м</span><span class="right">{{ detailed_report.battle_stats.sniper_damage|intcomma }}</span></div>
              <div class="row"><span class="left">Получено попаданий</span><span class="right">{{ detailed_report.battle_stats.hits_received }}</span></div>
              <div class="row padding"><span class="left">пробитий</span><span class="right">{{ detailed_report.battle_stats.piercings_received }}</span></div>
              <div class="row padding"><span class="left">не нанёсших урон</span><span class="right">{{ detailed_report.battle_stats.no_damage_hits_received }}</span></div>
              <div class="row"><span class="left">Получено попаданий осколками</span><span class="right">{{ detailed_report.battle_stats.explosion_hits_received }}</span></div>
              <div class="row"><span class="left">Урон, заблокированный бронёй</span><span class="right">{{ detailed_report.battle_stats.damage_blocked|intcomma }}</span></div>
              <div class="row">
                <span class="left">Урон союзникам (уничтожено/повреждений)</span>
                <span class="right{% if detailed_report.battle_stats.team_damage > 0 %} red{% endif %}">{{ detailed_report.battle_stats.team_kills }}/{{ detailed_report.battle_stats.team_damage|intcomma }}</span>
              </div>
              <div class="row"><span class="left">Обнаружено машин противника</span><span class="right">{{ detailed_report.battle_stats.spotted }}</span></div>
              <div class="row"><span class="left">Повреждено/уничтожено машин противника</span><span class="right">{{ detailed_report.battle_stats.damaged_count }}/{{ detailed_report.battle_stats.kills }}</span></div>
              <div class="row"><span class="left">Урон, нанесённый с помощью данного игрока</span><span class="right">{{ detailed_report.battle_stats.assist_total|intcomma }}</span></div>
              {% if detailed_report.battle_stats.stun_damage > 0 %}
              <div class="row"><span class="left">Урон по оглушённым вами целям</span><span class="right">{{ detailed_report.battle_stats.stun_damage|intcomma }}</span></div>
              <div class="row"><span class="left">Нанесено оглушений</span><span class="right">{{ detailed_report.battle_stats.stun_count }}</span></div>
              {% endif %}
              <div class="row"><span class="left">Очки захвата/защиты базы</span><span class="right">{{ detailed_report.battle_stats.capture_points }}/{{ detailed_report.battle_stats.defense_points }}</span></div>
              <div class="row"><span class="left">Пройдено километров</span><span class="right">{{ detailed_report.battle_stats.distance }}</span></div>
            </div>
          </div>

          <!-- КРЕДИТЫ + БОНЫ -->
          <div class="col-right">
            <div class="data-wrapper credit normal {% if not detailed_report.economics.is_premium %}active{% else %}inactive{% endif %}" style="margin-left: 0px !important;">
  <div class="row"><span class="left">Начислено за бой</span><span class="right">{{ detailed_report.credits.base.accrued|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/CreditsIcon.png' %}" alt="Credits"></span></div>

  {% if detailed_report.credits.base.order_credits > 0 %}
    <div class="row"><span class="left">Боевые выплаты</span><span class="right">{{ detailed_report.credits.base.order_credits|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/CreditsIcon.png' %}" alt="Credits"></span></div>
  {% endif %}

  {% if detailed_report.credits.base.booster_effect > 0 %}
    <div class="row"><span class="left">Эффект от личных резервов</span><span class="right">{{ detailed_report.credits.base.booster_effect|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/CreditsIcon.png' %}" alt="Credits"></span></div>
  {% endif %}

  {% if detailed_report.credits.event_credits > 0 %}
    <div class="row"><span class="left">Бонус за боевые задачи и события</span><span class="right">{{ detailed_report.credits.event_credits|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/CreditsIcon.png' %}" alt="Credits"></span></div>
  {% endif %}

  {% if detailed_report.credits.base.team_subs_bonus > 0 %}
    <div class="row"><span class="left">Командный бонус от игроков с подпиской</span><span class="right">{{ detailed_report.credits.base.team_subs_bonus|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/CreditsIcon.png' %}" alt="Credits"></span></div>
  {% endif %}

  {% if detailed_report.credits.base.achievement > 0 %}
    <div class="row"><span class="left">За достойное сопротивление</span><span class="right">{{ detailed_report.credits.base.achievement|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/CreditsIcon.png' %}" alt="Credits"></span></div>
  {% endif %}

  <div class="row top"><span class="left">Штраф за урон союзникам</span><span class="right">{{ detailed_report.credits.base.team_damage_penalty|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/CreditsIcon.png' %}" alt="Credits"></span></div>
  <div class="row"><span class="left">Компенсация за урон от союзников</span><span class="right">{{ detailed_report.credits.base.team_damage_compensation|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/CreditsIcon.png' %}" alt="Credits"></span></div>

  <div class="row top"><span class="left">Итого за бой:</span><span class="right">{{ detailed_report.credits.base.total_for_battle|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/CreditsIcon.png' %}" alt="Credits"></span></div>

  <div class="row top"><span class="left">Автоматический ремонт техники</span><span class="right red">-{{ detailed_report.credits.costs.auto_repair|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/CreditsIcon.png' %}" alt="Credits"></span></div>
  <div class="row"><span class="left">Автопополнение боекомплекта</span><span class="right red">-{{ detailed_report.credits.costs.auto_ammo|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/CreditsIcon.png' %}" alt="Credits"></span></div>

  {% if detailed_report.credits.costs.auto_equipment > 0 or detailed_report.gold.spent > 0 %}
  <div class="row gold">
    <span class="left">Автопополнение снаряжения</span>
    <span class="right red">-{{ detailed_report.credits.costs.auto_equipment|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/CreditsIcon.png' %}" alt="Credits">
      <span class="gold">{{ detailed_report.gold.spent|default:0|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/GoldIcon.png' %}" alt="Gold"></span>
    </span>
  </div>
  {% endif %}

  <div class="row top gold" >
    <span class="left">Итого:</span>
    <span class="right {% if detailed_report.credits.base.after_costs < 0 %}red{% endif %}">{{ detailed_report.credits.base.after_costs|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/CreditsIcon.png' %}" alt="Credits">
      <span class="gold">{{ detailed_report.gold.spent|default:0|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/GoldIcon.png' %}" alt="Gold"></span>
    </span>
  </div>
</div>

          <div class="data-wrapper credit premium {% if detailed_report.economics.is_premium %}active{% else %}inactive{% endif %}">
  <div class="row">&nbsp;<span class="right">{{ detailed_report.credits.premium.accrued|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/CreditsIcon.png' %}" alt="Credits"></span></div>

  {% if detailed_report.credits.premium.order_credits > 0 %}
    <div class="row">&nbsp;<span class="right">{{ detailed_report.credits.premium.order_credits|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/CreditsIcon.png' %}" alt="Credits"></span></div>
  {% endif %}

  {% if detailed_report.credits.premium.booster_effect > 0 %}
    <div class="row">&nbsp;<span class="right">{{ detailed_report.credits.premium.booster_effect|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/CreditsIcon.png' %}" alt="Credits"></span></div>
  {% endif %}

  {% if detailed_report.credits.event_credits > 0 %}
    <div class="row">&nbsp;<span class="right">{{ detailed_report.credits.event_credits|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/CreditsIcon.png' %}" alt="Credits"></span></div>
  {% endif %}

  {% if detailed_report.credits.premium.team_subs_bonus > 0 %}
    <div class="row">&nbsp;<span class="right">{{ detailed_report.credits.premium.team_subs_bonus|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/CreditsIcon.png' %}" alt="Credits"></span></div>
  {% endif %}

  {% if detailed_report.credits.premium.achievement > 0 %}
    <div class="row">&nbsp;<span class="right">{{ detailed_report.credits.premium.achievement|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/CreditsIcon.png' %}" alt="Credits"></span></div>
  {% endif %}

  <div class="row top">&nbsp;<span class="right">{{ detailed_report.credits.premium.team_damage_penalty|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/CreditsIcon.png' %}" alt="Credits"></span></div>
  <div class="row">&nbsp;<span class="right">{{ detailed_report.credits.premium.team_damage_compensation|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/CreditsIcon.png' %}" alt="Credits"></span></div>

  <div class="row top">&nbsp;<span class="right">{{ detailed_report.credits.premium.total_for_battle|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/CreditsIcon.png' %}" alt="Credits"></span></div>

  <div class="row top">&nbsp;<span class="right red">-{{ detailed_report.credits.costs.auto_repair|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/CreditsIcon.png' %}" alt="Credits"></span></div>
  <div class="row">&nbsp;<span class="right red">-{{ detailed_report.credits.costs.auto_ammo|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/CreditsIcon.png' %}" alt="Credits"></span></div>

  {% if detailed_report.credits.costs.auto_equipment > 0 or detailed_report.gold.spent > 0 %}
  <div class="row gold">&nbsp;
    <span class="right red">-{{ detailed_report.credits.costs.auto_equipment|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/CreditsIcon.png' %}" alt="Credits">
      <span class="gold">{{ detailed_report.gold.spent|default:0|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/GoldIcon.png' %}" alt="Gold"></span>
    </span>
  </div>
  {% endif %}

  <div class="row top {% if detailed_report.credits.costs.auto_equipment > 0 or detailed_report.gold.spent > 0 %}gold{% endif %}" style="height:20px;">
    &nbsp;<span class="right {% if detailed_report.credits.premium.after_costs < 0 %}red{% endif %}">{{ detailed_report.credits.premium.after_costs|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/CreditsIcon.png' %}" alt="Credits">
      <span class="gold">{{ detailed_report.gold.spent|default:0|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/GoldIcon.png' %}" alt="Gold"></span>
    </span>
  </div>
</div>

            <div class="data-wrapper bonds">
                {% if detailed_report.economics.total_crystal > 0 %}
                  <div class="titles-line"><span>Боны</span></div>
                      <div class="data-wrapper">
                        {% if detailed_report.economics.achievement_crystal > 0 %}
                            <div class="row"><span class="left">За достижения</span><span class="right">{{ detailed_report.economics.achievement_crystal }}<img class="credit" src="{% static 'style/images/wot/library/crystal_16x16.png' %}" alt=""></span></div>
                        {% endif %}
                        {% if detailed_report.economics.event_crystal > 0 %}
                            <div class="row"><span class="left">За выполнение задач</span><span class="right">{{ detailed_report.economics.event_crystal }}<img class="credit" src="{% static 'style/images/wot/library/crystal_16x16.png' %}" alt=""></span></div>
                        {% endif %}
                        {% if detailed_report.economics.special_vehicle_crystal > 0 %}
                            <div class="row"><span class="left">За особые свойства машины</span><span class="right">{{ detailed_report.economics.special_vehicle_crystal }}<img class="credit" src="{% static 'style/images/wot/library/crystal_16x16.png' %}" alt=""></span></div>
                        {% endif %}
                        <div class="row top"><span class="left">Итого:</span><span class="right">{{ detailed_report.economics.total_crystal }}<img class="credit" src="{% static 'style/images/wot/library/crystal_16x16.png' %}" alt=""></span></div>
                      </div>
                {% endif %}
            </div>
          </div> <!-- /col-right -->
        </div> <!-- /columns -->

        <div class="clearfix"></div>

        <div class="titles-line second">Время<span>Опыт</span></div>
        <div class="data-wrapper time">
          <div class="row">Начало боя<span class="right">{{ detailed_report.time_stats.battle_start_formatted }}</span></div>
          <div class="row">Продолжительность боя<span class="right">{{ detailed_report.time_stats.battle_duration_formatted }}</span></div>
          <div class="row">Время в бою до уничтожения<span class="right">{{ detailed_report.time_stats.lifetime_formatted }}</span></div>
        </div>

        <div class="data-wrapper xp normal {% if not detailed_report.economics.is_premium %}active{% else %}inactive{% endif %}">
          <div class="row bonus">
            <span class="left">Начислено за бой</span>
            <span class="right">
              {{ detailed_report.xp.base.accrued|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/XpIcon.png' %}" alt="XP">
              <span class="bonus">{{ detailed_report.xp.base.free_accrued|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/FreeXpIcon-1.png' %}" alt="FreeXP"></span>
            </span>
          </div>

{#          <div class="row">#}
{#            <span class="left">Штраф за урон союзникам</span>#}
{#            <span class="right">{{ detailed_report.xp.base.penalty|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/XpIcon.png' %}" alt="XP"></span>#}
{#          </div>#}
{##}
{#          {% if income.is_first_win %}#}
{#          <div class="row bonus">#}
{#            <span class="left">Награда за первую победу в день</span>#}
{#            <span class="right">x{{ detailed_report.xp.multipliers.daily }}<img class="credit" src="{% static 'style/images/wot/library/XpIcon.png' %}" alt="XP">#}
{#                <span class="bonus">x{{ detailed_report.xp.multipliers.daily }}<img class="credit" src="{% static 'style/images/wot/library/FreeXpIcon-1.png' %}" alt="XP"></span>#}
{#            </span>#}
{#          </div>#}
{#          {% endif %}#}
{##}
{#          {% if detailed_report.xp.multipliers.managed > 1 %}#}
{#          <div class="row bonus">#}
{#            <span class="left">Управляемый бонус к опыту</span>#}
{#            <span class="right">x{{ detailed_report.xp.multipliers.managed }}<img class="credit" src="{% static 'style/images/wot/library/XpIcon.png' %}" alt="XP">#}
{#                <span class="bonus">x{{ detailed_report.xp.multipliers.managed }}<img class="credit" src="{% static 'style/images/wot/library/FreeXpIcon-1.png' %}" alt="XP"></span>#}
{#            </span>#}
{#          </div>#}
{#          {% endif %}#}
{##}
{#          <div class="row bonus">#}
{#            <span class="left">Эффект от личных резервов</span>#}
{#            <span class="right">#}
{#              {{ detailed_report.xp.base.boosters.xp|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/XpIcon.png' %}" alt="XP">#}
{#              <span class="bonus">{{ detailed_report.xp.base.boosters.free_xp|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/FreeXpIcon-1.png' %}" alt="FreeXP"></span>#}
{#            </span>#}
{#          </div>#}
{##}
{#          <div class="row top bonus">#}
{#            <span class="left">Итого:</span>#}
{#            <span class="right">#}
{#              {{ detailed_report.xp.base.total|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/XpIcon.png' %}" alt="XP">#}
{#              <span class="bonus">{{ detailed_report.xp.base.free_total|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/FreeXpIcon-1.png' %}" alt="FreeXP"></span>#}
{#            </span>#}
{#          </div>#}
        </div>


      <div class="data-wrapper xp premium {% if detailed_report.economics.is_premium %}active{% else %}inactive{% endif %}">
          <div class="row bonus" style="height:20px;">

            <span class="right">
              {{ detailed_report.xp.premium.accrued|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/XpIcon.png' %}" alt="XP">
              <span class="bonus">{{ detailed_report.xp.premium.free_accrued|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/FreeXpIcon-1.png' %}" alt="FreeXP"></span>
            </span>
          </div>

{#          <div class="row" style="height:20px;">#}
{##}
{#            <span class="right">{{ detailed_report.xp.premium.penalty|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/XpIcon.png' %}" alt="XP"></span>#}
{#          </div>#}
{##}
{#          {% if income.is_first_win %}#}
{#          <div class="row bonus" style="height:20px;">#}
{#            <span class="right">x{{ detailed_report.xp.multipliers.daily }}<img class="credit" src="{% static 'style/images/wot/library/XpIcon.png' %}" alt="XP">#}
{#                <span class="bonus">x{{ detailed_report.xp.multipliers.daily }}<img class="credit" src="{% static 'style/images/wot/library/FreeXpIcon-1.png' %}" alt="XP"></span>#}
{#            </span>#}
{#          </div>#}
{#          {% endif %}#}
{#          {% if detailed_report.xp.multipliers.managed > 1 %}#}
{#          <div class="row bonus" style="height:20px;">#}
{#            <span class="right">x{{ detailed_report.xp.multipliers.managed }}<img class="credit" src="{% static 'style/images/wot/library/XpIcon.png' %}" alt="XP">#}
{#                 <span class="bonus">x{{ detailed_report.xp.multipliers.managed }}<img class="credit" src="{% static 'style/images/wot/library/FreeXpIcon-1.png' %}" alt="XP"></span>#}
{#            </span>#}
{#          </div>#}
{#          {% endif %}#}
{##}
{#          <div class="row bonus" style="height:20px;">#}
{##}
{#            <span class="right">#}
{#              {{ detailed_report.xp.premium.boosters.xp|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/XpIcon.png' %}" alt="XP">#}
{#              <span class="bonus">{{ detailed_report.xp.premium.boosters.free_xp|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/FreeXpIcon-1.png' %}" alt="FreeXP"></span>#}
{#            </span>#}
{#          </div>#}
{##}
{#          <div class="row top bonus" style="height:20px;">#}
{#            <span class="right">#}
{#              {{ detailed_report.xp.premium.total|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/XpIcon.png' %}" alt="XP">#}
{#              <span class="bonus">{{ detailed_report.xp.premium.free_total|intcomma }}<img class="credit" src="{% static 'style/images/wot/library/FreeXpIcon-1.png' %}" alt="FreeXP"></span>#}
{#            </span>#}
{#          </div>#}
        </div>

      </div> <!-- /personal-data tab -->
    </div> <!-- /tab-detailed -->
        <div class="right down-info">
          <span class="gray">Сервер:</span>{{ details.serverName }}
          <span class="gray">Режим боя:</span>Случайный бой
          <span class="gray">Текущая версия:</span>{{ details.clientVersion }}
          <span class="gray">Отправитель:</span>{{ details.playerName }}
            {% if replay.user %}
                <span class="gray">Загрузил:</span>{{ replay.user.username }}
            {% endif %}
        </div>
  </div> <!-- /replay-wrapper -->

  <div class="card" style="margin-top: 2rem; background: #14120e; padding: 20px; border-radius: 5px;">
    <div class="card-body">
      <h4 class="card-title" style="color: #c3c3c3; margin-bottom: 1rem;">Комментарии</h4>
      <hr style="border-color: #333;"/>
      {% get_comment_count for replay as comment_count %}
      <p style="color: #999;">Всего комментариев: {{ comment_count }}</p>

      <div class="comment-form-wrapper" style="margin-top: 1.5rem;">
        {% if user.is_authenticated %}
          {% custom_render_comment_form replay %}
        {% else %}
          <p style="color: #ccc;">
            Пожалуйста, <a href="{% url 'account_login' %}?next={{ request.path|urlencode }}">войдите в аккаунт</a>
            или <a href="{% url 'account_signup' %}?next={{ request.path|urlencode }}">зарегистрируйтесь</a>,
            чтобы оставлять комментарии.
          </p>
        {% endif %}
      </div>

      <div class="comment-list-wrapper" style="margin-top: 2rem;">
        {% render_comment_list for replay %}
      </div>
    </div>
  </div>

{% endif %}

<!-- Tabs init -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const tabs = document.querySelectorAll('.replay-tabs .tab');
  const tabContents = document.querySelectorAll('.replay-tab-wrapper');

  function switchTab(targetTab) {
    tabs.forEach(tab => tab.classList.remove('active'));
    tabContents.forEach(content => content.classList.remove('active'));
    const activeTab = document.querySelector(`[data-tab="${targetTab}"]`);
    const activeContent = document.getElementById(`tab-${targetTab}`);
    if (activeTab && activeContent) {
      activeTab.classList.add('active');
      activeContent.classList.add('active');
    }
  }

  tabs.forEach(tab => {
    tab.addEventListener('click', function () {
      const targetTab = this.getAttribute('data-tab');
      switchTab(targetTab);
    });
  });

  initTeamScoreSorting();
});

function initTeamScoreSorting() {
  const tables = document.querySelectorAll('#tab-team table.tank-list');

  tables.forEach(table => {
    const allHeaders = Array.from(table.querySelectorAll('th'));
    const sortableHeaders = allHeaders.filter(header => header.dataset.sortType);
    const tbody = table.querySelector('tbody');
    if (!tbody || !sortableHeaders.length) {
      return;
    }

    const initialRows = Array.from(tbody.querySelectorAll('tr'));
    applyStripe(initialRows);

    const defaultHeader = sortableHeaders.find(header => header.classList.contains('sorting_desc') || header.classList.contains('sorting_asc'));
    if (defaultHeader) {
      const defaultIndex = allHeaders.indexOf(defaultHeader);
      if (defaultIndex >= 0) {
        const defaultDirection = defaultHeader.classList.contains('sorting_desc') ? 'desc' : 'asc';
        defaultHeader.dataset.sortDirection = defaultDirection;
        defaultHeader.classList.add('sorting_1');
        updateColumnHighlight(table, defaultIndex);
      }
    } else if (sortableHeaders[0]) {
      const fallbackIndex = allHeaders.indexOf(sortableHeaders[0]);
      sortableHeaders[0].classList.add('sorting_1');
      if (fallbackIndex >= 0) {
        updateColumnHighlight(table, fallbackIndex);
      }
    }

    sortableHeaders.forEach(header => {
      header.addEventListener('click', () => {
        const columnIndex = allHeaders.indexOf(header);
        if (columnIndex < 0) {
          return;
        }

        const sortType = header.dataset.sortType || 'string';
        const nextDirection = header.dataset.sortDirection === 'asc' ? 'desc' : 'asc';

        sortableHeaders.forEach(otherHeader => {
          otherHeader.classList.remove('sorting_asc', 'sorting_desc', 'sorting_1');
          delete otherHeader.dataset.sortDirection;
        });

        const rows = Array.from(tbody.querySelectorAll('tr'));
        rows.sort((rowA, rowB) => {
          const valueA = getCellValue(rowA.children[columnIndex], sortType);
          const valueB = getCellValue(rowB.children[columnIndex], sortType);
          if (valueA < valueB) {
            return nextDirection === 'asc' ? -1 : 1;
          }
          if (valueA > valueB) {
            return nextDirection === 'asc' ? 1 : -1;
          }
          return 0;
        });

        rows.forEach(row => tbody.appendChild(row));
        applyStripe(rows);
        updateColumnHighlight(table, columnIndex);

        header.classList.add(nextDirection === 'asc' ? 'sorting_asc' : 'sorting_desc', 'sorting_1');
        header.dataset.sortDirection = nextDirection;
      });
    });
  });

  function getCellValue(cell, sortType) {
    if (!cell) {
      return sortType === 'number' ? 0 : '';
    }
    const raw = (cell.getAttribute('data-sort-value') ?? cell.textContent ?? '').toString().trim();
    if (sortType === 'number') {
      const normalized = raw.replace(/\s+/g, '').replace(',', '.');
      const num = parseFloat(normalized);
      return Number.isNaN(num) ? 0 : num;
    }
    return raw.toLowerCase();
  }

  function applyStripe(rows) {
    rows.forEach((row, index) => {
      row.classList.remove('odd', 'even');
      row.classList.add(index % 2 === 0 ? 'odd' : 'even');
    });
  }

  function updateColumnHighlight(tableElement, columnIndex) {
    const bodyRows = tableElement.querySelectorAll('tbody tr');
    bodyRows.forEach(row => {
      Array.from(row.children).forEach((cell, idx) => {
        if (idx === columnIndex) {
          cell.classList.add('sorting_1');
        } else {
          cell.classList.remove('sorting_1');
        }
      });
    });
  }
}
</script>

<!-- jQuery UI tooltips init (использует title с HTML-сущностями) -->
<script>
(function () {
  function decodeHtml(s) {
    if (!s) return "";
    if (!/[&][a-z#0-9]+;/.test(s)) return s;
    var ta = document.createElement("textarea");
    ta.innerHTML = s;
    return ta.value;
  }

  function initAchiTooltips() {
    if (!window.jQuery) { console.warn("jQuery не загружен - тултипы не инициализированы"); return; }
    if (!$.ui || !$.ui.tooltip) { console.warn("jQuery UI Tooltip не загружен - тултипы не инициализированы"); return; }

    var selector = ".achievements img, .dossier img, .tank-list .medal";

    $(selector).each(function () {
      var $el = $(this);
      var t = $el.attr("title");
      if (t) {
        $el.attr("data-title", t);
        $el.removeAttr("title");
      }
    });

    $(document).tooltip({
      items: selector,
      content: function () {
        var $el = $(this);
        var raw = $el.attr("data-title") || "";
        var html = decodeHtml(raw);
        return html || "";
      },
      position: { my: "left+12 center", at: "right center", collision: "flipfit" },
      show: { effect: "fade", duration: 120 },
      hide: { effect: "fade", duration: 80 },
      track: false,
      classes: { "ui-tooltip": "achi-tooltip" },
      tooltipClass: "achi-tooltip"
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initAchiTooltips);
  } else {
    initAchiTooltips();
  }
})();
</script>

{% endblock %}
