# План переработки модального окна статистики игрока

**Цель**: Переделать модальное окно статистики игрока по образцу страницы tanki.su
**Образец**: `tanki_su/EHoTuk_TT0Jl0CKyH — статистика игрока «Мира танков».html`
**Дата**: 2026-02-21

---

## Текущее состояние

- **JS**: `static/js/player-stats.js` — рендерит HTML через JS (innerHTML)
- **CSS**: `static/css/player-stats-modal.css` + `static/css/tanki-su-profile.css` (извлечённые стили)
- **HTML шаблон**: `templates/includes/_player_stats_modal.html` — каркас модалки
- **API**: `/api/player/<id>/stats/` → возвращает `{info, tanks, achievements}`
- **Данные**: info (nickname, created_at, last_battle_time, global_rating, statistics.all), tanks (массив с tank_id, statistics, mark_of_mastery), achievements (achievements — dict с кодами)

---

## Блоки страницы tanki.su (сверху вниз)

### Блок 1: Шапка профиля (header)
- Имя игрока (крупно)
- Тег клана `[D_DOS]` с цветом + название клана
- Дата регистрации, последний бой
- Ссылка на tanki.su

### Блок 2: Статистика (summary — 9 показателей)
- Центральный большой блок: **Личный рейтинг** (с иконкой щита)
- Левый столбец (4 штуки): Победы %, Бои, Попадания %, Средний урон
- Правый столбец (4 штуки): Средний опыт, Макс. опыт, Макс. уничтожено, Знаки «Мастер»
- Все с SVG-иконками (уже есть в tanki-su-profile.css)

### Блок 3: Достижения
- Иконки достижений с счётчиками
- Тултипы при наведении (название, описание)


### Блок 4: Бои на технике (гистограммы)
- **По уровням** (I–XI) — вертикальные бары с тултипами (бои, %, знаки классности, победы%)
- **По типам** (ЛТ, СТ, ТТ, ПТ, САУ) — аналогичная гистограмма
- **По нациям** — гистограмма с флагами

### Блок 5: Подробная статистика (4 карточки в grid)
- **Общие параметры**: Бои, Победы, Поражения, Выживаемость, Коэфф. урона, Коэфф. уничтожения, Эфф. брони, Захват, Защита
- **Средние за бой**: Опыт, Урон, Получ. урон, Оглушения, Урон с помощью, Урон по оглушённым, Обнаружено, Уничтожено
- **Рекордные показатели**: Макс. уничтожено, Макс. опыт, Макс. урон
- **Знаки классности**: Мастер, 1/2/3 степень (с иконками)

### Блок 6: Вся техника (таблица)
- Фильтры: нация, тип, уровень
- Колонки: Машина, Уровень, Тип, Нация, Бои, Победы%, Средний урон, Средний опыт, ЗК
- Сортировка по столбцам

---

## Этапы реализации

### Этап 1: Шапка профиля ✅
**Статус**: ✅ Готово (2026-02-21)

**Что сделано**:
- [x] Добавлен запрос клана в API (`/wot/clans/info/`) — tag, name, color, emblems, members
- [x] Шапка: крупное имя (32px), дата регистрации + последний бой в одну строку
- [x] Блок клана справа: эмблема 64x64, тег с цветом + название в одну строку
- [x] Должность и дней в клане (из members API)
- [x] Ссылка "Профиль на tanki.su" в полоске под шапкой
- [x] Полная стилизация по образцу tanki.su (тёмный фон, layout)
- [x] Адаптивность для мобильных

**Изменённые файлы**:
- `replays/views.py` — запрос `/wot/clans/info/` с members, извлечение member info (role_i18n, joined_at)
- `static/js/player-stats.js` — переделана шапка (ps-header-wrapper, ps-clan-box, ps-clan-member-info)
- `static/css/player-stats-modal.css` — новые стили шапки, клана, должности

---

### Этап 2: Блок статистики (summary 9 показателей) ✅
**Статус**: ✅ Готово (2026-02-21)

**Что сделано**:
- [x] Заголовок секции «Статистика» с выпадающим списком типов боёв (dropdown)
- [x] Типы боёв: Все бои, Случайные бои, Глобальная карта, Укрепрайон: Наступления/Вылазки, Ротные бои, Командные бои
- [x] Layout tanki.su: центр (рейтинг) + лево (4) + право (4) с SVG-иконками
- [x] Переключение типа боёв — блок статистики обновляется динамически (без перезагрузки)
- [x] По умолчанию отображаются «Случайные бои» (statistics.random)
- [x] Функция renderStatsBlock() вынесена для переиспользования
- [x] CSS: стили заголовка (profile-grid_header), dropdown (ps-dropdown), стрелочка

**Изменённые файлы**:
- `static/js/player-stats.js` — BATTLE_TYPES, renderStatsBlock(), initBattleTypeDropdown(), dropdown HTML
- `static/css/player-stats-modal.css` — стили profile-grid_header, profile-grid_heading, profile-grid_info-link, ps-dropdown

---

### Этап 3: Достижения ⬜
**Статус**: ⬜ Не начато

**Файлы**:
- `static/js/player-stats.js` — renderAchievements()
- `static/css/player-stats-modal.css` — стили достижений

**Задачи**:
- [ ] Получить иконки достижений (URL с Lesta CDN или API)
- [ ] Отрисовать горизонтальную ленту иконок (как на tanki.su)
- [ ] Добавить счётчики на повторяемых достижениях
- [ ] Тултипы при наведении (название + описание)
- [ ] Скролл/карусель если не помещается

**Примечание**: Требует дополнительного API запроса для получения метаданных достижений (иконки, описания). Текущий API `/account/achievements/` возвращает только `{code: count}`.

---

### Этап 4: Бои на технике (гистограммы) ⬜
**Статус**: ⬜ Не начато

**Файлы**:
- `static/js/player-stats.js` — renderTierChart() (частично есть)
- `static/css/player-stats-modal.css` — стили гистограмм

**Задачи**:
- [ ] Переделать гистограмму по уровням в стиле tanki.su (diagram_bar)
- [ ] Добавить тултипы с деталями (бои, %, знаки, победы%)
- [ ] Добавить гистограмму по типам техники (ЛТ, СТ, ТТ, ПТ, САУ)
- [ ] Добавить гистограмму по нациям (с флагами)
- [ ] Общий layout секции

---

### Этап 5: Подробная статистика (4 карточки) ⬜
**Статус**: ⬜ Не начато

**Файлы**:
- `static/js/player-stats.js` — секция all-stats-grid (уже есть базово)
- `static/css/player-stats-modal.css` — стили all-stats

**Задачи**:
- [ ] Проверить стили 4-х карточек (Общие, Средние, Рекордные, Знаки)
- [ ] Убедиться в корректном grid-layout внутри модалки
- [ ] Проверить все данные корректны
- [ ] Иконки знаков классности (ico-ranks)

---

### Этап 6: Таблица техники ⬜
**Статус**: ⬜ Не начато

**Файлы**:
- `static/js/player-stats.js` — renderVehiclesTable() (уже есть базово)
- `static/css/player-stats-modal.css` — стили таблицы

**Задачи**:
- [ ] Добавить колонки: нация (с флагом), средний урон, средний опыт
- [ ] Добавить фильтры по нации/типу/уровню (как на tanki.su)
- [ ] Улучшить стили таблицы (ближе к tanki.su)
- [ ] Сортировка по всем колонкам
- [ ] "Показать всю технику" кнопка

---

### Этап 7: WN8 рейтинг (бонус) ⬜
**Статус**: ⬜ Не начато — опциональный этап

**Задачи**:
- [ ] Загрузить expected values с `https://static.modxvm.com/wn8-data-exp/json/lesta/wn8exp.json`
- [ ] Рассчитать WN8 на клиенте по формуле
- [ ] Отобразить WN8 с цветовой шкалой в шапке рядом с рейтингом
- [ ] Показать WN8 per-tank в таблице техники

---

## Порядок работы

1. **Этап 1** → Шапка (быстро, уже есть основа)
2. **Этап 2** → Статистика (уже есть, нужна полировка)
3. **Этап 5** → Подробная статистика (уже есть базово)
4. **Этап 4** → Гистограммы (частично есть, нужно доделать)
5. **Этап 6** → Таблица техники (уже есть базово)
6. **Этап 3** → Достижения (сложно — нужны иконки с CDN)
7. **Этап 7** → WN8 (опционально)

---

## Технические заметки

- **CSS**: Используем существующие стили из `tanki-su-profile.css` (SVG-иконки закодированы в base64)
- **JS**: Продолжаем рендерить через innerHTML в `player-stats.js` (не переносим на шаблоны Django — данные с API)
- **API**: Текущий API `/api/player/<id>/stats/` достаточен для этапов 1-2, 4-6. Для достижений (этап 3) может потребоваться доп. endpoint для метаданных
- **Справочник техники**: Уже загружается через `/api/vehicles/encyclopedia/` — используется для уровней, типов, наций
