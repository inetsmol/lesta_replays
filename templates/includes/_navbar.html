{# templates/includes/_navbar.html #}
{% load static %}

<header class="sticky top-0 z-50 backdrop-blur-md bg-[rgba(20,20,20,0.85)] border-b border-[var(--border)]">
  <div class="max-w-[1200px] mx-auto flex items-center justify-between py-3">

    <!-- Бренд -->
    <a class="flex items-center gap-2 font-extrabold tracking-[0.2px] no-underline" href="/">
      <img src="{% static 'style/images/wot/logo.png' %}" alt="Логотип" class="h-8 w-auto object-contain shrink-0">
      <span class="text-[18px] font-extrabold tracking-[0.2px]">РЕПЛЕИ</span>
    </a>

    <!-- Навигация -->
    <nav class="flex items-center space-x-[18px]">
    {% if user.is_authenticated %}
      <button id="upload-replay-btn"
              type="button"
              class="big-red-button inline-flex items-center justify-center gap-2 select-none">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
          <path d="M7.646 1.146a.5.5 0 0 1 .708 0L10.5 3.293V10a.5.5 0 0 1-1 0V4.414L8.354 5.56a.5.5 0 0 1-.708-.708L8.5 4.207V10a.5.5 0 0 1-1 0V3.707L6.354 4.854a.5.5 0 1 1-.708-.708l2-2z"/>
          <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
        </svg>
        <span>Загрузить</span>
      </button>
    {% else %}
      <button type="button"
              onclick="window.app.showAlert('Загружать реплеи могут только авторизованные пользователи. Пожалуйста, войдите в аккаунт или зрегистрируйтесь.', function() { window.location.href='{% url 'account_login' %}'; }, null);"
              class="big-red-button inline-flex items-center justify-center gap-2 select-none">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
          <path d="M7.646 1.146a.5.5 0 0 1 .708 0L10.5 3.293V10a.5.5 0 0 1-1 0V4.414L8.354 5.56a.5.5 0 0 1-.708-.708L8.5 4.207V10a.5.5 0 0 1-1 0V3.707L6.354 4.854a.5.5 0 1 1-.708-.708l2-2z"/>
          <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
        </svg>
        <span>Загрузить</span>
      </button>
    {% endif %}

    {% if user.is_authenticated %}
        <details class="relative ml-[18px]" data-user-menu>
          <summary class="list-none cursor-pointer inline-flex items-center gap-2 opacity-[0.85] hover:opacity-100 hover:text-[var(--accent-2)]">
            {{ user.username }}
            <!-- стрелка -->
            <svg class="h-4 w-4 opacity-60" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
            </svg>
          </summary>

        <!-- Выпадающее меню -->
        <div class="absolute right-0 mt-2 w-44 rounded-xl bg-white dark:bg-[#1a1a1a]
            text-gray-900 dark:text-gray-100 shadow-lg ring-1 ring-black/10 dark:ring-white/10 p-1 z-50">
          <a
{#              href="{% url 'profile' %}" #}
              class="block px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">
            Профиль
          </a>
          <a
              href="{% url 'my_replay_list' %}"
              class="block px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">
            Мои реплеи
          </a>
          <div class="my-1 h-px bg-gray-200 dark:bg-white/10"></div>
          <form method="post" action="{% url 'account_logout' %}">
            {% csrf_token %}
            <button type="submit" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">
              Выход
            </button>
          </form>
        </div>
      </details>
    {% else %}
      <a href="{% url 'account_login' %}" class="ml-[18px] opacity-[0.85] hover:opacity-100 hover:text-[var(--accent-2)]">
        Войти
      </a>
    {% endif %}


      <a href="{% url 'about' %}" class="ml-[18px] opacity-[0.85] hover:opacity-100 hover:text-[var(--accent-2)]">О проекте</a>
    </nav>
  </div>

<!-- DEV banner (compact, chat icon + Telegram CTA) -->
<div id="dev-banner"
     class="flex flex-col md:flex-row items-center justify-center gap-3 py-2 px-3 border-b border-black/10 text-[13px] bg-[#fff6d6] text-[#4a3b00] dark:bg-[#3b3420] dark:text-[#ffe9a6] dark:border-b-white/10"
     role="alert" aria-live="polite">
  <div class="flex items-center gap-3 pr-2">
    <!-- SVG chat icon -->
    <svg aria-hidden="true" focusable="false" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M20 2H4a2 2 0 00-2 2v14l4-4h14a2 2 0 002-2V4a2 2 0 00-2-2zM6 11.5V9h12v2.5H6z" fill="currentColor"/>
    </svg>

    <div>
      <strong>Портал в активной разработке.</strong>
      Возможны временные сбои. Если заметили ошибку или есть предложение 
    </div>
    <div class="flex items-center ml-0">
      <a href="https://t.me/lesta_replays" target="_blank" rel="noopener" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-md text-white bg-[#1d9bf0] hover:opacity-90 no-underline" aria-label="Написать в Telegram">
        <!-- Telegram paper-plane icon (inline SVG) -->
        <svg aria-hidden="true" focusable="false" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M22 2L2 13l4.5 1.6L9 13l10 7 3-20z" fill="currentColor"/>
        </svg>
        <span class="text-[13px] font-medium">Написать в Telegram</span>
      </a>
    </div>
  </div>

</div>
</header>

<script>
  (function () {
    const MENUS = () => Array.from(document.querySelectorAll('details[data-user-menu]'));
  
    function closeAll(except = null) {
      MENUS().forEach(d => { if (d !== except) d.removeAttribute('open'); });
    }
  
    // Закрыть по клику вне
    document.addEventListener('click', (e) => {
      const inMenu = e.target.closest('details[data-user-menu]');
      if (!inMenu) return closeAll();
      // если клик внутри — дадим браузеру сначала переключить <details>,
      // а потом закроем остальные
      setTimeout(() => closeAll(inMenu), 0);
    });
  
    // Закрыть по Esc
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeAll();
        const sum = document.querySelector('details[data-user-menu] > summary');
        if (sum) sum.focus();
      }
    });
  
    // Закрывать при переходе фокуса табом вне меню (улучшение доступности)
    document.addEventListener('focusin', (e) => {
      const inMenu = e.target.closest('details[data-user-menu]');
      if (!inMenu) closeAll();
    });
  })();
  </script>
  