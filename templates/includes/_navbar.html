{# templates/includes/_navbar.html #}
{% load static %}

<header class="sticky top-0 z-50 backdrop-blur-md bg-dark-800/85 border-b border-dark-600">
  <div class="max-w-[1200px] mx-auto flex items-center justify-between py-3 px-3 sm:px-5">

    <!-- Бренд -->
    <a class="flex items-center gap-1 sm:gap-2 font-extrabold tracking-[0.2px] no-underline" href="/">
      <img src="{% static 'style/images/wot/logo.png' %}" alt="Логотип" class="h-7 sm:h-8 w-auto object-contain shrink-0">
      <span class="text-base sm:text-[18px] font-extrabold tracking-[0.2px]">РЕПЛЕИ</span>
    </a>

    <!-- Навигация -->
    <nav class="flex items-center space-x-2 sm:space-x-[18px]">
      <button id="upload-replay-btn"
              type="button"
              class="big-red-button inline-flex items-center justify-center gap-1 sm:gap-2 select-none text-sm sm:text-base px-2 sm:px-4"
              data-authenticated="{{ user.is_authenticated|lower }}">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true" class="hidden sm:block">
          <path d="M7.646 1.146a.5.5 0 0 1 .708 0L10.5 3.293V10a.5.5 0 0 1-1 0V4.414L8.354 5.56a.5.5 0 0 1-.708-.708L8.5 4.207V10a.5.5 0 0 1-1 0V3.707L6.354 4.854a.5.5 0 1 1-.708-.708l2-2z"/>
          <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
        </svg>
        <span class="text-sm sm:text-base">Загрузить</span>
      </button>

    {% if user.is_authenticated %}
        <details class="relative" data-user-menu>
          <summary class="list-none cursor-pointer inline-flex items-center gap-1 sm:gap-2 opacity-85 hover:opacity-100 hover:text-accent-600 text-sm sm:text-base">
            {% if user_profile and user_profile.avatar %}
              <img id="navbar-avatar" src="{{ user_profile.avatar.url }}" alt=""
                   class="w-6 h-6 rounded-full object-cover border border-gray-500 shrink-0"
                   style="aspect-ratio: 1/1; min-width: 1.5rem;">
            {% endif %}
            <span class="hidden sm:inline">{{ user.username }}</span>
            <span class="sm:hidden">{{ user.username|truncatechars:10 }}</span>
            <!-- стрелка -->
            <svg class="h-4 w-4 opacity-60" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
            </svg>
          </summary>

        <!-- Выпадающее меню -->
        <div class="absolute right-0 mt-2 w-44 rounded-xl bg-white dark:bg-dark-700
            text-gray-900 dark:text-gray-100 shadow-lg ring-1 ring-black/10 dark:ring-white/10 p-1 z-50">
          <a
              href="{% url 'profile' %}"
              class="block px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">
            Профиль
          </a>
          <div class="my-1 h-px bg-gray-200 dark:bg-white/10"></div>
          <form method="post" action="{% url 'account_logout' %}">
            {% csrf_token %}
            <button type="submit" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">
              Выход
            </button>
          </form>
        </div>
      </details>
    {% else %}
      <a href="{% url 'account_login' %}" class="opacity-85 hover:opacity-100 hover:text-accent-600 text-sm sm:text-base">
        Войти
      </a>
    {% endif %}


      <a href="{% url 'about' %}" class="opacity-85 hover:opacity-100 hover:text-accent-600 text-sm sm:text-base hidden sm:inline">О проекте</a>
    </nav>
  </div>
</header>

<script>
  (function () {
    const MENUS = () => Array.from(document.querySelectorAll('details[data-user-menu]'));
  
    function closeAll(except = null) {
      MENUS().forEach(d => { if (d !== except) d.removeAttribute('open'); });
    }
  
    // Закрыть по клику вне
    document.addEventListener('click', (e) => {
      const inMenu = e.target.closest('details[data-user-menu]');
      if (!inMenu) return closeAll();
      // если клик внутри — дадим браузеру сначала переключить <details>,
      // а потом закроем остальные
      setTimeout(() => closeAll(inMenu), 0);
    });
  
    // Закрыть по Esc
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeAll();
        const sum = document.querySelector('details[data-user-menu] > summary');
        if (sum) sum.focus();
      }
    });
  
    // Закрывать при переходе фокуса табом вне меню (улучшение доступности)
    document.addEventListener('focusin', (e) => {
      const inMenu = e.target.closest('details[data-user-menu]');
      if (!inMenu) closeAll();
    });
  })();
  </script>
